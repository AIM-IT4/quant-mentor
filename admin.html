<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantMentor Admin</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Quill.js (Rich Text Editor) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // Load config.js if it exists, otherwise gracefully fallback
        (function () {
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onload = function () {
                console.log('✅ Configuration loaded successfully');
            };
            script.onerror = function () {
                console.log('ℹ️ Local configuration (config.js) not found or build-time injection failed. Using environment variables if available.');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // BREVO EMAIL CONFIGURATION (replaces EmailJS)
        const BREVO_API_KEY_BASE = 'xkeysib-your-api-key-here';
        const BREVO_SENDER_EMAIL_BASE = 'jha.8@alumni.iitj.ac.in';
        const BREVO_SENDER_NAME_BASE = 'QuantMentor';

        // Helper to get latest config
        function getBrevoConfig() {
            return {
                apiKey: (window.CONFIG && window.CONFIG.BREVO_API_KEY) || BREVO_API_KEY_BASE,
                senderEmail: (window.CONFIG && window.CONFIG.BREVO_SENDER_EMAIL) || BREVO_SENDER_EMAIL_BASE,
                senderName: (window.CONFIG && window.CONFIG.BREVO_SENDER_NAME) || BREVO_SENDER_NAME_BASE
            };
        }

        // Send email via Brevo API
        async function sendEmailWithBrevo(to, subject, htmlContent, textContent) {
            const config = getBrevoConfig();

            if (!config.apiKey || config.apiKey === 'xkeysib-your-api-key-here') {
                console.warn('⚠️ Brevo API key not configured. Email not sent.');
                return { success: false, error: 'API key not configured' };
            }

            try {
                const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'api-key': config.apiKey,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: {
                            email: config.senderEmail,
                            name: config.senderName
                        },
                        to: [{ email: to }],
                        subject: subject,
                        htmlContent: htmlContent,
                        textContent: textContent
                    })
                });

                if (response.ok) {
                    console.log('✅ Email sent successfully via Brevo to:', to);
                    return { success: true };
                } else {
                    const error = await response.json();
                    console.error('❌ Brevo error:', error);
                    return { success: false, error: error.message };
                }
            } catch (error) {
                console.error('❌ Failed to send email:', error);
                return { success: false, error: error.message };
            }
        }
    </script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #a855f7;
            --background: #0a0a0f;
            --surface: #13131f;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .stat-card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            opacity: 0.2;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .stat-card .trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            height: 350px;
            width: 100%;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .product-list {
            margin-top: 40px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
            text-align: center;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            display: block;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            display: block;
        }

        /* Reschedule Request Styles */
        .reschedule-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .reschedule-item:last-child {
            margin-bottom: 0;
        }

        .reschedule-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .reschedule-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .date-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .date-box.current {
            border-left: 3px solid #94a3b8;
        }

        .date-box.requested {
            border-left: 3px solid #a855f7;
        }

        .date-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .date-value {
            font-weight: 600;
            color: var(--text);
        }

        .reschedule-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reschedule-actions button {
            flex: 1;
            min-width: 120px;
        }

        .btn-approve {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
        }

        .btn-alternative {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        .btn-reject {
            background: transparent !important;
            border: 1px solid #ef4444 !important;
            color: #ef4444 !important;
        }

        /* Login Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="card" style="width: 300px; text-align: center;">
            <h2>Admin Access</h2>
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Enter Password">
            </div>
            <button id="loginBtn" onclick="checkPassword()">Login</button>
        </div>
    </div>

    <div class="container" id="adminContainer" style="display: none;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div>
                <h1>QuantMentor Admin</h1>
                <p style="color: var(--text-muted); margin: 0;">Business Performance Dashboard</p>
            </div>
            <a href="index.html" style="color: var(--primary); text-decoration: none;">View Site →</a>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" style="margin-bottom: 60px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-indian-rupee-sign icon"></i>
                    <span class="label">Total Revenue</span>
                    <span class="value" id="totalRevenue">₹0</span>
                    <span class="trend trend-up"><i class="fas fa-chart-line"></i> Lifetime</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-check icon"></i>
                    <span class="label">Total Bookings</span>
                    <span class="value" id="totalBookings">0</span>
                    <span class="trend trend-up"><i class="fas fa-users"></i> Lifetime</span>
                </div>
                <div class="stat-card">
                    <i class="fas fa-download icon"></i>
                    <span class="label">Product Sales</span>
                    <span class="value" id="totalSales">0</span>
                    <span class="trend trend-up"><i class="fas fa-shopping-cart"></i> Lifetime</span>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">Revenue & Sales Growth</span>
                        <select id="revenueRange" onchange="updateDashboardCharts()"
                            style="width: auto; padding: 4px 12px; font-size: 0.8rem; height: auto;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div style="position: relative; height: calc(100% - 40px);">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">Service Distribution</span>
                    </div>
                    <div style="position: relative; height: calc(100% - 40px);">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <div class="card">
            <h2 style="margin-top: 0;">Add/Edit Product</h2>

            <!-- Tip for Free Resources -->
            <div
                style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="margin: 0 0 5px 0; color: #22c55e; font-size: 1em;"><i class="fas fa-gift"></i> Pro Tip:
                    Managing Free Resources</h3>
                <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">
                    To add a <strong>Free Resource</strong> (like a cheat sheet or guide), simply fill out the product
                    form below and check the <strong>"Free"</strong> box next to the price. It will automatically appear
                    in the "Free Resources" section on the homepage.
                </p>
            </div>

            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="productName" required placeholder="e.g. Advanced C++ Guide">
                </div>

                <div class="form-group">
                    <label>Cover Image (Required)</label>
                    <input type="file" id="productCover" accept="image/*">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Upload a cover image for the product card (JPG, PNG, WEBP)
                    </small>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Sale Price (₹)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="productPrice" required placeholder="e.g. 699" style="flex:1">
                            <label
                                style="display:flex; align-items:center; gap:5px; font-weight:normal; font-size:0.9em; cursor:pointer; color:var(--text);">
                                <input type="checkbox" id="productFree" onchange="togglePriceInput(this)">
                                Free
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Original Price (₹) - for slash pricing</label>
                        <input type="number" id="productOriginalPrice" placeholder="e.g. 999">
                    </div>
                </div>

                <div class="form-group"
                    style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                    <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="productPPP" style="width: auto; margin-top: 4px;">
                        <div>
                            <strong style="color: white;">Enable Country-Based Pricing (PPP)</strong>
                            <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--text-muted);">
                                Automatically adjust price based on user's country purchasing power.
                                <br>(e.g. Lower price for developing countries)
                            </p>
                        </div>
                    </label>
                </div>

                <div class="form-group">
                    <label>Discount Percentage (%)</label>
                    <input type="number" id="productDiscount" min="0" max="100"
                        placeholder="e.g. 20 (leave 0 for no discount)">
                </div>

                <div class="form-group">
                    <label>Coupon Code (Optional)</label>
                    <input type="text" id="productCouponCode"
                        placeholder="e.g. WELCOME20 (users enter this for discount)">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Users can enter this code during purchase to get the discount
                    </small>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <div style="background: white; border-radius: 4px; overflow: hidden;">
                        <div id="productDescEditor" style="height: 250px; color: black;"></div>
                    </div>
                </div>

                <div class="form-group" id="fileUploadGroup">
                    <label>Upload Resource (PDF, ZIP, RAR, Code files)</label>
                    <input type="file" id="productFile" accept=".pdf,.zip,.rar,.py,.cpp,.h,.js,.ipynb,.txt,.md">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Accepted: PDF documents, ZIP archives, Python scripts (.py), C++ files (.cpp, .h),
                        Jupyter notebooks (.ipynb), JavaScript, Text files, Markdown
                    </small>
                </div>

                <button type="submit" id="productSubmitBtn">Upload & Save Product</button>
                <button type="button" id="cancelEditBtn" onclick="cancelProductEdit()"
                    style="display: none; margin-left: 10px; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);">Cancel</button>
            </form>
            <div id="uploadStatus" class="status"></div>
        </div>

        <div class="product-list">
            <h2>Active Products</h2>
            <div class="card" id="productsList">
                <p style="color: var(--text-muted); text-align: center;">Loading products...</p>
            </div>
        </div>

        <div class="session-management" style="margin-top: 60px;">
            <h2>Mentorship Sessions Management</h2>
            <div class="card">
                <h3 style="margin-top: 0;">Add/Edit Session</h3>
                <form id="sessionForm">
                    <input type="hidden" id="sessionId">
                    <div class="form-group">
                        <label>Session Name</label>
                        <input type="text" id="sessionName" required placeholder="e.g. Quick Consultation">
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="sessionDuration" required placeholder="30" min="15">
                        </div>
                        <div class="form-group">
                            <label>Price (₹)</label>
                            <input type="number" id="sessionPrice" required placeholder="499" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="sessionDesc" rows="2"
                            placeholder="Brief description of what the session covers..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Features (one per line)</label>
                        <textarea id="sessionFeatures" rows="4" placeholder="15-minute intro call
Discuss your goals
Brief Q&A"></textarea>
                    </div>
                    <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
                        <label>
                            <input type="checkbox" id="sessionPopular"> Mark as Popular
                        </label>
                        <label>
                            <input type="checkbox" id="sessionActive" checked> Active
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="sessionSubmitBtn">Save Session</button>
                        <button type="button" id="sessionResetBtn"
                            style="background: transparent; border: 1px solid var(--border);">Reset Form</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Current Sessions</h3>
                <div id="sessionsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading sessions...</p>
                </div>
            </div>
        </div>

        <div class="reschedule-management" style="margin-top: 60px;">
            <h2>Reschedule Requests</h2>
            <div class="card">
                <div class="card-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Pending Reschedule Requests</h3>
                    <button onclick="loadRescheduleRequests()" class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 0.9em;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="rescheduleRequestsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading requests...</p>
                </div>
            </div>
        </div>

        <!-- Cancellation Requests Section -->
        <div class="card" style="border-left: 3px solid #ef4444;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;"><i class="fas fa-times-circle"
                        style="color: #ef4444; margin-right: 8px;"></i>Cancellation Requests</h3>
                <button onclick="loadCancellationRequests()" class="btn btn-secondary"
                    style="padding: 8px 16px; font-size: 0.9em;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Review cancellation requests and process refunds.
            </p>
            <div id="cancellationRequestsList">
                <p style="color: var(--text-muted); text-align: center;">Loading cancellation requests...</p>
            </div>
        </div>

        <!-- Blog Management -->
        <div class="blog-management" style="margin-top: 60px;">
            <h2>Blog & Articles Management</h2>
            <div class="card">
                <h3 style="margin-top: 0;">Add/Edit Article</h3>
                <form id="blogForm">
                    <input type="hidden" id="blogId">

                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="blogTitle" required placeholder="Article Title">
                    </div>

                    <div class="form-group">
                        <label>Slug (URL Friendly)</label>
                        <input type="text" id="blogSlug" placeholder="auto-generated-from-title"
                            style="color:var(--text-muted)">
                    </div>

                    <div class="form-group">
                        <label>Excerpt (Short Summary)</label>
                        <textarea id="blogExcerpt" rows="2"
                            placeholder="Brief summary to display on cards..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <div style="background: white; border-radius: 4px; overflow: hidden;">
                            <div id="blogContentEditor" style="height: 300px; color: black;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Cover Image URL</label>
                        <input type="text" id="blogCover" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="blogPublished" checked>
                            Publish Immediately
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="blogSubmitBtn">Save Article</button>
                        <button type="button" id="blogCancelBtn" onclick="cancelBlogEdit()"
                            style="display:none; background:transparent; border:1px solid var(--text-muted);">Cancel
                            Edit</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Existing Articles</h3>
                <div id="blogsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading articles...</p>
                </div>
            </div>
        </div>

        <!-- Availability Manager Section -->
        <div class="card" id="availabilitySection" style="margin-top: 30px;">
            <div class="card-header" style="margin-bottom: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-clock" style="color: #6366f1;"></i> Manage Availability
                </h2>
                <button onclick="saveAvailability()" class="btn btn-primary" style="padding: 8px 16px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>

            <div style="overflow-x: auto;">
                <table class="admin-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Day</th>
                            <th style="text-align: center;">Active</th>
                            <th style="text-align: left;">Start Time (IST)</th>
                            <th style="text-align: left;">End Time (IST)</th>
                        </tr>
                    </thead>
                    <tbody id="availabilityTableBody">
                        <!-- Rows generated by JS -->
                        <tr>
                            <td colspan="4" style="text-align:center;">Loading schedule...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Testimonials Management Section -->
        <div class="card" id="testimonialsSection" style="margin-top: 30px; display: none;">
            <div class="card-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-star" style="color: #fbbf24;"></i> Review Approvals
                </h2>
                <button onclick="loadPendingTestimonials()" class="btn btn-secondary" style="padding: 8px 16px;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div id="pendingTestimonialsList">
                <p style="color: var(--text-muted); text-align: center;">Loading pending reviews...</p>
            </div>
        </div>

        <!-- Alternative Date Modal -->
        <div id="alternativeModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.95); z-index: 2000; justify-content: center; align-items: center;">
            <div class="card" style="width: 400px; max-width: 90%;">
                <h3 style="margin-top: 0;">Suggest Alternative Date</h3>
                <input type="hidden" id="altBookingId">
                <div class="form-group">
                    <label>Alternative Date</label>
                    <input type="date" id="altDate" required>
                </div>
                <div class="form-group">
                    <label>Alternative Time</label>
                    <select id="altTime" required>
                        <option value="">Select time slot</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="12:00 PM">12:00 PM</option>
                        <option value="2:00 PM">2:00 PM</option>
                        <option value="3:00 PM">3:00 PM</option>
                        <option value="4:00 PM">4:00 PM</option>
                        <option value="5:00 PM">5:00 PM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Message to Customer (Optional)</label>
                    <textarea id="altMessage" rows="2"
                        placeholder="Explain why you're suggesting this alternative..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="submitAlternative()" style="flex: 1;">Send Alternative</button>
                    <button onclick="closeAlternativeModal()"
                        style="flex: 1; background: transparent; border: 1px solid var(--border);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div id="cropperModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.95); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">
        <div class="card"
            style="width: 800px; max-width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <h3 style="margin-top: 0;">Crop Cover Image</h3>
            <div style="flex: 1; min-height: 300px; background: #000; overflow: hidden; position: relative;">
                <img id="cropperImage" style="max-width: 100%; display: block;" src="">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="cropImage()"
                    style="width: auto; background: linear-gradient(135deg, #22c55e, #16a34a);">Crop & Save</button>
                <button onclick="closeCropperModal()"
                    style="width: auto; background: transparent; border: 1px solid var(--border);">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables and functions
        let supabaseAdminClient = null;
        let cropper = null;
        let croppedCoverBlob = null;
        let quill = null;
        let blogQuill = null;

        function togglePriceInput(checkbox) {
            const input = document.getElementById('productPrice');
            if (checkbox.checked) {
                input.value = 0;
                input.disabled = true;
            } else {
                input.disabled = false;
            }
        }
        const SUPABASE_URL = 'https://dntabmyurlrlnoajdnja.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRudGFibXl1cmxybG5vYWpkbmphIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDEwMTI2NSwiZXhwIjoyMDg1Njc3MjY1fQ.C87qk8sAOx9NI0p7sV5ndb8n_lktUA9EmjNMFjYItAg';

        // Check Password Function (globally accessible)
        // Check Password Function (globally accessible)
        function checkPassword() {
            try {
                console.log('Login button clicked');
                const pwd = document.getElementById('adminPassword').value;
                if (pwd === 'admin123') {
                    console.log('Password correct, logging in...');
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';

                    // Force redraw and scroll to top
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);

                    // Execute load functions safely
                    try { if (typeof loadProducts === 'function') loadProducts(); } catch (e) { console.error('Products load error', e); }
                    try { if (typeof loadSessions === 'function') loadSessions(); } catch (e) { console.error('Sessions load error', e); }
                    try { if (typeof loadRescheduleRequests === 'function') loadRescheduleRequests(); } catch (e) { console.error('Reschedule load error', e); }
                    try { if (typeof loadCancellationRequests === 'function') loadCancellationRequests(); } catch (e) { console.error('Cancellation load error', e); }
                    try { if (typeof loadBlogs === 'function') loadBlogs(); } catch (e) { console.error('Blogs load error', e); }
                    try { if (typeof loadPendingTestimonials === 'function') loadPendingTestimonials(); } catch (e) { console.error('Testimonials load error', e); }
                    try { if (typeof loadAvailability === 'function') loadAvailability(); } catch (e) { console.error('Availability load error', e); }
                    try { if (typeof initDashboard === 'function') initDashboard(); } catch (e) { console.error('Dashboard init error', e); }
                } else {
                    alert('Incorrect password');
                }
            } catch (err) {
                alert('Login Critical Error: ' + err.message);
                console.error(err);
            }
        }

        // Global functions for Cropper
        function closeCropperModal() {
            const modal = document.getElementById('cropperModal');
            modal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            // If validated blob doesn't exist (cancelled), clear input
            if (!croppedCoverBlob) {
                document.getElementById('productCover').value = '';
            }
        }

        function cropImage() {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas(); // Free size based on crop

            canvas.toBlob((blob) => {
                croppedCoverBlob = blob;
                console.log('✅ Cropped blob created', blob);

                // Visual feedback
                const label = document.querySelector('label[for="productCover"]');
                if (label) {
                    label.innerHTML = 'Cover Image <span style="color:#22c55e">(Cropped & Ready)</span>';
                }

                // Close modal manually without clearing input (since we have the blob)
                const modal = document.getElementById('cropperModal');
                modal.style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }, 'image/jpeg', 0.9);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('Admin page DOM loaded');

            // Initialize Quill
            try {
                quill = new Quill('#productDescEditor', {
                    theme: 'snow',
                    placeholder: 'Detailed product description...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            [{ 'script': 'sub' }, { 'script': 'super' }],
                            [{ 'indent': '-1' }, { 'indent': '+1' }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'align': [] }],
                            ['clean']
                        ]
                    }
                });
            } catch (e) { console.error('Quill init error:', e); }

            // Cropper Event Listener
            const productCoverInput = document.getElementById('productCover');
            const cropperImage = document.getElementById('cropperImage');
            const cropperModal = document.getElementById('cropperModal');

            if (productCoverInput) {
                productCoverInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Reset previous blob
                        croppedCoverBlob = null;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                            cropperImage.src = e.target.result;
                            cropperModal.style.display = 'flex';

                            // Initialize Cropper
                            if (cropper) cropper.destroy();
                            cropper = new Cropper(cropperImage, {
                                aspectRatio: NaN, // Free aspect ratio
                                viewMode: 1,
                                autoCropArea: 1,
                            });
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            // ... (keep existing login listeners)
            const loginBtn = document.getElementById('loginBtn');
            const passwordInput = document.getElementById('adminPassword');
            // ... (rest of listeners)

            if (loginBtn) {
                loginBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    checkPassword();
                });
            }

            if (passwordInput) {
                passwordInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') checkPassword();
                });
            }

            // Initialize Supabase
            try {
                // ... (keep existing)
                if (typeof window.supabase !== 'undefined') {
                    if (!window.supabaseAdminClient) {
                        window.supabaseAdminClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    }
                }
            } catch (e) { console.error(e); }

            console.log('✅ Brevo email configuration loaded from global scope');

            // Handle Form Submission
            document.getElementById('productForm').addEventListener('submit', async (e) => {
                console.log('Product Form Submit Triggered');
                e.preventDefault();
                const btn = document.getElementById('productSubmitBtn');
                const status = document.getElementById('uploadStatus');

                btn.disabled = true;
                btn.textContent = 'Uploading...';
                status.className = 'status';

                try {
                    console.log('Admin Panel Version: Service Key Active');
                    console.log('Key Prefix:', SUPABASE_KEY ? SUPABASE_KEY.substring(0, 15) : 'None');

                    const productId = document.getElementById('productId').value.trim();
                    const name = document.getElementById('productName').value;
                    const price = document.getElementById('productPrice').value;
                    const originalPrice = document.getElementById('productOriginalPrice').value || 0;
                    const enablePPP = document.getElementById('productPPP').checked;
                    const discount = document.getElementById('productDiscount').value || 0;
                    const couponCode = document.getElementById('productCouponCode').value || null;
                    let desc = quill ? quill.root.innerHTML : '';
                    if (desc === '<p><br></p>') desc = '';
                    console.log('Update Payload:', { name, price, desc, id: productId }); // Debug Log
                    const file = document.getElementById('productFile').files[0];
                    const coverFileInput = document.getElementById('productCover').files[0];
                    const coverFileToUpload = croppedCoverBlob || coverFileInput;

                    // For new products, file is required; for edits, file is optional
                    if (!productId && !file) throw new Error('Please select a resource file');

                    let fileUrl = null;
                    let coverUrl = null;

                    // 1. Upload Resource File (if selected)
                    if (file) {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_res_${Date.now()}.${fileExt}`;

                        const { data: uploadData, error: uploadError } = await window.supabaseAdminClient.storage
                            .from('resources')
                            .upload(fileName, file);

                        if (uploadError) throw uploadError;

                        const { data: publicUrlData } = window.supabaseAdminClient.storage
                            .from('resources')
                            .getPublicUrl(fileName);

                        fileUrl = publicUrlData.publicUrl;
                    }

                    // 2. Upload Cover Image (if selected or cropped)
                    if (coverFileToUpload) {
                        // Blob might not have name, so default to jpg if missing
                        const fileExt = coverFileToUpload.name ? coverFileToUpload.name.split('.').pop() : 'jpg';
                        const fileName = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_cover_${Date.now()}.${fileExt}`;

                        const { data: uploadData, error: uploadError } = await window.supabaseAdminClient.storage
                            .from('product-covers')
                            .upload(fileName, coverFileToUpload);

                        if (uploadError) throw uploadError;

                        const { data: publicUrlData } = window.supabaseAdminClient.storage
                            .from('product-covers')
                            .getPublicUrl(fileName);

                        coverUrl = publicUrlData.publicUrl;
                    }

                    // 3. Save or Update Metadata in Database
                    const productData = {
                        name: name,
                        price: parseFloat(price),
                        original_price: parseFloat(originalPrice),
                        enable_ppp: enablePPP,
                        discount_percentage: parseInt(discount) || 0,
                        coupon_code: couponCode,
                        description: desc
                    };

                    // Only update URLs if new files were uploaded
                    if (fileUrl) productData.file_url = fileUrl;
                    if (coverUrl) productData.cover_image_url = coverUrl;

                    let dbError;
                    if (productId) {
                        // Update existing product
                        const result = await window.supabaseAdminClient
                            .from('products')
                            .update(productData)
                            .eq('id', productId)
                            .select();

                        if (!result.error && result.data && result.data.length === 0) {
                            throw new Error('Update failed: ID matched no rows. Refresh and try again.');
                        }
                        dbError = result.error;
                    } else {
                        // Insert new product
                        const result = await window.supabaseAdminClient
                            .from('products')
                            .insert([productData]);
                        dbError = result.error;
                    }

                    if (dbError) throw dbError;

                    // Success
                    status.textContent = productId ? '✅ Product updated successfully!' : '✅ Product added successfully!';
                    status.classList.add('success');
                    document.getElementById('productForm').reset();
                    if (quill) quill.setText('');

                    // Reset Cropper State
                    croppedCoverBlob = null;
                    const cLabel = document.querySelector('label[for="productCover"]');
                    if (cLabel) cLabel.innerHTML = 'Cover Image (Required)';

                    document.getElementById('productId').value = '';
                    document.getElementById('productSubmitBtn').textContent = 'Upload & Save Product';
                    document.getElementById('cancelEditBtn').style.display = 'none';
                    document.getElementById('fileUploadGroup').style.display = 'block';
                    loadProducts();

                } catch (error) {
                    console.error('Error:', error);
                    alert('Error: ' + error.message); // Expose error to user
                    status.textContent = '❌ Error: ' + error.message;
                    status.classList.add('error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Upload & Save Product';
                }
            });

            // Load Products - defined outside DOMContentLoaded
            async function loadProducts() {
                const list = document.getElementById('productsList');

                if (!window.supabaseAdminClient) {
                    list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                    return;
                }

                const { data, error } = await window.supabaseAdminClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    list.innerHTML = `<p style="color: red">Error loading products: ${error.message}</p>`;
                    return;
                }

                if (data.length === 0) {
                    list.innerHTML = '<p class="text-muted">No products found.</p>';
                    return;
                }

                list.innerHTML = data.map(p => {
                    const price = p.price;
                    const originalPrice = p.original_price || 0;
                    const discountPercent = p.discount_percentage || 0;
                    const discountedPrice = discountPercent > 0 ? Math.round(price * (1 - discountPercent / 100)) : price;
                    const hasPPP = p.enable_ppp ? '<span style="background: rgba(99, 102, 241, 0.2); color: #6366f1; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">PPP Enabled</span>' : '';
                    const coverImg = p.cover_image_url ?
                        `<img src="${p.cover_image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px;" alt="Cover">` :
                        `<div style="width: 50px; height: 50px; background: var(--border); border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: var(--text-muted);"></i></div>`;

                    return `
                <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center;">
                        ${coverImg}
                        <div>
                            <strong>${p.name}</strong> ${p.price === 0 ? '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">FREE RESOURCE</span>' : ''} ${hasPPP}<br>
                            <span style="color: var(--text-muted); font-size: 0.9em;">
                                ${originalPrice > price ?
                            `<span style="text-decoration: line-through; color: #ef4444; margin-right: 5px;">₹${originalPrice}</span>` : ''}
                                ${discountPercent > 0 ?
                            `<span style="text-decoration: line-through; color: #ef4444;">₹${price}</span> 
                                     <span style="color: #22c55e; font-weight: bold;">₹${discountedPrice}</span>
                                     <span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">${discountPercent}% OFF</span>` :
                            `₹${price}`}
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <a href="${p.file_url}" target="_blank" style="color: var(--primary); text-decoration: none; padding: 8px 16px; border: 1px solid var(--primary); border-radius: 6px;">Download</a>
                        <button onclick="editProduct('${p.id}')" style="padding: 8px 16px; font-size: 0.9em;">Edit</button>
                        <button onclick="deleteProduct('${p.id}')" style="padding: 8px 16px; font-size: 0.9em; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Delete</button>
                    </div>
                </div>
            `}).join('');
            }

            // Edit Product
            async function editProduct(id) {
                const { data, error } = await window.supabaseAdminClient
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) {
                    alert('❌ Error loading product: ' + error.message);
                    return;
                }

                document.getElementById('productId').value = data.id;
                document.getElementById('productName').value = data.name;
                document.getElementById('productPrice').value = data.price;
                document.getElementById('productOriginalPrice').value = data.original_price || '';
                document.getElementById('productPPP').checked = data.enable_ppp || false;
                document.getElementById('productDiscount').value = data.discount_percentage || 0;
                document.getElementById('productCouponCode').value = data.coupon_code || '';

                // Handle Free Resource Checkbox
                const freeCheck = document.getElementById('productFree');
                if (freeCheck) {
                    freeCheck.checked = (data.price === 0);
                    togglePriceInput(freeCheck);
                }

                if (quill) quill.root.innerHTML = data.description || '';
                document.getElementById('productSubmitBtn').textContent = 'Update Product';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';

                // Show file input for edit mode so user can optionally update the file
                document.getElementById('fileUploadGroup').style.display = 'block';

                // Scroll to form
                document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });

                // Reset any existing cropped blob
                croppedCoverBlob = null;
                const label = document.querySelector('label[for="productCover"]');
                if (label) label.innerHTML = 'Cover Image (Required)';
                document.getElementById('productCover').value = '';
            }

            // Cancel Product Edit
            function cancelProductEdit() {
                document.getElementById('productId').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productOriginalPrice').value = '';
                document.getElementById('productPPP').checked = false;
                document.getElementById('productDiscount').value = '';
                document.getElementById('productCouponCode').value = '';

                const freeCheck = document.getElementById('productFree');
                if (freeCheck) {
                    freeCheck.checked = false;
                    togglePriceInput(freeCheck);
                }

                if (quill) quill.setText('');
                document.getElementById('productSubmitBtn').textContent = 'Upload & Save Product';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('fileUploadGroup').style.display = 'block';
                document.getElementById('fileUploadGroup').querySelector('input').required = false;

                // Reset cropped blob
                croppedCoverBlob = null;
                const label = document.querySelector('label[for="productCover"]');
                if (label) label.innerHTML = 'Cover Image (Required)';
                document.getElementById('productCover').value = '';
            }

            // Delete Product
            async function deleteProduct(id) {
                console.log('🗑️ Attempting to delete product:', id);
                if (!confirm('⚠️ Are you sure you want to delete this product?')) return;

                try {
                    const { data, error } = await window.supabaseAdminClient
                        .from('products')
                        .delete()
                        .eq('id', id)
                        .select();

                    console.log('🗑️ Delete result:', { data, error });

                    if (error) throw error;

                    alert('✅ Product deleted successfully!');
                    await loadProducts();
                } catch (error) {
                    console.error('❌ Delete error:', error);
                    alert('❌ Error deleting product: ' + error.message);
                }
            }



            // Handle Session Form Submission
            document.getElementById('sessionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('sessionSubmitBtn');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Saving...';

                try {
                    const sessionId = document.getElementById('sessionId').value;
                    const name = document.getElementById('sessionName').value;
                    const duration = parseInt(document.getElementById('sessionDuration').value);
                    const price = parseInt(document.getElementById('sessionPrice').value);
                    const description = document.getElementById('sessionDesc').value;
                    const featuresText = document.getElementById('sessionFeatures').value;
                    const features = featuresText.split('\n').filter(f => f.trim() !== '');
                    const isPopular = document.getElementById('sessionPopular').checked;
                    const isActive = document.getElementById('sessionActive').checked;

                    const sessionData = {
                        name,
                        duration,
                        price,
                        description,
                        features,
                        is_popular: isPopular,
                        is_active: isActive
                    };

                    if (sessionId) {
                        // Update existing session
                        const { error } = await window.supabaseAdminClient
                            .from('sessions')
                            .update(sessionData)
                            .eq('id', sessionId);
                        if (error) throw error;
                        alert('✅ Session updated successfully!');
                    } else {
                        // Create new session
                        const { error } = await window.supabaseAdminClient
                            .from('sessions')
                            .insert([sessionData]);
                        if (error) throw error;
                        alert('✅ New session created successfully!');
                    }

                    document.getElementById('sessionForm').reset();
                    document.getElementById('sessionId').value = '';
                    await loadSessions();
                } catch (error) {
                    console.error('Error saving session:', error);
                    alert('❌ Error: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });

            // Reset Session Form
            document.getElementById('sessionResetBtn').addEventListener('click', () => {
                document.getElementById('sessionForm').reset();
                document.getElementById('sessionId').value = '';
                document.getElementById('sessionSubmitBtn').textContent = 'Save Session';
            });

            // Global functions for session management
            window.checkPassword = checkPassword;
            window.loadProducts = loadProducts;
            window.editProduct = editProduct;
            window.deleteProduct = deleteProduct;
            window.cancelProductEdit = cancelProductEdit;
            window.editSession = editSession;
            window.deleteSession = deleteSession;

            // Reschedule Request Functions
            window.loadRescheduleRequests = loadRescheduleRequests;
            window.approveReschedule = approveReschedule;
            window.showAlternativeModal = showAlternativeModal;
            window.closeAlternativeModal = closeAlternativeModal;
            window.submitAlternative = submitAlternative;
            window.rejectReschedule = rejectReschedule;
        }); // End of DOMContentLoaded

        // Reschedule Request Functions
        async function loadRescheduleRequests() {
            const list = document.getElementById('rescheduleRequestsList');

            if (!window.supabaseAdminClient) {
                list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                return;
            }

            try {
                const { data, error } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('*')
                    .eq('status', 'reschedule_requested')
                    .order('created_at', { ascending: false });

                if (error) {
                    list.innerHTML = `<p style="color: red">Error loading requests: ${error.message}</p>`;
                    return;
                }

                if (!data || data.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No pending reschedule requests.</p>';
                    return;
                }

                list.innerHTML = data.map(booking => `
                    <div class="reschedule-item">
                        <div class="reschedule-header">
                            <div>
                                <strong>${booking.service_name || booking.service || 'Session'}</strong><br>
                                <span style="color: var(--text-muted); font-size: 0.9em;">
                                    Booking ID: ${booking.id}<br>
                                    Customer: ${booking.email}
                                </span>
                            </div>
                            <span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                Pending
                            </span>
                        </div>
                        
                        <div class="reschedule-details">
                            <div class="date-box current">
                                <div class="date-label">Current Schedule</div>
                                <div class="date-value">${formatDate(booking.booking_date || booking.date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.booking_time || booking.time}</div>
                            </div>
                            <div class="date-box requested">
                                <div class="date-label">Requested Schedule</div>
                                <div class="date-value">${formatDate(booking.requested_date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.requested_time}</div>
                            </div>
                        </div>

                        ${(function () {
                        const link = booking.meet_link || 'https://meet.google.com/hfp-npyq-qho';
                        return `<div style="background: rgba(34, 197, 94, 0.1); padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #22c55e;"><i class="fas fa-video"></i> <strong>Meet Link:</strong> <a href="${link}" target="_blank" style="color: inherit; text-decoration: underline;">${link}</a></div>`;
                    })()}
                        
                        ${booking.reschedule_reason ? `<p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;"><strong>Reason:</strong> ${booking.reschedule_reason}</p>` : ''}
                        
                        <div class="reschedule-actions">
                            <button onclick="approveReschedule('${booking.id}', '${booking.email}')" class="btn-approve" style="padding: 10px 20px; font-size: 0.9em;">
                                ✓ Approve
                            </button>
                            <button onclick="showAlternativeModal('${booking.id}', '${booking.email}')" class="btn-alternative" style="padding: 10px 20px; font-size: 0.9em;">
                                ✎ Suggest Alternative
                            </button>
                            <button onclick="rejectReschedule('${booking.id}', '${booking.email}')" class="btn-reject" style="padding: 10px 20px; font-size: 0.9em;">
                                ✕ Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading reschedule requests:', error);
                list.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
            }
        }

        // Approve Reschedule Request
        async function approveReschedule(bookingId, email) {
            if (!confirm('✓ Approve this reschedule request?\n\nThe booking will be updated with the requested date/time.')) {
                return;
            }

            try {
                // Get the current booking to retrieve requested dates
                const { data: booking, error: fetchError } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('*')
                    .eq('id', bookingId)
                    .single();

                if (fetchError) throw fetchError;

                // Check if reschedule was requested
                if (!booking.requested_date || !booking.requested_time) {
                    alert('❌ Error: No reschedule request found for this booking.');
                    return;
                }

                // Update the booking
                const { error: updateError } = await window.supabaseAdminClient
                    .from('bookings')
                    .update({
                        booking_date: booking.requested_date,
                        booking_time: booking.requested_time,
                        status: 'upcoming',
                        requested_date: null,
                        requested_time: null,
                        reschedule_reason: null
                    })
                    .eq('id', bookingId);

                if (updateError) throw updateError;

                // Notify user via Brevo
                const meetLink = booking.meet_link || 'https://meet.google.com/hfp-npyq-qho';
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #10b981;">✅ Reschedule Request Approved</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your reschedule request has been approved!</p>
                        <h3 style="color: #2563eb;">New Schedule:</h3>
                        <p><strong>📅 Date:</strong> ${booking.requested_date}</p>
                        <p><strong>⏰ Time:</strong> ${booking.requested_time}</p>
                        <p><strong>🔗 Meet Link:</strong> <a href="${meetLink}">${meetLink}</a></p>
                        <p>Your session is now confirmed for the new date/time.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                const textContent = `
✅ RESCHEDULE REQUEST APPROVED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your reschedule request has been approved!

New Schedule:
• Date: ${booking.requested_date}
• Time: ${booking.requested_time}

Meet Link: ${meetLink}

Your session is now confirmed for the new date/time.
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                await sendEmailWithBrevo(email, `Reschedule Approved - Booking ${bookingId}`, htmlContent, textContent);

                alert('✅ Reschedule request approved!\n\nUser has been notified.');
                await loadRescheduleRequests();
            } catch (error) {
                console.error('Error approving reschedule:', error);
                alert('❌ Error approving request: ' + error.message);
            }
        }

        // Show Alternative Date Modal
        function showAlternativeModal(bookingId, email) {
            document.getElementById('altBookingId').value = bookingId;
            document.getElementById('altDate').value = '';
            document.getElementById('altTime').value = '';
            document.getElementById('altMessage').value = '';
            document.getElementById('alternativeModal').style.display = 'flex';
        }

        // Close Alternative Modal
        function closeAlternativeModal() {
            document.getElementById('alternativeModal').style.display = 'none';
        }

        // Submit Alternative Date
        async function submitAlternative() {
            const bookingId = document.getElementById('altBookingId').value;
            const altDate = document.getElementById('altDate').value;
            const altTime = document.getElementById('altTime').value;
            const message = document.getElementById('altMessage').value;

            if (!altDate || !altTime) {
                alert('Please select both date and time');
                return;
            }

            try {
                // Get current booking for email
                const { data: booking, error: fetchError } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('*')
                    .eq('id', bookingId)
                    .single();

                if (fetchError) throw fetchError;

                // Update booking with alternative date
                const { error: updateError } = await window.supabaseAdminClient
                    .from('bookings')
                    .update({
                        booking_date: altDate,
                        booking_time: altTime,
                        status: 'upcoming',
                        requested_date: null,
                        requested_time: null,
                        reschedule_reason: null
                    })
                    .eq('id', bookingId);

                if (updateError) throw updateError;

                // Notify user via Brevo
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #f59e0b;">📅 Alternative Date Offered</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>We couldn't accommodate your requested date, but we're offering an alternative:</p>
                        <h3 style="color: #2563eb;">Alternative Schedule:</h3>
                        <p><strong>📅 Date:</strong> ${altDate}</p>
                        <p><strong>⏰ Time:</strong> ${altTime}</p>
                        ${message ? `<p><strong>Message from Admin:</strong></p><p style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${message}</p>` : ''}
                        <p>Your session has been automatically updated to this new date/time.</p>
                        <p>If this doesn't work for you, please contact us to reschedule.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                const textContent = `
📅 ALTERNATIVE DATE OFFERED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

We couldn't accommodate your requested date, but we're offering an alternative:

Alternative Schedule:
• Date: ${altDate}
• Time: ${altTime}

${message ? 'Message from Admin:\n' + message + '\n\n' : ''}
Your session has been automatically updated to this new date/time.

If this doesn't work for you, please contact us to reschedule.
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                await sendEmailWithBrevo(booking.email, `Alternative Date Offered - Booking ${bookingId}`, htmlContent, textContent);

                alert('✅ Alternative date sent to user!');
                closeAlternativeModal();
                await loadRescheduleRequests();
            } catch (error) {
                console.error('Error submitting alternative:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Reject Reschedule Request
        async function rejectReschedule(bookingId, email) {
            const reason = prompt('Please provide a reason for rejection (optional):');
            if (reason === null) return; // User cancelled

            if (!confirm('✕ Reject this reschedule request?\n\nThe booking will remain at the original date/time.')) {
                return;
            }

            try {
                // Clear reschedule request fields and keep original schedule
                const { error: updateError } = await window.supabaseAdminClient
                    .from('bookings')
                    .update({
                        status: 'upcoming',
                        requested_date: null,
                        requested_time: null,
                        reschedule_reason: null
                    })
                    .eq('id', bookingId);

                if (updateError) throw updateError;

                // Notify user via Brevo
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #ef4444;">❌ Reschedule Request Rejected</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your reschedule request could not be accommodated.</p>
                        <p>Your booking remains scheduled for the original date/time.</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                        <p>Please contact us if you need further assistance.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                const textContent = `
❌ RESCHEDULE REQUEST REJECTED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your reschedule request could not be accommodated.

Your booking remains scheduled for the original date/time.
${reason ? `\nReason: ${reason}` : ''}

Please contact us if you need further assistance.
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                await sendEmailWithBrevo(email, `Reschedule Request Rejected - Booking ${bookingId}`, htmlContent, textContent);

                alert('✅ Reschedule request rejected.\n\nUser has been notified.');
                await loadRescheduleRequests();
            } catch (error) {
                console.error('Error rejecting reschedule:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // =============================================
        // CANCELLATION REQUEST MANAGEMENT
        // =============================================

        // Load Cancellation Requests
        async function loadCancellationRequests() {
            const list = document.getElementById('cancellationRequestsList');
            console.log('📋 Loading cancellation requests...');

            if (!window.supabaseAdminClient) {
                list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                console.error('❌ Supabase not initialized');
                return;
            }

            try {
                const { data, error } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('*')
                    .eq('status', 'cancellation_requested')
                    .order('created_at', { ascending: false });

                console.log('📋 Cancellation requests result:', { data, error });

                if (error) {
                    list.innerHTML = `<p style="color: red">Error loading requests: ${error.message}</p>`;
                    console.error('❌ Error:', error);
                    return;
                }

                if (!data || data.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No pending cancellation requests.</p>';
                    console.log('📋 No cancellation requests found');
                    return;
                }

                list.innerHTML = data.map(booking => `
                    <div class="reschedule-item" style="border-left: 3px solid #ef4444;">
                        <div class="reschedule-header">
                            <div>
                                <strong>${booking.service_name || booking.service || 'Session'}</strong><br>
                                <span style="color: var(--text-muted); font-size: 0.9em;">
                                    Booking ID: ${booking.id}<br>
                                    Customer: ${booking.name} (${booking.email})
                                </span>
                            </div>
                            <span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                Cancellation Pending
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div class="date-box" style="border-left: 3px solid #94a3b8;">
                                <div class="date-label">Booked Session</div>
                                <div class="date-value">${formatDate(booking.booking_date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.booking_time}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em; margin-top: 5px;">Price: ₹${booking.service_price}</div>
                            </div>
                            <div class="date-box" style="border-left: 3px solid #22c55e;">
                                <div class="date-label">Refund Details</div>
                                <div class="date-value" style="color: #22c55e;">₹${booking.refund_amount || 0}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.refund_percentage || 0}% of original</div>
                                <div style="color: var(--text-muted); font-size: 0.9em; margin-top: 5px;">Payment ID: ${booking.payment_id || 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${booking.cancellation_reason ? `<p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;"><strong>Reason:</strong> ${booking.cancellation_reason}</p>` : ''}
                        
                        <div class="reschedule-actions">
                            <button onclick="approveRefund('${booking.id}', '${booking.email}', ${booking.refund_amount || 0}, '${booking.payment_id || ''}')" class="btn-approve" style="padding: 10px 20px; font-size: 0.9em;">
                                💰 Approve Refund (₹${booking.refund_amount || 0})
                            </button>
                            <button onclick="rejectCancellation('${booking.id}', '${booking.email}')" class="btn-reject" style="padding: 10px 20px; font-size: 0.9em;">
                                ✕ Reject
                            </button>
                        </div>
                        
                        <p style="color: var(--text-muted); font-size: 0.8em; margin-top: 10px; margin-bottom: 0;">
                            <i class="fas fa-info-circle"></i> After approving, process refund in Razorpay Dashboard using Payment ID: <strong>${booking.payment_id || 'N/A'}</strong>
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading cancellation requests:', error);
                list.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
            }
        }

        // Approve Refund and mark as processed
        async function approveRefund(bookingId, email, refundAmount, paymentId) {
            const confirmMessage = `💰 Approve Refund?

Refund Amount: ₹${refundAmount}
Payment ID: ${paymentId || 'N/A'}

After clicking OK:
1. The booking will be marked as cancelled
2. User will receive email confirmation
3. You must manually process the refund in Razorpay Dashboard

Proceed?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Update booking status to cancelled and refund as processed
                const { error: updateError } = await window.supabaseAdminClient
                    .from('bookings')
                    .update({
                        status: 'cancelled',
                        refund_status: 'processed'
                    })
                    .eq('id', bookingId);

                if (updateError) throw updateError;

                // Send refund confirmation email to user via Brevo
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #10b981;">💰 Refund Processed</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your cancellation request has been approved and your refund is being processed.</p>
                        <h3 style="color: #2563eb;">Refund Details:</h3>
                        <p><strong>💵 Refund Amount:</strong> ₹${refundAmount}</p>
                        <p><strong>⏰ Processing Time:</strong> 5-7 business days</p>
                        <p>The refund will be credited to your original payment method.</p>
                        <p>Thank you for using QuantMentor. We hope to serve you again!</p>
                        <p>If you have any questions, please contact us at <a href="mailto:jha.8@alumni.iitj.ac.in">jha.8@alumni.iitj.ac.in</a></p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                const textContent = `
💰 REFUND PROCESSED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your cancellation request has been approved and your refund is being processed.

REFUND DETAILS:
• Refund Amount: ₹${refundAmount}
• Processing Time: 5-7 business days

The refund will be credited to your original payment method.

Thank you for using QuantMentor. We hope to serve you again!

If you have any questions, please contact us at jha.8@alumni.iitj.ac.in
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                await sendEmailWithBrevo(email, `Refund Processed - Booking ${bookingId}`, htmlContent, textContent);

                alert(`✅ Refund Approved!

📧 User has been notified.

⚠️ NEXT STEP: Process refund in Razorpay Dashboard
Payment ID: ${paymentId || 'N/A'}
Amount: ₹${refundAmount}

Go to: Razorpay Dashboard → Transactions → Search Payment ID → Issue Refund`);

                await loadCancellationRequests();
            } catch (error) {
                console.error('Error approving refund:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Reject Cancellation Request
        async function rejectCancellation(bookingId, email) {
            // ... (keep existing)
            const reason = prompt('Please provide a reason for rejection:');
            if (reason === null) return; // User clicked Cancel

            if (!confirm('✕ Reject this cancellation request?\n\nThe booking will remain active.')) {
                return;
            }

            try {
                // Revert booking to confirmed status
                const { error: updateError } = await window.supabaseAdminClient
                    .from('bookings')
                    .update({
                        status: 'confirmed',
                        refund_status: 'rejected',
                        cancellation_reason: null
                    })
                    .eq('id', bookingId);

                if (updateError) throw updateError;

                // Notify user via Brevo
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #ef4444;">❌ Cancellation Request Rejected</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your cancellation request could not be processed.</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                        <p>Your booking remains active. Please attend the session as scheduled.</p>
                        <p>If you have any questions, please contact us at <a href="mailto:jha.8@alumni.iitj.ac.in">jha.8@alumni.iitj.ac.in</a></p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                const textContent = `
❌ CANCELLATION REQUEST REJECTED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your cancellation request could not be processed.

${reason ? `Reason: ${reason}` : ''}

Your booking remains active. Please attend the session as scheduled.

If you have any questions, please contact us at jha.8@alumni.iitj.ac.in
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                await sendEmailWithBrevo(email, `Cancellation Request Rejected - Booking ${bookingId}`, htmlContent, textContent);

                alert('✅ Cancellation request rejected.\n\nUser has been notified. Booking remains active.');
                await loadCancellationRequests();
            } catch (error) {
                console.error('Error rejecting cancellation:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('adminPassword').value = '';
                // Optional: refresh page to clear any in-memory state
                window.location.reload();
            }
        }

        // Export cancellation functions to window
        window.loadCancellationRequests = loadCancellationRequests;
        window.approveRefund = approveRefund;
        window.rejectCancellation = rejectCancellation;

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // --- DASHBOARD LOGIC ---
        let revenueChart = null;
        let distributionChart = null;

        async function initDashboard() {
            console.log('📊 Initializing Dashboard...');
            document.getElementById('adminContainer').style.display = 'block'; // Ensure container is visible
            await updateDashboardStats();
            await updateDashboardCharts();
        }

        async function updateDashboardStats() {
            try {
                // 1. Fetch Bookings Stats (Confirmed + Completed)
                const { data: bookingsData } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('service_price, status')
                    .in('status', ['confirmed', 'completed', 'upcoming']);

                // 2. Fetch Purchases Stats
                const { data: purchasesData } = await window.supabaseAdminClient
                    .from('purchases')
                    .select('amount');

                const totalBookingsRevenue = (bookingsData || []).reduce((sum, b) => sum + (b.service_price || 0), 0);
                const totalPurchasesRevenue = (purchasesData || []).reduce((sum, p) => sum + (p.amount || 0), 0);

                console.log('💰 Revenue Debug:', {
                    bookingsCount: bookingsData?.length,
                    purchasesCount: purchasesData?.length,
                    totalBookingsRevenue,
                    totalPurchasesRevenue,
                    firstPurchase: purchasesData?.[0],
                    allPurchases: purchasesData
                });

                // Round to avoid fractional paise display issues
                const totalRevenue = Math.round(totalBookingsRevenue + totalPurchasesRevenue);
                document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
                document.getElementById('totalBookings').textContent = (bookingsData || []).length;
                document.getElementById('totalSales').textContent = (purchasesData || []).length;
            } catch (err) {
                console.error('❌ Failed to load stats:', err);
            }
        }

        async function updateDashboardCharts() {
            const range = parseInt(document.getElementById('revenueRange').value);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - range);

            try {
                // Fetch daily data for the range
                const { data: bookings } = await window.supabaseAdminClient
                    .from('bookings')
                    .select('service_price, booking_date, service_name')
                    .gte('created_at', cutoffDate.toISOString());

                const { data: purchases } = await window.supabaseAdminClient
                    .from('purchases')
                    .select('amount, created_at, product_name')
                    .gte('created_at', cutoffDate.toISOString());

                // Prepare data for Line Chart (Revenue over time)
                const dailyData = {};
                for (let i = 0; i <= range; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dailyData[d.toISOString().split('T')[0]] = 0;
                }

                (bookings || []).forEach(b => {
                    const date = b.booking_date; // bookings use booking_date
                    if (dailyData[date] !== undefined) dailyData[date] += (b.service_price || 0);
                });

                (purchases || []).forEach(p => {
                    const date = p.created_at.split('T')[0];
                    if (dailyData[date] !== undefined) dailyData[date] += (p.amount || 0);
                });

                const labels = Object.keys(dailyData).sort();
                const values = labels.map(l => Math.round(dailyData[l])); // Round chart values

                // Destroy old chart if exists
                if (revenueChart) revenueChart.destroy();

                const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
                revenueChart = new Chart(ctxRevenue, {
                    type: 'line',
                    data: {
                        labels: labels.map(l => l.split('-').slice(1).reverse().join('/')), // MM/DD -> DD/MM
                        datasets: [{
                            label: 'Daily Revenue (₹)',
                            data: values,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                // Distribution Chart (Pie)
                const distribution = {};
                (bookings || []).forEach(b => {
                    const name = b.service_name || 'Mentorship';
                    distribution[name] = (distribution[name] || 0) + 1;
                });
                (purchases || []).forEach(p => {
                    const name = p.product_name || 'Resources';
                    distribution[name] = (distribution[name] || 0) + 1;
                });

                if (distributionChart) distributionChart.destroy();
                const ctxDist = document.getElementById('distributionChart').getContext('2d');
                distributionChart = new Chart(ctxDist, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(distribution),
                        datasets: [{
                            data: Object.values(distribution),
                            backgroundColor: [
                                '#6366f1', '#a855f7', '#ec4899', '#f43f5e', '#ef4444', '#f59e0b'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12 } }
                        }
                    }
                });

            } catch (err) {
                console.error('❌ Failed to update charts:', err);
            }
        }
        window.updateDashboardCharts = updateDashboardCharts;
        // --- BLOG MANAGEMENT LOGIC ---
        async function loadBlogs() {
            const list = document.getElementById('blogsList');
            if (!window.supabaseAdminClient) {
                list.innerHTML = '<p style="color:red">Supabase Admin Client missing</p>';
                return;
            }
            try {
                const { data, error } = await window.supabaseAdminClient
                    .from('blogs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                if (!data || data.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--text-muted)">No articles found.</p>';
                    return;
                }
                list.innerHTML = data.map(b => `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1em; color:white;">${b.title}</strong>
                            <div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">
                                ${b.is_published ? '<span style="color:#22c55e">● Published</span>' : '<span style="color:#f59e0b">● Draft</span>'}
                                <span style="margin-left:10px;">/${b.slug}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="editBlog('${b.id}')" style="padding:6px 12px; font-size:0.9em;">Edit</button>
                            <button onclick="deleteBlog('${b.id}')" style="padding:6px 12px; font-size:0.9em; background:transparent; border:1px solid #ef4444; color:#ef4444;">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { list.innerHTML = `<p style="color:red">Error: ${e.message}</p>`; }
        }

        async function saveBlog(e) {
            e.preventDefault();
            const id = document.getElementById('blogId').value;
            const title = document.getElementById('blogTitle').value;
            // Auto slug
            let slug = document.getElementById('blogSlug').value;
            if (!slug) slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Date.now();

            const excerpt = document.getElementById('blogExcerpt').value;
            const content = blogQuill ? blogQuill.root.innerHTML : '';
            const cover = document.getElementById('blogCover').value;
            const published = document.getElementById('blogPublished').checked;

            const payload = { title, slug, excerpt, content, cover_image_url: cover, is_published: published };

            try {
                let error;
                if (id) {
                    const res = await window.supabaseAdminClient.from('blogs').update(payload).eq('id', id);
                    error = res.error;
                } else {
                    const res = await window.supabaseAdminClient.from('blogs').insert([payload]);
                    error = res.error;
                }
                if (error) throw error;
                alert('Article saved successfully!');
                cancelBlogEdit();
                loadBlogs();
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function editBlog(id) {
            try {
                const { data, error } = await window.supabaseAdminClient.from('blogs').select('*').eq('id', id).single();
                if (error) throw error;

                document.getElementById('blogId').value = data.id;
                document.getElementById('blogTitle').value = data.title;
                document.getElementById('blogSlug').value = data.slug;
                document.getElementById('blogExcerpt').value = data.excerpt || '';
                document.getElementById('blogCover').value = data.cover_image_url || '';
                document.getElementById('blogPublished').checked = data.is_published;
                if (blogQuill) blogQuill.root.innerHTML = data.content || '';

                document.getElementById('blogSubmitBtn').textContent = 'Update Article';
                document.getElementById('blogCancelBtn').style.display = 'inline-block';
                document.getElementById('blogForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function deleteBlog(id) {
            if (!confirm('Are you sure you want to delete this article?')) return;
            const { error } = await window.supabaseAdminClient.from('blogs').delete().eq('id', id);
            if (error) alert('Error: ' + error.message);
            else loadBlogs();
        }

        function cancelBlogEdit() {
            document.getElementById('blogForm').reset();
            document.getElementById('blogId').value = '';
            if (blogQuill) blogQuill.setText('');
            document.getElementById('blogSubmitBtn').textContent = 'Save Article';
            document.getElementById('blogCancelBtn').style.display = 'none';
        }

        // Export to Window
        window.loadBlogs = loadBlogs;
        window.editBlog = editBlog;
        window.deleteBlog = deleteBlog;
        window.cancelBlogEdit = cancelBlogEdit;

        // Export Session Functions
        // Session Management Functions - GLOBAL SCOPE
        async function loadSessions() {
            const list = document.getElementById('sessionsList');

            if (!window.supabaseAdminClient) {
                if (list) list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                return;
            }

            const { data, error } = await window.supabaseAdminClient
                .from('sessions')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                if (list) list.innerHTML = `<p style="color: red">Error loading sessions: ${error.message}</p>`;
                return;
            }

            if (!data || data.length === 0) {
                if (list) list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No sessions found.</p>';
                return;
            }

            if (list) {
                list.innerHTML = data.map(session => `
                    <div class="session-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); ${!session.is_active ? 'opacity: 0.6;' : ''}">
                        <div>
                            <strong>${session.name}</strong>
                            ${session.is_popular ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">POPULAR</span>' : ''}
                            ${!session.is_active ? '<span style="background: #666; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">INACTIVE</span>' : ''}
                            <br>
                            <span style="color: var(--text-muted);">
                                ${session.duration} min • ₹${session.price}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSession('${session.id}')" style="padding: 8px 16px; font-size: 0.9em; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                            <button onclick="deleteSession('${session.id}')" style="padding: 8px 16px; font-size: 0.9em; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Edit Session
        async function editSession(id) {
            const { data, error } = await window.supabaseAdminClient
                .from('sessions')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert('❌ Error loading session: ' + error.message);
                return;
            }

            document.getElementById('sessionId').value = data.id;
            document.getElementById('sessionName').value = data.name;
            document.getElementById('sessionDuration').value = data.duration;
            document.getElementById('sessionPrice').value = data.price;
            document.getElementById('sessionDesc').value = data.description || '';
            document.getElementById('sessionFeatures').value = data.features ? data.features.join('\n') : '';
            document.getElementById('sessionPopular').checked = data.is_popular;
            document.getElementById('sessionActive').checked = data.is_active;
            document.getElementById('sessionSubmitBtn').textContent = 'Update Session';

            // Scroll to form
            document.getElementById('sessionForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete Session
        async function deleteSession(id) {
            if (!confirm('⚠️ Are you sure you want to delete this session?')) return;

            try {
                const { error } = await window.supabaseAdminClient
                    .from('sessions')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('✅ Session deleted successfully!');
                await loadSessions();
            } catch (error) {
                alert('❌ Error deleting session: ' + error.message);
            }
        }

        // Init Blog Components
        const blogEditorEl = document.getElementById('blogContentEditor');
        if (blogEditorEl) {
            try {
                blogQuill = new Quill('#blogContentEditor', {
                    theme: 'snow',
                    placeholder: 'Write your article...',
                    modules: { toolbar: [['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'], [{ 'header': 1 }, { 'header': 2 }], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link', 'image'], ['clean']] }
                });
            } catch (e) { console.error('Blog Quill Init Error', e); }
        }

        const blogF = document.getElementById('blogForm');
        if (blogF) blogF.addEventListener('submit', saveBlog);

        // --- TESTIMONIALS MANAGEMENT ---
        async function loadPendingTestimonials() {
            const container = document.getElementById('pendingTestimonialsList');
            const section = document.getElementById('testimonialsSection');

            if (!window.supabaseAdminClient) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Supabase not connected</p>';
                section.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await window.supabaseAdminClient
                    .from('testimonials')
                    .select('*')
                    .eq('is_published', false)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                section.style.display = 'block';

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); text-align: center; padding: 30px;"><i class="fas fa-check-circle"></i> No pending reviews. All caught up!</p>';
                    return;
                }

                container.innerHTML = '<div style="display: grid; gap: 20px;">';

                data.forEach(t => {
                    const date = new Date(t.created_at).toLocaleString();
                    container.innerHTML += `
                        <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="font-size: 1.1rem;">${escapeHtml(t.name)}</strong>
                                    <span style="color: var(--text-muted); margin-left: 10px;">${'★'.repeat(t.rating)}</span>
                                </div>
                                <span style="font-size: 0.85rem; color: var(--text-muted);">${date}</span>
                            </div>
                            <h4 style="margin: 0 0 10px 0; color: var(--accent);">${escapeHtml(t.title)}</h4>
                            <p style="margin: 0 0 15px 0; color: var(--text-secondary); line-height: 1.6;">"${escapeHtml(t.review)}"</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="approveTestimonial(${t.id})" class="btn btn-primary" style="padding: 8px 20px; font-size: 0.9rem;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button onclick="rejectTestimonial(${t.id})" class="btn" style="padding: 8px 20px; font-size: 0.9rem; background: transparent; border: 1px solid var(--danger); color: var(--danger);">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML += '</div>';

            } catch (e) {
                console.error('Error loading testimonials:', e);
                container.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading reviews: ' + e.message + '</p>';
            }
        }

        async function approveTestimonial(id) {
            if (!confirm('Approve this review? It will be visible on the website.')) return;

            try {
                const { error } = await window.supabaseAdminClient
                    .from('testimonials')
                    .update({ is_published: true, is_verified: true })
                    .eq('id', id);

                if (error) throw error;

                alert('Review approved successfully!');
                loadPendingTestimonials();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function rejectTestimonial(id) {
            if (!confirm('Reject and delete this review?')) return;

            try {
                const { error } = await window.supabaseAdminClient
                    .from('testimonials')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Review rejected and deleted.');
                loadPendingTestimonials();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Export testimonial functions
        window.loadPendingTestimonials = loadPendingTestimonials;
        window.approveTestimonial = approveTestimonial;
        window.rejectTestimonial = rejectTestimonial;



    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantMentor Admin</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Quill.js (Rich Text Editor) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // Load config.js if it exists, otherwise gracefully fallback
        (function () {
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onload = function () {
                console.log('✅ Configuration loaded successfully');
            };
            script.onerror = function () {
                console.log('ℹ️ Local configuration (config.js) not found or build-time injection failed. Using environment variables if available.');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // BREVO EMAIL CONFIGURATION (replaces EmailJS)
        const BREVO_API_KEY_BASE = 'xkeysib-your-api-key-here';
        const BREVO_SENDER_EMAIL_BASE = 'jha.8@alumni.iitj.ac.in';
        const BREVO_SENDER_NAME_BASE = 'QuantMentor';

        // Helper to get latest config
        function getBrevoConfig() {
            return {
                apiKey: (window.CONFIG && window.CONFIG.BREVO_API_KEY) || BREVO_API_KEY_BASE,
                senderEmail: (window.CONFIG && window.CONFIG.BREVO_SENDER_EMAIL) || BREVO_SENDER_EMAIL_BASE,
                senderName: (window.CONFIG && window.CONFIG.BREVO_SENDER_NAME) || BREVO_SENDER_NAME_BASE
            };
        }

        // Send email via Brevo API
        async function sendEmailWithBrevo(to, subject, htmlContent, textContent) {
            const config = getBrevoConfig();

            if (!config.apiKey || config.apiKey === 'xkeysib-your-api-key-here') {
                console.warn('⚠️ Brevo API key not configured. Email not sent.');
                return { success: false, error: 'API key not configured' };
            }

            try {
                const response = await fetch('https://api.brevo.com/v3/smtp/email', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'api-key': config.apiKey,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: {
                            email: config.senderEmail,
                            name: config.senderName
                        },
                        to: [{ email: to }],
                        subject: subject,
                        htmlContent: htmlContent,
                        textContent: textContent
                    })
                });

                if (response.ok) {
                    console.log('✅ Email sent successfully via Brevo to:', to);
                    return { success: true };
                } else {
                    const error = await response.json();
                    console.error('❌ Brevo error:', error);
                    return { success: false, error: error.message };
                }
            } catch (error) {
                console.error('❌ Failed to send email:', error);
                return { success: false, error: error.message };
            }
        }
    </script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #a855f7;
            --background: #0a0a0f;
            --surface: #13131f;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .stat-card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            opacity: 0.2;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .stat-card .trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            height: 350px;
            width: 100%;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .product-list {
            margin-top: 40px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
            text-align: center;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            display: block;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            display: block;
        }

        /* Reschedule Request Styles */
        .reschedule-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .reschedule-item:last-child {
            margin-bottom: 0;
        }

        .reschedule-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .reschedule-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .date-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .date-box.current {
            border-left: 3px solid #94a3b8;
        }

        .date-box.requested {
            border-left: 3px solid #a855f7;
        }

        .date-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .date-value {
            font-weight: 600;
            color: var(--text);
        }

        .reschedule-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reschedule-actions button {
            flex: 1;
            min-width: 120px;
        }

        .btn-approve {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
        }

        .btn-alternative {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        .btn-reject {
            background: transparent !important;
            border: 1px solid #ef4444 !important;
            color: #ef4444 !important;
        }

        /* Login Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="card" style="width: 300px; text-align: center;">
            <h2>Admin Access</h2>
            <div class="form-group">
                <input type="password" id="adminPassword" placeholder="Enter Password">
            </div>
            <button id="loginBtn" onclick="checkPassword()">Login</button>
        </div>
    </div>

    <div class="container" id="adminContainer" style="display: none;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div>
                <h1>QuantMentor Admin</h1>
                <p style="color: var(--text-muted); margin: 0;">Business Performance Dashboard</p>
            </div>
            <a href="index.html" style="color: var(--primary); text-decoration: none;">View Site →</a>
        </header>

        <!-- DASHBOARD SECTION -->
        <section id="dashboardSection" class="content-section active" style="margin-bottom: 60px;">
            <div class="section-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chart-line" style="color: #6366f1;"></i> Performance Overview
                </h2>
                <div class="date-filter">
                    <select id="revenueRange" onchange="updateDashboardCharts()"
                        style="background: var(--surface); border: 1px solid var(--border); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="dashboard-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Revenue Card -->
                <div class="stat-card"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <p style="color: var(--text-muted); font-size: 0.9em; margin: 0;">Total Revenue</p>
                            <h3 id="totalRevenue" style="font-size: 1.8em; margin: 5px 0; color: white;">₹0</h3>
                        </div>
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 8px;">
                            <i class="fas fa-rupee-sign" style="color: #6366f1; font-size: 1.2em;"></i>
                        </div>
                    </div>
                    <div id="revenueGrowth" style="font-size: 0.85em;">
                        <span style="color: var(--text-muted);">Loading trends...</span>
                    </div>
                </div>

                <!-- Bookings Card -->
                <div class="stat-card"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <p style="color: var(--text-muted); font-size: 0.9em; margin: 0;">Active Bookings</p>
                            <h3 id="activeBookings" style="font-size: 1.8em; margin: 5px 0; color: white;">0</h3>
                        </div>
                        <div style="background: rgba(168, 85, 247, 0.1); padding: 10px; border-radius: 8px;">
                            <i class="fas fa-calendar-check" style="color: #a855f7; font-size: 1.2em;"></i>
                        </div>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-muted);">
                        <span id="completedBookingsCount">0</span> completed sessions
                    </div>
                </div>

                <!-- Sales Volume Card -->
                <div class="stat-card"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <p style="color: var(--text-muted); font-size: 0.9em; margin: 0;">Resource Sales</p>
                            <h3 id="totalSales" style="font-size: 1.8em; margin: 5px 0; color: white;">0</h3>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 8px;">
                            <i class="fas fa-download" style="color: #22c55e; font-size: 1.2em;"></i>
                        </div>
                    </div>
                    <div id="salesGrowth" style="font-size: 0.85em;">
                        <span style="color: var(--text-muted);">Lifetime sales</span>
                    </div>
                </div>

                <!-- AOV Card -->
                <div class="stat-card"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <p style="color: var(--text-muted); font-size: 0.9em; margin: 0;">Avg. Order Value</p>
                            <h3 id="avgOrderValue" style="font-size: 1.8em; margin: 5px 0; color: white;">₹0</h3>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 8px;">
                            <i class="fas fa-chart-pie" style="color: #f59e0b; font-size: 1.2em;"></i>
                        </div>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-muted);">
                        Based on bookings & sales
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-container"
                style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div class="chart-wrapper"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 350px;">
                    <h4 style="margin: 0 0 20px 0; color: var(--text-secondary);">Revenue Trends</h4>
                    <div style="position: relative; height: calc(100% - 40px);">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper"
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 350px;">
                    <h4 style="margin: 0 0 20px 0; color: var(--text-secondary);">Sales Distribution</h4>
                    <div style="position: relative; height: calc(100% - 40px);">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights Row -->
            <div class="insights-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Top Products -->
                <div
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                    <h4
                        style="margin: 0 0 20px 0; color: var(--text-secondary); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy" style="color: #f59e0b;"></i> Top Performing Products
                    </h4>
                    <div class="table-container" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr
                                    style="border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 0.85em; text-align: left;">
                                    <th style="padding: 10px;">Product</th>
                                    <th style="padding: 10px; text-align: center;">Sales</th>
                                    <th style="padding: 10px; text-align: right;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsList">
                                <tr>
                                    <td colspan="3"
                                        style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div
                    style="background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                    <h4
                        style="margin: 0 0 20px 0; color: var(--text-secondary); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-history" style="color: #6366f1;"></i> Recent Activity
                    </h4>
                    <div id="recentActivityFeed"
                        style="display: flex; flex-direction: column; gap: 15px; max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading activity...
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Client Management & Exports Section -->
        <section id="clientSection" class="content-section" style="margin-bottom: 60px;">
            <div class="card">
                <div class="card-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-users" style="color: #10b981;"></i> Client Management
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadBookings()" class="btn btn-secondary"
                            style="padding: 8px 16px; font-size: 0.9em;">
                            <i class="fas fa-file-csv"></i> Export Bookings
                        </button>
                        <button onclick="downloadPurchases()" class="btn btn-secondary"
                            style="padding: 8px 16px; font-size: 0.9em;">
                            <i class="fas fa-file-csv"></i> Export Purchases
                        </button>
                        <button onclick="downloadClients()" class="btn btn-primary"
                            style="padding: 8px 16px; font-size: 0.9em; background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-file-download"></i> Export Client List
                        </button>
                    </div>
                </div>

                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Aggregated list of all unique clients from Bookings and Purchases.
                </p>

                <div class="table-container" style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table class="admin-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr
                                style="border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface);">
                                <th style="text-align: left; padding: 12px; color: var(--text-muted);">Client</th>
                                <th style="text-align: center; padding: 12px; color: var(--text-muted);">Type</th>
                                <th style="text-align: center; padding: 12px; color: var(--text-muted);">Orders</th>
                                <th style="text-align: right; padding: 12px; color: var(--text-muted);">Total Spend</th>
                                <th style="text-align: center; padding: 12px; color: var(--text-muted);">Last Active
                                </th>
                            </tr>
                        </thead>
                        <tbody id="clientListBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Loading clients...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div class="card">
            <h2 style="margin-top: 0;">Add/Edit Product</h2>

            <!-- Tip for Free Resources -->
            <div
                style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="margin: 0 0 5px 0; color: #22c55e; font-size: 1em;"><i class="fas fa-gift"></i> Pro Tip:
                    Managing Free Resources</h3>
                <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">
                    To add a <strong>Free Resource</strong> (like a cheat sheet or guide), simply fill out the product
                    form below and check the <strong>"Free"</strong> box next to the price. It will automatically appear
                    in the "Free Resources" section on the homepage.
                </p>
            </div>

            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="productName" required placeholder="e.g. Advanced C++ Guide">
                </div>

                <div class="form-group">
                    <label>Cover Image (Required)</label>
                    <input type="file" id="productCover" accept="image/*">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Upload a cover image for the product card (JPG, PNG, WEBP)
                    </small>
                </div>

                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Sale Price (₹)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="productPrice" required placeholder="e.g. 699" style="flex:1">
                            <label
                                style="display:flex; align-items:center; gap:5px; font-weight:normal; font-size:0.9em; cursor:pointer; color:var(--text);">
                                <input type="checkbox" id="productFree" onchange="togglePriceInput(this)">
                                Free
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Original Price (₹) - for slash pricing</label>
                        <input type="number" id="productOriginalPrice" placeholder="e.g. 999">
                    </div>
                </div>

                <div class="form-group"
                    style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                    <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="productPPP" style="width: auto; margin-top: 4px;">
                        <div>
                            <strong style="color: white;">Enable Country-Based Pricing (PPP)</strong>
                            <p style="margin: 4px 0 0; font-size: 0.85em; color: var(--text-muted);">
                                Automatically adjust price based on user's country purchasing power.
                                <br>(e.g. Lower price for developing countries)
                            </p>
                        </div>
                    </label>
                </div>

                <div class="form-group">
                    <label>Discount Percentage (%)</label>
                    <input type="number" id="productDiscount" min="0" max="100"
                        placeholder="e.g. 20 (leave 0 for no discount)">
                </div>

                <div class="form-group">
                    <label>Coupon Code (Optional)</label>
                    <input type="text" id="productCouponCode"
                        placeholder="e.g. WELCOME20 (users enter this for discount)">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Users can enter this code during purchase to get the discount
                    </small>
                </div>

                <!-- Product Rating & Sales (Displayed on Product Page) -->
                <div class="form-row"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="form-group">
                        <label><i class="fas fa-star" style="color: #fbbf24;"></i> Average Rating (1-5)</label>
                        <input type="number" id="productRating" min="1" max="5" step="0.1" value="5" placeholder="5">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            Displayed on product page badges
                        </small>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bolt" style="color: #fbbf24;"></i> Sales Count</label>
                        <input type="number" id="productSalesCount" min="0" value="0" placeholder="0">
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            Number of sales to display
                        </small>
                    </div>
                </div>

                <!-- Product Reviews Selection -->
                <div class="form-group"
                    style="margin-top: 20px; background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                    <label><i class="fas fa-comments" style="color: #a855f7;"></i> Select Reviews for Product
                        Page</label>
                    <p style="font-size: 0.85em; color: var(--text-muted); margin: 5px 0 15px;">
                        Check the reviews you want to display in the carousel on this product's page.
                    </p>
                    <div id="productReviewsCheckboxes"
                        style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 10px;">
                        <p style="color: var(--text-muted); text-align: center; font-size: 0.9em;">Loading reviews...
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <div style="background: white; border-radius: 4px; overflow: hidden;">
                        <div id="productDescEditor" style="height: 250px; color: black;"></div>
                    </div>
                </div>

                <div class="form-group" id="fileUploadGroup">
                    <label>Upload Resource (PDF, ZIP, RAR, Code files)</label>
                    <input type="file" id="productFile" accept=".pdf,.zip,.rar,.py,.cpp,.h,.js,.ipynb,.txt,.md">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Accepted: PDF documents, ZIP archives, Python scripts (.py), C++ files (.cpp, .h),
                        Accepted: PDF documents, ZIP archives, Python scripts (.py), C++ files (.cpp, .h),
                        Jupyter notebooks (.ipynb), JavaScript, Text files, Markdown
                    </small>
                </div>

                <div class="form-group"
                    style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                    <label style="color: #a5b4fc; font-weight: 600;"><i class="fas fa-link"></i> OR Use External File
                        Link (Recommended for Large Files)</label>
                    <input type="url" id="productExternalUrl" placeholder="e.g. https://drive.google.com/file/d/...">
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Paste a direct download link from Google Drive, Dropbox, GitHub, etc. This saves Supabase
                        storage bandwidth.
                        <br><strong>Note:</strong> If provided, this link takes precedence over uploaded files.
                    </small>
                </div>

                <button type="submit" id="productSubmitBtn">Upload & Save Product</button>
                <button type="button" id="cancelEditBtn" onclick="cancelProductEdit()"
                    style="display: none; margin-left: 10px; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);">Cancel</button>
            </form>
            <div id="uploadStatus" class="status"></div>
        </div>

        <div class="product-list">
            <h2>Active Products</h2>
            <div class="card" id="productsList">
                <p style="color: var(--text-muted); text-align: center;">Loading products...</p>
            </div>
        </div>

        <div class="session-management" style="margin-top: 60px;">
            <h2>Mentorship Sessions Management</h2>
            <div class="card">
                <h3 style="margin-top: 0;">Add/Edit Session</h3>
                <form id="sessionForm">
                    <input type="hidden" id="sessionId">
                    <div class="form-group">
                        <label>Session Name</label>
                        <input type="text" id="sessionName" required placeholder="e.g. Quick Consultation">
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="sessionDuration" required placeholder="30" min="15">
                        </div>
                        <div class="form-group">
                            <label>Price (₹)</label>
                            <input type="number" id="sessionPrice" required placeholder="499" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="sessionDesc" rows="2"
                            placeholder="Brief description of what the session covers..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Features (one per line)</label>
                        <textarea id="sessionFeatures" rows="4" placeholder="15-minute intro call
Discuss your goals
Brief Q&A"></textarea>
                    </div>
                    <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
                        <label>
                            <input type="checkbox" id="sessionPopular"> Mark as Popular
                        </label>
                        <label>
                            <input type="checkbox" id="sessionActive" checked> Active
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="sessionSubmitBtn">Save Session</button>
                        <button type="button" id="sessionResetBtn"
                            style="background: transparent; border: 1px solid var(--border);">Reset Form</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Current Sessions</h3>
                <div id="sessionsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading sessions...</p>
                </div>
            </div>
        </div>

        <!-- All Bookings Management -->
        <div class="bookings-management" style="margin-top: 60px;">
            <h2>All Bookings</h2>
            <div class="card">
                <div class="card-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div class="filter-tabs" style="display: flex; gap: 10px;">
                        <button onclick="loadBookings('all')" class="btn btn-sm active" id="btn-filter-all"
                            style="background: var(--surface); border: 1px solid var(--border); padding: 6px 12px; font-size: 0.9em; cursor:pointer;">All</button>
                        <button onclick="loadBookings('upcoming')" class="btn btn-sm" id="btn-filter-upcoming"
                            style="background: transparent; border: 1px solid var(--border); padding: 6px 12px; font-size: 0.9em; cursor:pointer;">Upcoming</button>
                        <button onclick="loadBookings('completed')" class="btn btn-sm" id="btn-filter-completed"
                            style="background: transparent; border: 1px solid var(--border); padding: 6px 12px; font-size: 0.9em; cursor:pointer;">Completed</button>
                        <button onclick="loadBookings('cancelled')" class="btn btn-sm" id="btn-filter-cancelled"
                            style="background: transparent; border: 1px solid var(--border); padding: 6px 12px; font-size: 0.9em; cursor:pointer;">Cancelled</button>
                    </div>
                    <button onclick="loadBookings(currentBookingFilter)" class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 0.9em;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="table-container" style="overflow-x: auto;">
                    <table class="admin-table" style="width: 100%; border-collapse: collapse; min-width: 600px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-muted); font-weight: 500;">
                                    Date & Time</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-muted); font-weight: 500;">
                                    Customer</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-muted); font-weight: 500;">
                                    Service</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-muted); font-weight: 500;">
                                    Status</th>
                                <th
                                    style="text-align: right; padding: 12px; color: var(--text-muted); font-weight: 500;">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allBookingsList">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Loading bookings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="reschedule-management" style="margin-top: 60px;">
            <h2>Reschedule Requests</h2>
            <div class="card">
                <div class="card-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Pending Reschedule Requests</h3>
                    <button onclick="loadRescheduleRequests()" class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 0.9em;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="rescheduleRequestsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading requests...</p>
                </div>
            </div>
        </div>

        <!-- Cancellation Requests Section -->
        <div class="card" style="border-left: 3px solid #ef4444;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;"><i class="fas fa-times-circle"
                        style="color: #ef4444; margin-right: 8px;"></i>Cancellation Requests</h3>
                <button onclick="loadCancellationRequests()" class="btn btn-secondary"
                    style="padding: 8px 16px; font-size: 0.9em;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Review cancellation requests and process refunds.
            </p>
            <div id="cancellationRequestsList">
                <p style="color: var(--text-muted); text-align: center;">Loading cancellation requests...</p>
            </div>
        </div>

        <!-- Blog Management -->
        <div class="blog-management" style="margin-top: 60px;">
            <h2>Blog & Articles Management</h2>
            <div class="card">
                <h3 style="margin-top: 0;">Add/Edit Article</h3>
                <form id="blogForm">
                    <input type="hidden" id="blogId">

                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="blogTitle" required placeholder="Article Title">
                    </div>

                    <div class="form-group">
                        <label>Slug (URL Friendly)</label>
                        <input type="text" id="blogSlug" placeholder="auto-generated-from-title"
                            style="color:var(--text-muted)">
                    </div>

                    <div class="form-group">
                        <label>Excerpt (Short Summary)</label>
                        <textarea id="blogExcerpt" rows="2"
                            placeholder="Brief summary to display on cards..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <div style="background: white; border-radius: 4px; overflow: hidden;">
                            <div id="blogContentEditor" style="height: 300px; color: black;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Cover Image URL</label>
                        <input type="text" id="blogCover" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="blogPublished" checked>
                            Publish Immediately
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="blogSubmitBtn">Save Article</button>
                        <button type="button" id="blogCancelBtn" onclick="cancelBlogEdit()"
                            style="display:none; background:transparent; border:1px solid var(--text-muted);">Cancel
                            Edit</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3>Existing Articles</h3>
                <div id="blogsList">
                    <p style="color: var(--text-muted); text-align: center;">Loading articles...</p>
                </div>
            </div>
        </div>

        <!-- Availability Manager Section -->
        <div class="card" id="availabilitySection" style="margin-top: 30px;">
            <div class="card-header" style="margin-bottom: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-clock" style="color: #6366f1;"></i> Manage Availability
                </h2>
                <button onclick="saveAvailability()" class="btn btn-primary" style="padding: 8px 16px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>

            <div style="overflow-x: auto;">
                <table class="admin-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">Day</th>
                            <th style="text-align: center;">Active</th>
                            <th style="text-align: left;">Start Time (IST)</th>
                            <th style="text-align: left;">End Time (IST)</th>
                        </tr>
                    </thead>
                    <tbody id="availabilityTableBody">
                        <!-- Rows generated by JS -->
                        <tr>
                            <td colspan="4" style="text-align:center;">Loading schedule...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Manage Blocked Dates Section -->
        <div class="card" id="blockedDatesSection" style="margin-top: 30px;">
            <div class="card-header" style="margin-bottom: 20px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-ban" style="color: #ef4444;"></i> Manage Blocked Dates
                </h2>
                <p style="color: var(--text-muted); font-size: 0.9em; margin: 5px 0 0 0;">Disable all bookings for
                    specific date ranges (e.g., holidays, personal leave).</p>
            </div>

            <div
                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; font-size: 1rem;">Add New Blocked Range</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Start Date</label>
                        <input type="date" id="blockStartDate">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>End Date</label>
                        <input type="date" id="blockEndDate">
                    </div>
                    <button onclick="addBlockedDate()" style="height: 42px;">
                        <i class="fas fa-plus"></i> Add Block
                    </button>
                </div>
            </div>

            <div id="blockedDatesList" style="margin-top: 20px;">
                <p style="color: var(--text-muted); text-align: center;">Loading blocked dates...</p>
            </div>
        </div>

        <!-- Testimonials Management Section -->
        <div class="card" id="testimonialsSection" style="margin-top: 30px; display: none;">
            <div class="card-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-star" style="color: #fbbf24;"></i> Review Approvals
                </h2>
                <button onclick="loadPendingTestimonials()" class="btn btn-secondary" style="padding: 8px 16px;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div id="pendingTestimonialsList">
                <p style="color: var(--text-muted); text-align: center;">Loading pending reviews...</p>
            </div>
        </div>

        <!-- Alternative Date Modal -->
        <div id="alternativeModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.95); z-index: 2000; justify-content: center; align-items: center;">
            <div class="card" style="width: 400px; max-width: 90%;">
                <h3 style="margin-top: 0;">Suggest Alternative Date</h3>
                <input type="hidden" id="altBookingId">
                <div class="form-group">
                    <label>Alternative Date</label>
                    <input type="date" id="altDate" required>
                </div>
                <div class="form-group">
                    <label>Alternative Time</label>
                    <select id="altTime" required>
                        <option value="">Select time slot</option>
                        <option value="10:00 AM">10:00 AM</option>
                        <option value="11:00 AM">11:00 AM</option>
                        <option value="12:00 PM">12:00 PM</option>
                        <option value="2:00 PM">2:00 PM</option>
                        <option value="3:00 PM">3:00 PM</option>
                        <option value="4:00 PM">4:00 PM</option>
                        <option value="5:00 PM">5:00 PM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Message to Customer (Optional)</label>
                    <textarea id="altMessage" rows="2"
                        placeholder="Explain why you're suggesting this alternative..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="submitAlternative()" style="flex: 1;">Send Alternative</button>
                    <button onclick="closeAlternativeModal()"
                        style="flex: 1; background: transparent; border: 1px solid var(--border);">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div id="cropperModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 15, 0.95); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">
        <div class="card"
            style="width: 800px; max-width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <h3 style="margin-top: 0;">Crop Cover Image</h3>
            <div style="flex: 1; min-height: 300px; background: #000; overflow: hidden; position: relative;">
                <img id="cropperImage" style="max-width: 100%; display: block;" src="">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="cropImage()"
                    style="width: auto; background: linear-gradient(135deg, #22c55e, #16a34a);">Crop & Save</button>
                <button onclick="closeCropperModal()" </div>

                    <!-- Main Script (Includes Email Logic & Config) -->
                    <script src="script.js"></script>

                    <script>
                        // Global variables and functions
                        let supabaseAdminClient = null;
                        let cropper = null;
                        let croppedCoverBlob = null;
                        let quill = null;
                        let blogQuill = null;

                        function togglePriceInput(checkbox) {
                            const input = document.getElementById('productPrice');
                            if (checkbox.checked) {
                                input.value = 0;
                                input.disabled = true;
                            } else {
                                input.disabled = false;
                            }
                        }
                        // SUPABASE_URL and SUPABASE_KEY are now provided by script.js
                        // Keeping only admin-specific auth logic here

                        // Check Password Function (globally accessible)
                        // Check Password Function (globally accessible)
                        function checkPassword() {
                            try {
                                console.log('Login button clicked');
                                const pwd = document.getElementById('adminPassword').value;
                                if (pwd === 'admin123') {
                                    console.log('Password correct, logging in...');
                                    document.getElementById('loginOverlay').style.display = 'none';
                                    document.getElementById('adminContainer').style.display = 'block';

                                    // Force redraw and scroll to top
                                    setTimeout(() => {
                                        window.scrollTo(0, 0);
                                    }, 100);

                                    // Execute load functions safely
                                    try { if (typeof loadProducts === 'function') loadProducts(); } catch (e) { console.error('Products load error', e); }
                                    try { if (typeof loadSessions === 'function') loadSessions(); } catch (e) { console.error('Sessions load error', e); }
                                    try { if (typeof loadRescheduleRequests === 'function') loadRescheduleRequests(); } catch (e) { console.error('Reschedule load error', e); }
                                    try { if (typeof loadCancellationRequests === 'function') loadCancellationRequests(); } catch (e) { console.error('Cancellation load error', e); }
                                    try { if (typeof loadBlogs === 'function') loadBlogs(); } catch (e) { console.error('Blogs load error', e); }
                                    try { if (typeof loadPendingTestimonials === 'function') loadPendingTestimonials(); } catch (e) { console.error('Testimonials load error', e); }
                                    try { if (typeof loadAvailability === 'function') loadAvailability(); } catch (e) { console.error('Availability load error', e); }
                                    try { if (typeof loadBookings === 'function') loadBookings(); } catch (e) { console.error('Bookings load error', e); }
                                    try { if (typeof loadBlockedDates === 'function') loadBlockedDates(); } catch (e) { console.error('Blocked dates load error', e); }
                                    try { if (typeof initDashboard === 'function') initDashboard(); } catch (e) { console.error('Dashboard init error', e); }
                                    try { if (typeof initDashboard === 'function') initDashboard(); } catch (e) { console.error('Dashboard init error', e); }
                                } else {
                                    alert('Incorrect password');
                                }
                            } catch (err) {
                                alert('Login Critical Error: ' + err.message);
                                console.error(err);
                            }
                        }

                        // Global functions for Cropper
                        function closeCropperModal() {
                            const modal = document.getElementById('cropperModal');
                            modal.style.display = 'none';
                            if (cropper) {
                                cropper.destroy();
                                cropper = null;
                            }
                            // If validated blob doesn't exist (cancelled), clear input
                            if (!croppedCoverBlob) {
                                document.getElementById('productCover').value = '';
                            }
                        }

                        function cropImage() {
                            if (!cropper) return;
                            const canvas = cropper.getCroppedCanvas(); // Free size based on crop

                            canvas.toBlob((blob) => {
                                croppedCoverBlob = blob;
                                console.log('✅ Cropped blob created', blob);

                                // Visual feedback
                                const label = document.querySelector('label[for="productCover"]');
                                if (label) {
                                    label.innerHTML = 'Cover Image <span style="color:#22c55e">(Cropped & Ready)</span>';
                                }

                                // Close modal manually without clearing input (since we have the blob)
                                const modal = document.getElementById('cropperModal');
                                modal.style.display = 'none';
                                if (cropper) {
                                    cropper.destroy();
                                    cropper = null;
                                }
                            }, 'image/jpeg', 0.9);
                        }

                        // Initialize when DOM is loaded
                        document.addEventListener('DOMContentLoaded', async function () {
                            console.log('Admin page DOM loaded');

                            // Initialize Quill
                            try {
                                quill = new Quill('#productDescEditor', {
                                    theme: 'snow',
                                    placeholder: 'Detailed product description...',
                                    modules: {
                                        toolbar: [
                                            ['bold', 'italic', 'underline', 'strike'],
                                            ['blockquote', 'code-block'],
                                            [{ 'header': 1 }, { 'header': 2 }],
                                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                            [{ 'script': 'sub' }, { 'script': 'super' }],
                                            [{ 'indent': '-1' }, { 'indent': '+1' }],
                                            [{ 'size': ['small', false, 'large', 'huge'] }],
                                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                            [{ 'color': [] }, { 'background': [] }],
                                            [{ 'align': [] }],
                                            ['clean']
                                        ]
                                    }
                                });
                            } catch (e) { console.error('Quill init error:', e); }

                            // Cropper Event Listener
                            const productCoverInput = document.getElementById('productCover');
                            const cropperImage = document.getElementById('cropperImage');
                            const cropperModal = document.getElementById('cropperModal');

                            if (productCoverInput) {
                                productCoverInput.addEventListener('change', function (e) {
                                    const file = e.target.files[0];
                                    if (file) {
                                        // Reset previous blob
                                        croppedCoverBlob = null;

                                        const reader = new FileReader();
                                        reader.onload = function (e) {
                                            cropperImage.src = e.target.result;
                                            cropperModal.style.display = 'flex';

                                            // Initialize Cropper
                                            if (cropper) cropper.destroy();
                                            cropper = new Cropper(cropperImage, {
                                                aspectRatio: NaN, // Free aspect ratio
                                                viewMode: 1,
                                                autoCropArea: 1,
                                            });
                                        }
                                        reader.readAsDataURL(file);
                                    }
                                });
                            }

                            // ... (keep existing login listeners)
                            const loginBtn = document.getElementById('loginBtn');
                            const passwordInput = document.getElementById('adminPassword');
                            // ... (rest of listeners)

                            if (loginBtn) {
                                loginBtn.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    checkPassword();
                                });
                            }

                            if (passwordInput) {
                                passwordInput.addEventListener('keypress', function (e) {
                                    if (e.key === 'Enter') checkPassword();
                                });
                            }

                            // Initialize Supabase
                            try {
                                // ... (keep existing)
                                if (typeof window.supabase !== 'undefined') {
                                    if (!window.supabaseAdminClient) {
                                        window.supabaseAdminClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                                    }
                                }
                            } catch (e) { console.error(e); }

                            console.log('✅ Brevo email configuration loaded from global scope');

                            // Handle Form Submission
                            document.getElementById('productForm').addEventListener('submit', async (e) => {
                                console.log('Product Form Submit Triggered');
                                e.preventDefault();
                                const btn = document.getElementById('productSubmitBtn');
                                const status = document.getElementById('uploadStatus');

                                btn.disabled = true;
                                btn.textContent = 'Uploading...';
                                status.className = 'status';

                                try {
                                    console.log('Admin Panel Version: Service Key Active');
                                    console.log('Key Prefix:', SUPABASE_KEY ? SUPABASE_KEY.substring(0, 15) : 'None');

                                    const productId = document.getElementById('productId').value.trim();
                                    const name = document.getElementById('productName').value;
                                    const price = document.getElementById('productPrice').value;
                                    const originalPrice = document.getElementById('productOriginalPrice').value || 0;
                                    const enablePPP = document.getElementById('productPPP').checked;
                                    const discount = document.getElementById('productDiscount').value || 0;
                                    const couponCode = document.getElementById('productCouponCode').value || null;
                                    let desc = quill ? quill.root.innerHTML : '';
                                    if (desc === '<p><br></p>') desc = '';
                                    console.log('Update Payload:', { name, price, desc, id: productId }); // Debug Log
                                    const file = document.getElementById('productFile').files[0];
                                    const coverFileInput = document.getElementById('productCover').files[0];
                                    const externalUrl = document.getElementById('productExternalUrl').value.trim(); // New Field
                                    const coverFileToUpload = croppedCoverBlob || coverFileInput;

                                    // Validations: requires either a file upload OR an external URL for new products
                                    if (!productId && !file && !externalUrl) {
                                        throw new Error('Please select a resource file OR provide an external link');
                                    }

                                    // If updating, fetch old product metadata to cleanup old files if they are replaced
                                    let oldProduct = null;
                                    if (productId && (file || coverFileToUpload || externalUrl)) {
                                        const { data } = await window.supabaseAdminClient
                                            .from('products')
                                            .select('file_url, cover_image_url')
                                            .eq('id', productId)
                                            .single();
                                        oldProduct = data;
                                    }

                                    let fileUrl = externalUrl || null; // Priorities External URL
                                    let coverUrl = null;

                                    // 1. Upload Resource File (only if no external URL)
                                    if (file && !externalUrl) {
                                        const fileExt = file.name.split('.').pop();
                                        const fileName = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_res_${Date.now()}.${fileExt}`;

                                        const { data: uploadData, error: uploadError } = await window.supabaseAdminClient.storage
                                            .from('resources')
                                            .upload(fileName, file);

                                        if (uploadError) throw uploadError;

                                        const { data: publicUrlData } = window.supabaseAdminClient.storage
                                            .from('resources')
                                            .getPublicUrl(fileName);

                                        fileUrl = publicUrlData.publicUrl;
                                    }

                                    // 2. Upload Cover Image (if selected or cropped)
                                    if (coverFileToUpload) {
                                        // Blob might not have name, so default to jpg if missing
                                        const fileExt = coverFileToUpload.name ? coverFileToUpload.name.split('.').pop() : 'jpg';
                                        const fileName = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_cover_${Date.now()}.${fileExt}`;

                                        const { data: uploadData, error: uploadError } = await window.supabaseAdminClient.storage
                                            .from('product-covers')
                                            .upload(fileName, coverFileToUpload);

                                        if (uploadError) throw uploadError;

                                        const { data: publicUrlData } = window.supabaseAdminClient.storage
                                            .from('product-covers')
                                            .getPublicUrl(fileName);

                                        coverUrl = publicUrlData.publicUrl;
                                    }

                                    // 3. Save or Update Metadata in Database
                                    const averageRating = parseFloat(document.getElementById('productRating').value) || 5;
                                    const salesCount = parseInt(document.getElementById('productSalesCount').value) || 0;

                                    const productData = {
                                        name: name,
                                        price: parseFloat(price),
                                        original_price: parseFloat(originalPrice),
                                        enable_ppp: enablePPP,
                                        discount_percentage: parseInt(discount) || 0,
                                        coupon_code: couponCode,
                                        description: desc,
                                        average_rating: averageRating,
                                        sales_count: salesCount
                                    };

                                    // Only update URLs if new files were uploaded
                                    if (fileUrl) productData.file_url = fileUrl;
                                    if (coverUrl) productData.cover_image_url = coverUrl;

                                    let dbError;
                                    let savedProductId = productId; // Start with existing ID for updates

                                    if (productId) {
                                        // Update existing product
                                        const result = await window.supabaseAdminClient
                                            .from('products')
                                            .update(productData)
                                            .eq('id', productId)
                                            .select();

                                        if (!result.error && result.data && result.data.length === 0) {
                                            throw new Error('Update failed: ID matched no rows. Refresh and try again.');
                                        }
                                        dbError = result.error;
                                    } else {
                                        // Insert new product
                                        const result = await window.supabaseAdminClient
                                            .from('products')
                                            .insert([productData])
                                            .select();

                                        if (!result.error && result.data && result.data.length > 0) {
                                            savedProductId = result.data[0].id;
                                        }
                                        dbError = result.error;
                                    }

                                    if (dbError) throw dbError;

                                    // Cleanup orphaned files from storage if they were replaced during update
                                    if (oldProduct) {
                                        if (fileUrl && oldProduct.file_url) {
                                            const oldName = oldProduct.file_url.split('/').pop();
                                            await window.supabaseAdminClient.storage.from('resources').remove([oldName]);
                                            console.log('🧹 Cleaned up old resource file:', oldName);
                                        }
                                        if (coverUrl && oldProduct.cover_image_url) {
                                            const oldName = oldProduct.cover_image_url.split('/').pop();
                                            await window.supabaseAdminClient.storage.from('product-covers').remove([oldName]);
                                            console.log('🧹 Cleaned up old cover image:', oldName);
                                        }
                                    }

                                    // 4. Save Selected Reviews to product_reviews table
                                    if (savedProductId) {
                                        await saveProductReviews(savedProductId);
                                    }

                                    // Success
                                    status.textContent = productId ? '✅ Product updated successfully!' : '✅ Product added successfully!';
                                    status.classList.add('success');
                                    document.getElementById('productForm').reset();
                                    if (quill) quill.setText('');

                                    // Reset Cropper State
                                    croppedCoverBlob = null;
                                    const cLabel = document.querySelector('label[for="productCover"]');
                                    if (cLabel) cLabel.innerHTML = 'Cover Image (Required)';

                                    document.getElementById('productId').value = '';
                                    document.getElementById('productSubmitBtn').textContent = 'Upload & Save Product';
                                    document.getElementById('cancelEditBtn').style.display = 'none';
                                    document.getElementById('fileUploadGroup').style.display = 'block';
                                    loadProducts();

                                } catch (error) {
                                    console.error('Error:', error);
                                    alert('Error: ' + error.message); // Expose error to user
                                    status.textContent = '❌ Error: ' + error.message;
                                    status.classList.add('error');
                                } finally {
                                    btn.disabled = false;
                                    btn.textContent = 'Upload & Save Product';
                                }
                            });

                            // Load Products - defined outside DOMContentLoaded
                            async function loadProducts() {
                                const list = document.getElementById('productsList');

                                if (!window.supabaseAdminClient) {
                                    list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                                    return;
                                }

                                const { data, error } = await window.supabaseAdminClient
                                    .from('products')
                                    .select('*')
                                    .order('created_at', { ascending: false });

                                if (error) {
                                    list.innerHTML = `<p style="color: red">Error loading products: ${error.message}</p>`;
                                    return;
                                }

                                if (data.length === 0) {
                                    list.innerHTML = '<p class="text-muted">No products found.</p>';
                                    return;
                                }

                                list.innerHTML = data.map(p => {
                                    const price = p.price;
                                    const originalPrice = p.original_price || 0;
                                    const discountPercent = p.discount_percentage || 0;
                                    const discountedPrice = discountPercent > 0 ? Math.round(price * (1 - discountPercent / 100)) : price;
                                    const hasPPP = p.enable_ppp ? '<span style="background: rgba(99, 102, 241, 0.2); color: #6366f1; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">PPP Enabled</span>' : '';
                                    const coverImg = p.cover_image_url ?
                                        `<img src="${p.cover_image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px;" alt="Cover">` :
                                        `<div style="width: 50px; height: 50px; background: var(--border); border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: var(--text-muted);"></i></div>`;

                                    const isExternal = p.file_url && !p.file_url.includes('supabase');
                                    const storageBadge = isExternal
                                        ? '<span style="background: rgba(99, 102, 241, 0.2); color: #818cf8; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;" title="Hosted Externally (No Egress Cost)"><i class="fas fa-external-link-alt"></i> External</span>'
                                        : '<span style="background: rgba(239, 68, 68, 0.2); color: #f87171; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;" title="Hosted on Supabase (Costs Egress)"><i class="fas fa-database"></i> Supabase</span>';

                                    return `
                <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center;">
                        ${coverImg}
                        <div>
                            <strong>${p.name}</strong> ${p.price === 0 ? '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">FREE RESOURCE</span>' : ''} ${hasPPP} ${storageBadge}<br>
                            <span style="color: var(--text-muted); font-size: 0.9em;">
                                ${originalPrice > price ?
                                            `<span style="text-decoration: line-through; color: #ef4444; margin-right: 5px;">₹${originalPrice}</span>` : ''}
                                ${discountPercent > 0 ?
                                            `<span style="text-decoration: line-through; color: #ef4444;">₹${price}</span> 
                                     <span style="color: #22c55e; font-weight: bold;">₹${discountedPrice}</span>
                                     <span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px;">${discountPercent}% OFF</span>` :
                                            `₹${price}`}
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="copyProductLink('${p.id}')" style="background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 8px 12px; font-size: 0.9em;" title="Copy shareable link for LinkedIn/Socials">
                            <i class="fas fa-link"></i> Link
                        </button>
                        <a href="${p.file_url}" target="_blank" style="color: var(--primary); text-decoration: none; padding: 8px 16px; border: 1px solid var(--primary); border-radius: 6px;">Download</a>
                        <button onclick="editProduct('${p.id}')" style="padding: 8px 16px; font-size: 0.9em;">Edit</button>
                        <button onclick="deleteProduct('${p.id}')" style="padding: 8px 16px; font-size: 0.9em; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Delete</button>
                    </div>
                </div>
            `}).join('');
                            }

                            // Helper to copy product link
                            window.copyProductLink = (id) => {
                                const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', 'index.html');
                                const shareUrl = `${baseUrl}?id=${id}`;
                                navigator.clipboard.writeText(shareUrl).then(() => {
                                    alert('✅ Shareable link copied to clipboard!\n' + shareUrl);
                                }).catch(err => {
                                    console.error('Copy failed:', err);
                                    alert('❌ Copy failed. Link: ' + shareUrl);
                                });
                            };


                            // Edit Product
                            async function editProduct(id) {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('products')
                                    .select('*')
                                    .eq('id', id)
                                    .single();

                                if (error) {
                                    alert('❌ Error loading product: ' + error.message);
                                    return;
                                }

                                document.getElementById('productId').value = data.id;
                                document.getElementById('productName').value = data.name;
                                document.getElementById('productPrice').value = data.price;
                                document.getElementById('productOriginalPrice').value = data.original_price || '';
                                document.getElementById('productPPP').checked = data.enable_ppp || false;
                                document.getElementById('productDiscount').value = data.discount_percentage || 0;
                                document.getElementById('productCouponCode').value = data.coupon_code || '';

                                // Populate External URL if detected
                                const extUrlInput = document.getElementById('productExternalUrl');
                                if (data.file_url && !data.file_url.includes('supabase.co')) {
                                    extUrlInput.value = data.file_url;
                                } else {
                                    extUrlInput.value = '';
                                }

                                // Handle Free Resource Checkbox
                                const freeCheck = document.getElementById('productFree');
                                if (freeCheck) {
                                    freeCheck.checked = (data.price === 0);
                                    togglePriceInput(freeCheck);
                                }

                                // Load Rating & Sales Count
                                document.getElementById('productRating').value = data.average_rating || 5;
                                document.getElementById('productSalesCount').value = data.sales_count || 0;

                                // Load selected reviews for this product
                                await loadProductReviewsSelection(data.id);

                                if (quill) quill.root.innerHTML = data.description || '';
                                document.getElementById('productSubmitBtn').textContent = 'Update Product';
                                document.getElementById('cancelEditBtn').style.display = 'inline-block';

                                // Show file input for edit mode so user can optionally update the file
                                document.getElementById('fileUploadGroup').style.display = 'block';

                                // Scroll to form
                                document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });

                                // Reset any existing cropped blob
                                croppedCoverBlob = null;
                                const label = document.querySelector('label[for="productCover"]');
                                if (label) label.innerHTML = 'Cover Image (Required)';
                                document.getElementById('productCover').value = '';
                            }

                            // Cancel Product Edit
                            function cancelProductEdit() {
                                document.getElementById('productId').value = '';
                                document.getElementById('productName').value = '';
                                document.getElementById('productPrice').value = '';
                                document.getElementById('productOriginalPrice').value = '';
                                document.getElementById('productPPP').checked = false;
                                document.getElementById('productDiscount').value = '';
                                document.getElementById('productCouponCode').value = '';
                                document.getElementById('productExternalUrl').value = ''; // Reset external URL

                                const freeCheck = document.getElementById('productFree');
                                if (freeCheck) {
                                    freeCheck.checked = false;
                                    togglePriceInput(freeCheck);
                                }

                                if (quill) quill.setText('');
                                document.getElementById('productSubmitBtn').textContent = 'Upload & Save Product';
                                document.getElementById('cancelEditBtn').style.display = 'none';
                                document.getElementById('fileUploadGroup').style.display = 'block';
                                document.getElementById('fileUploadGroup').querySelector('input').required = false;

                                // Reset cropped blob
                                croppedCoverBlob = null;
                                const label = document.querySelector('label[for="productCover"]');
                                if (label) label.innerHTML = 'Cover Image (Required)';
                                document.getElementById('productCover').value = '';
                            }

                            // Load Testimonials Checkboxes for Review Selection
                            async function loadReviewsCheckboxes(selectedReviewIds = []) {
                                const container = document.getElementById('productReviewsCheckboxes');
                                if (!container) return;

                                try {
                                    const { data: testimonials, error } = await window.supabaseAdminClient
                                        .from('testimonials')
                                        .select('id, name, review, rating')
                                        .eq('is_published', true)
                                        .order('created_at', { ascending: false });

                                    if (error) {
                                        container.innerHTML = `<p style="color: red; font-size: 0.9em;">Error loading reviews: ${error.message}</p>`;
                                        return;
                                    }

                                    if (!testimonials || testimonials.length === 0) {
                                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; font-size: 0.9em;">No published reviews available.</p>';
                                        return;
                                    }

                                    container.innerHTML = testimonials.map(t => {
                                        const isChecked = selectedReviewIds.includes(t.id) ? 'checked' : '';
                                        const stars = '★'.repeat(t.rating) + '☆'.repeat(5 - t.rating);
                                        const shortReview = t.review.length > 60 ? t.review.substring(0, 60) + '...' : t.review;
                                        return `
                                            <label style="display: flex; align-items: flex-start; gap: 10px; padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer;">
                                                <input type="checkbox" class="product-review-checkbox" value="${t.id}" ${isChecked} style="margin-top: 3px;">
                                                <div>
                                                    <strong style="color: var(--text);">${t.name}</strong>
                                                    <span style="color: #fbbf24; margin-left: 8px;">${stars}</span>
                                                    <p style="margin: 4px 0 0; color: var(--text-muted); font-size: 0.85em;">"${shortReview}"</p>
                                                </div>
                                            </label>
                                        `;
                                    }).join('');

                                } catch (e) {
                                    container.innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
                                }
                            }

                            // Load product's existing selected reviews
                            async function loadProductReviewsSelection(productId) {
                                let selectedIds = [];

                                try {
                                    const { data: links, error } = await window.supabaseAdminClient
                                        .from('product_reviews')
                                        .select('testimonial_id')
                                        .eq('product_id', productId);

                                    if (!error && links) {
                                        selectedIds = links.map(l => l.testimonial_id);
                                    }
                                } catch (e) {
                                    console.log('product_reviews table may not exist yet:', e);
                                }

                                await loadReviewsCheckboxes(selectedIds);
                            }

                            // Save selected reviews to product_reviews table
                            async function saveProductReviews(productId) {
                                const checkboxes = document.querySelectorAll('.product-review-checkbox:checked');
                                const selectedTestimonialIds = Array.from(checkboxes).map(cb => cb.value);

                                try {
                                    // First, delete existing links for this product
                                    await window.supabaseAdminClient
                                        .from('product_reviews')
                                        .delete()
                                        .eq('product_id', productId);

                                    // If no reviews selected, we're done
                                    if (selectedTestimonialIds.length === 0) return;

                                    // Insert new links
                                    const links = selectedTestimonialIds.map((tid, index) => ({
                                        product_id: productId,
                                        testimonial_id: tid,
                                        display_order: index
                                    }));

                                    const { error } = await window.supabaseAdminClient
                                        .from('product_reviews')
                                        .insert(links);

                                    if (error) {
                                        console.error('Error saving product reviews:', error);
                                    }
                                } catch (e) {
                                    console.log('product_reviews save error (table may not exist yet):', e);
                                }
                            }

                            // Initialize reviews checkboxes on page load
                            loadReviewsCheckboxes();

                            // Delete Product
                            async function deleteProduct(id) {
                                console.log('🗑️ Attempting to delete product:', id);
                                if (!confirm('⚠️ Are you sure you want to delete this product and its associated files from storage?')) return;

                                try {
                                    // 1. Fetch product first to get file URLs for cleanup
                                    const { data: product } = await window.supabaseAdminClient
                                        .from('products')
                                        .select('file_url, cover_image_url')
                                        .eq('id', id)
                                        .single();

                                    // 2. Delete from database
                                    const { data, error } = await window.supabaseAdminClient
                                        .from('products')
                                        .delete()
                                        .eq('id', id)
                                        .select();

                                    console.log('🗑️ Database delete result:', { data, error });

                                    if (error) throw error;

                                    // 3. Delete files from storage if they exist
                                    if (product) {
                                        if (product.file_url) {
                                            const fileName = product.file_url.split('/').pop();
                                            await window.supabaseAdminClient.storage.from('resources').remove([fileName]);
                                            console.log('🧹 Deleted resource file from storage:', fileName);
                                        }
                                        if (product.cover_image_url) {
                                            const fileName = product.cover_image_url.split('/').pop();
                                            await window.supabaseAdminClient.storage.from('product-covers').remove([fileName]);
                                            console.log('🧹 Deleted cover image from storage:', fileName);
                                        }
                                    }

                                    alert('✅ Product and associated files deleted successfully!');
                                    await loadProducts();
                                } catch (error) {
                                    console.error('❌ Delete error:', error);
                                    alert('❌ Error deleting product: ' + error.message);
                                }
                            }



                            // Handle Session Form Submission
                            document.getElementById('sessionForm').addEventListener('submit', async (e) => {
                                e.preventDefault();
                                const btn = document.getElementById('sessionSubmitBtn');
                                const originalText = btn.textContent;
                                btn.disabled = true;
                                btn.textContent = 'Saving...';

                                try {
                                    const sessionId = document.getElementById('sessionId').value;
                                    const name = document.getElementById('sessionName').value;
                                    const duration = parseInt(document.getElementById('sessionDuration').value);
                                    const price = parseInt(document.getElementById('sessionPrice').value);
                                    const description = document.getElementById('sessionDesc').value;
                                    const featuresText = document.getElementById('sessionFeatures').value;
                                    const features = featuresText.split('\n').filter(f => f.trim() !== '');
                                    const isPopular = document.getElementById('sessionPopular').checked;
                                    const isActive = document.getElementById('sessionActive').checked;

                                    const sessionData = {
                                        name,
                                        duration,
                                        price,
                                        description,
                                        features,
                                        is_popular: isPopular,
                                        is_active: isActive
                                    };

                                    if (sessionId) {
                                        // Update existing session
                                        const { error } = await window.supabaseAdminClient
                                            .from('sessions')
                                            .update(sessionData)
                                            .eq('id', sessionId);
                                        if (error) throw error;
                                        alert('✅ Session updated successfully!');
                                    } else {
                                        // Create new session
                                        const { error } = await window.supabaseAdminClient
                                            .from('sessions')
                                            .insert([sessionData]);
                                        if (error) throw error;
                                        alert('✅ New session created successfully!');
                                    }

                                    document.getElementById('sessionForm').reset();
                                    document.getElementById('sessionId').value = '';
                                    await loadSessions();
                                } catch (error) {
                                    console.error('Error saving session:', error);
                                    alert('❌ Error: ' + error.message);
                                } finally {
                                    btn.disabled = false;
                                    btn.textContent = originalText;
                                }
                            });

                            // Reset Session Form
                            document.getElementById('sessionResetBtn').addEventListener('click', () => {
                                document.getElementById('sessionForm').reset();
                                document.getElementById('sessionId').value = '';
                                document.getElementById('sessionSubmitBtn').textContent = 'Save Session';
                            });

                            // Global functions for session management
                            window.checkPassword = checkPassword;
                            window.loadProducts = loadProducts;
                            window.editProduct = editProduct;
                            window.deleteProduct = deleteProduct;
                            window.cancelProductEdit = cancelProductEdit;
                            window.editSession = editSession;
                            window.deleteSession = deleteSession;

                            // Reschedule Request Functions
                            window.loadRescheduleRequests = loadRescheduleRequests;
                            window.approveReschedule = approveReschedule;
                            window.showAlternativeModal = showAlternativeModal;
                            window.closeAlternativeModal = closeAlternativeModal;
                            window.submitAlternative = submitAlternative;
                            window.rejectReschedule = rejectReschedule;
                        }); // End of DOMContentLoaded

                        // Reschedule Request Functions
                        async function loadRescheduleRequests() {
                            const list = document.getElementById('rescheduleRequestsList');

                            if (!window.supabaseAdminClient) {
                                list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                                return;
                            }

                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .eq('status', 'reschedule_requested')
                                    .order('created_at', { ascending: false });

                                if (error) {
                                    list.innerHTML = `<p style="color: red">Error loading requests: ${error.message}</p>`;
                                    return;
                                }

                                if (!data || data.length === 0) {
                                    list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No pending reschedule requests.</p>';
                                    return;
                                }

                                list.innerHTML = data.map(booking => `
                    <div class="reschedule-item">
                        <div class="reschedule-header">
                            <div>
                                <strong>${booking.service_name || booking.service || 'Session'}</strong><br>
                                <span style="color: var(--text-muted); font-size: 0.9em;">
                                    Booking ID: ${booking.id}<br>
                                    Customer: ${booking.email}
                                </span>
                            </div>
                            <span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                Pending
                            </span>
                        </div>
                        
                        <div class="reschedule-details">
                            <div class="date-box current">
                                <div class="date-label">Current Schedule</div>
                                <div class="date-value">${formatDate(booking.booking_date || booking.date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.booking_time || booking.time}</div>
                            </div>
                            <div class="date-box requested">
                                <div class="date-label">Requested Schedule</div>
                                <div class="date-value">${formatDate(booking.requested_date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.requested_time}</div>
                            </div>
                        </div>

                        ${(function () {
                                        const link = booking.meet_link || 'https://meet.google.com/hfp-npyq-qho';
                                        return `<div style="background: rgba(34, 197, 94, 0.1); padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em; color: #22c55e;"><i class="fas fa-video"></i> <strong>Meet Link:</strong> <a href="${link}" target="_blank" style="color: inherit; text-decoration: underline;">${link}</a></div>`;
                                    })()}
                        
                        ${booking.reschedule_reason ? `<p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;"><strong>Reason:</strong> ${booking.reschedule_reason}</p>` : ''}
                        
                        <div class="reschedule-actions">
                            <button onclick="approveReschedule('${booking.id}', '${booking.email}')" class="btn-approve" style="padding: 10px 20px; font-size: 0.9em;">
                                ✓ Approve
                            </button>
                            <button onclick="showAlternativeModal('${booking.id}', '${booking.email}')" class="btn-alternative" style="padding: 10px 20px; font-size: 0.9em;">
                                ✎ Suggest Alternative
                            </button>
                            <button onclick="rejectReschedule('${booking.id}', '${booking.email}')" class="btn-reject" style="padding: 10px 20px; font-size: 0.9em;">
                                ✕ Reject
                            </button>
                        </div>
                    </div>
                `).join('');
                            } catch (error) {
                                console.error('Error loading reschedule requests:', error);
                                list.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
                            }
                        }

                        // Approve Reschedule Request
                        async function approveReschedule(bookingId, email) {
                            if (!confirm('✓ Approve this reschedule request?\n\nThe booking will be updated with the requested date/time.')) {
                                return;
                            }

                            try {
                                // Get the current booking to retrieve requested dates
                                const { data: booking, error: fetchError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .eq('id', bookingId)
                                    .single();

                                if (fetchError) throw fetchError;

                                // Check if reschedule was requested
                                if (!booking.requested_date || !booking.requested_time) {
                                    alert('❌ Error: No reschedule request found for this booking.');
                                    return;
                                }

                                // Update the booking
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        booking_date: booking.requested_date,
                                        booking_time: booking.requested_time,
                                        status: 'upcoming',
                                        requested_date: null,
                                        requested_time: null,
                                        reschedule_reason: null
                                    })
                                    .eq('id', bookingId);

                                if (updateError) throw updateError;

                                // Notify user via Brevo
                                const meetLink = booking.meet_link || 'https://meet.google.com/hfp-npyq-qho';
                                // Use booking name if available
                                const customerName = booking.name || 'Customer';

                                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #10b981;">✅ Reschedule Request Approved</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p>Hi <strong>${customerName}</strong>,</p>
                        <p>Your reschedule request has been approved!</p>
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <h3 style="color: #2563eb;">New Schedule:</h3>
                        <p><strong>📅 Date:</strong> ${booking.requested_date}</p>
                        <p><strong>⏰ Time:</strong> ${booking.requested_time}</p>
                        <p><strong>🔗 Meet Link:</strong> <a href="${meetLink}">${meetLink}</a></p>
                        <p>Your session is now confirmed for the new date/time.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                                const textContent = `
✅ RESCHEDULE REQUEST APPROVED
━━━━━━━━━━━━━━━━━━━━
Hi ${customerName},

Your reschedule request has been approved!

New Schedule:
• Date: ${booking.requested_date}
• Time: ${booking.requested_time}

Meet Link: ${meetLink}

Your session is now confirmed for the new date/time.

Best regards,
QuantMentor
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                                await sendEmailWithBrevo(email, `Reschedule Approved - Booking ${bookingId}`, htmlContent, textContent);

                                alert('✅ Reschedule request approved!\n\nUser has been notified.');
                                await loadRescheduleRequests();
                            } catch (error) {
                                console.error('Error approving reschedule:', error);
                                alert('❌ Error approving request: ' + error.message);
                            }
                        }

                        // Show Alternative Date Modal
                        function showAlternativeModal(bookingId, email) {
                            document.getElementById('altBookingId').value = bookingId;
                            document.getElementById('altDate').value = '';
                            document.getElementById('altTime').value = '';
                            document.getElementById('altMessage').value = '';
                            document.getElementById('alternativeModal').style.display = 'flex';
                        }

                        // Close Alternative Modal
                        function closeAlternativeModal() {
                            document.getElementById('alternativeModal').style.display = 'none';
                        }

                        // Submit Alternative Date
                        async function submitAlternative() {
                            const bookingId = document.getElementById('altBookingId').value;
                            const altDate = document.getElementById('altDate').value;
                            const altTime = document.getElementById('altTime').value;
                            const message = document.getElementById('altMessage').value;

                            if (!altDate || !altTime) {
                                alert('Please select both date and time');
                                return;
                            }

                            try {
                                // Get current booking for email
                                const { data: booking, error: fetchError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .eq('id', bookingId)
                                    .single();

                                if (fetchError) throw fetchError;

                                // Update booking with alternative date
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        booking_date: altDate,
                                        booking_time: altTime,
                                        status: 'upcoming',
                                        requested_date: null,
                                        requested_time: null,
                                        reschedule_reason: null
                                    })
                                    .eq('id', bookingId);

                                if (updateError) throw updateError;

                                // Notify user via Brevo
                                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #f59e0b;">📅 Alternative Date Offered</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>We couldn't accommodate your requested date, but we're offering an alternative:</p>
                        <h3 style="color: #2563eb;">Alternative Schedule:</h3>
                        <p><strong>📅 Date:</strong> ${altDate}</p>
                        <p><strong>⏰ Time:</strong> ${altTime}</p>
                        ${message ? `<p><strong>Message from Admin:</strong></p><p style="background: #f3f4f6; padding: 10px; border-radius: 5px;">${message}</p>` : ''}
                        <p>Your session has been automatically updated to this new date/time.</p>
                        <p>If this doesn't work for you, please contact us to reschedule.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                                const textContent = `
📅 ALTERNATIVE DATE OFFERED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

We couldn't accommodate your requested date, but we're offering an alternative:

Alternative Schedule:
• Date: ${altDate}
• Time: ${altTime}

${message ? 'Message from Admin:\n' + message + '\n\n' : ''}
Your session has been automatically updated to this new date/time.

If this doesn't work for you, please contact us to reschedule.
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                                await sendEmailWithBrevo(booking.email, `Alternative Date Offered - Booking ${bookingId}`, htmlContent, textContent);

                                alert('✅ Alternative date sent to user!');
                                closeAlternativeModal();
                                await loadRescheduleRequests();
                            } catch (error) {
                                console.error('Error submitting alternative:', error);
                                alert('❌ Error: ' + error.message);
                            }
                        }

                        // Reject Reschedule Request
                        async function rejectReschedule(bookingId, email) {
                            const reason = prompt('Please provide a reason for rejection (optional):');
                            if (reason === null) return; // User cancelled

                            if (!confirm('✕ Reject this reschedule request?\n\nThe booking will remain at the original date/time.')) {
                                return;
                            }

                            try {
                                // Clear reschedule request fields and keep original schedule
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        status: 'upcoming',
                                        requested_date: null,
                                        requested_time: null,
                                        reschedule_reason: null
                                    })
                                    .eq('id', bookingId);

                                if (updateError) throw updateError;

                                // Notify user via Brevo
                                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #ef4444;">❌ Reschedule Request Rejected</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your reschedule request could not be accommodated.</p>
                        <p>Your booking remains scheduled for the original date/time.</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                        <p>Please contact us if you need further assistance.</p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                                const textContent = `
❌ RESCHEDULE REQUEST REJECTED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your reschedule request could not be accommodated.

Your booking remains scheduled for the original date/time.
${reason ? `\nReason: ${reason}` : ''}

Please contact us if you need further assistance.
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                                await sendEmailWithBrevo(email, `Reschedule Request Rejected - Booking ${bookingId}`, htmlContent, textContent);

                                alert('✅ Reschedule request rejected.\n\nUser has been notified.');
                                await loadRescheduleRequests();
                            } catch (error) {
                                console.error('Error rejecting reschedule:', error);
                                alert('❌ Error: ' + error.message);
                            }
                        }

                        // =============================================
                        // CANCELLATION REQUEST MANAGEMENT
                        // =============================================

                        // Load Cancellation Requests
                        async function loadCancellationRequests() {
                            const list = document.getElementById('cancellationRequestsList');
                            console.log('📋 Loading cancellation requests...');

                            if (!window.supabaseAdminClient) {
                                list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                                console.error('❌ Supabase not initialized');
                                return;
                            }

                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .eq('status', 'cancellation_requested')
                                    .order('created_at', { ascending: false });

                                console.log('📋 Cancellation requests result:', { data, error });

                                if (error) {
                                    list.innerHTML = `<p style="color: red">Error loading requests: ${error.message}</p>`;
                                    console.error('❌ Error:', error);
                                    return;
                                }

                                if (!data || data.length === 0) {
                                    list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No pending cancellation requests.</p>';
                                    console.log('📋 No cancellation requests found');
                                    return;
                                }

                                list.innerHTML = data.map(booking => `
                    <div class="reschedule-item" style="border-left: 3px solid #ef4444;">
                        <div class="reschedule-header">
                            <div>
                                <strong>${booking.service_name || booking.service || 'Session'}</strong><br>
                                <span style="color: var(--text-muted); font-size: 0.9em;">
                                    Booking ID: ${booking.id}<br>
                                    Customer: ${booking.name} (${booking.email})
                                </span>
                            </div>
                            <span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                Cancellation Pending
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div class="date-box" style="border-left: 3px solid #94a3b8;">
                                <div class="date-label">Booked Session</div>
                                <div class="date-value">${formatDate(booking.booking_date)}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.booking_time}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em; margin-top: 5px;">Price: ₹${booking.service_price}</div>
                            </div>
                            <div class="date-box" style="border-left: 3px solid #22c55e;">
                                <div class="date-label">Refund Details</div>
                                <div class="date-value" style="color: #22c55e;">₹${booking.refund_amount || 0}</div>
                                <div style="color: var(--text-muted); font-size: 0.9em;">${booking.refund_percentage || 0}% of original</div>
                                <div style="color: var(--text-muted); font-size: 0.9em; margin-top: 5px;">Payment ID: ${booking.payment_id || 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${booking.cancellation_reason ? `<p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;"><strong>Reason:</strong> ${booking.cancellation_reason}</p>` : ''}
                        
                        <div class="reschedule-actions">
                            <button onclick="approveRefund('${booking.id}', '${booking.email}', ${booking.refund_amount || 0}, '${booking.payment_id || ''}')" class="btn-approve" style="padding: 10px 20px; font-size: 0.9em;">
                                💰 Approve Refund (₹${booking.refund_amount || 0})
                            </button>
                            <button onclick="rejectCancellation('${booking.id}', '${booking.email}')" class="btn-reject" style="padding: 10px 20px; font-size: 0.9em;">
                                ✕ Reject
                            </button>
                        </div>
                        
                        <p style="color: var(--text-muted); font-size: 0.8em; margin-top: 10px; margin-bottom: 0;">
                            <i class="fas fa-info-circle"></i> After approving, process refund in Razorpay Dashboard using Payment ID: <strong>${booking.payment_id || 'N/A'}</strong>
                        </p>
                    </div>
                `).join('');
                            } catch (error) {
                                console.error('Error loading cancellation requests:', error);
                                list.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
                            }
                        }

                        // Approve Refund and mark as processed
                        async function approveRefund(bookingId, email, refundAmount, paymentId) {
                            const confirmMessage = `💰 Approve Refund?

Refund Amount: ₹${refundAmount}
Payment ID: ${paymentId || 'N/A'}

After clicking OK:
1. The booking will be marked as cancelled
2. User will receive email confirmation
3. You must manually process the refund in Razorpay Dashboard

Proceed?`;

                            if (!confirm(confirmMessage)) {
                                return;
                            }

                            try {
                                // Update booking status to cancelled and refund as processed
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        status: 'cancelled',
                                        refund_status: 'processed'
                                    })
                                    .eq('id', bookingId);

                                if (updateError) throw updateError;

                                // Send refund confirmation email to user via Brevo
                                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #10b981;">💰 Refund Processed</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        <p>Your cancellation request has been approved and your refund is being processed.</p>
                        <h3 style="color: #2563eb;">Refund Details:</h3>
                        <p><strong>💵 Refund Amount:</strong> ₹${refundAmount}</p>
                        <p><strong>⏰ Processing Time:</strong> 5-7 business days</p>
                        <p>The refund will be credited to your original payment method.</p>
                        <p>Thank you for using QuantMentor. We hope to serve you again!</p>
                        <p>If you have any questions, please contact us at <a href="mailto:jha.8@alumni.iitj.ac.in">jha.8@alumni.iitj.ac.in</a></p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                                const textContent = `
💰 REFUND PROCESSED
━━━━━━━━━━━━━━━━━━━━
Booking ID: ${bookingId}

Your cancellation request has been approved and your refund is being processed.

REFUND DETAILS:
• Refund Amount: ₹${refundAmount}
• Processing Time: 5-7 business days

The refund will be credited to your original payment method.

Thank you for using QuantMentor. We hope to serve you again!

If you have any questions, please contact us at jha.8@alumni.iitj.ac.in
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                                await sendEmailWithBrevo(email, `Refund Processed - Booking ${bookingId}`, htmlContent, textContent);

                                alert(`✅ Refund Approved!

📧 User has been notified.

⚠️ NEXT STEP: Process refund in Razorpay Dashboard
Payment ID: ${paymentId || 'N/A'}
Amount: ₹${refundAmount}

Go to: Razorpay Dashboard → Transactions → Search Payment ID → Issue Refund`);

                                await loadCancellationRequests();
                            } catch (error) {
                                console.error('Error approving refund:', error);
                                alert('❌ Error: ' + error.message);
                            }
                        }

                        // Reject Cancellation Request
                        async function rejectCancellation(bookingId, email) {
                            // ... (keep existing)
                            const reason = prompt('Please provide a reason for rejection:');
                            if (reason === null) return; // User clicked Cancel

                            if (!confirm('✕ Reject this cancellation request?\n\nThe booking will remain active.')) {
                                return;
                            }

                            try {
                                // Revert booking to confirmed status
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        status: 'confirmed',
                                        refund_status: 'rejected',
                                        cancellation_reason: null
                                    })
                                    .eq('id', bookingId);

                                if (updateError) throw updateError;

                                // Notify user via Brevo
                                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h2 style="color: #ef4444;">❌ Cancellation Request Rejected</h2>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p>Hi,</p>
                        <p>Your cancellation request could not be processed.</p>
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                        <p>Your booking remains active. Please attend the session as scheduled.</p>
                        <p>If you have any questions, please contact us at <a href="mailto:jha.8@alumni.iitj.ac.in">jha.8@alumni.iitj.ac.in</a></p>
                        <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                        <p style="color: #6b7280;">Best regards,<br>QuantMentor</p>
                    </div>
                `;
                                const textContent = `
❌ CANCELLATION REQUEST REJECTED
━━━━━━━━━━━━━━━━━━━━
Hi,

Booking ID: ${bookingId}
Your cancellation request could not be processed.

${reason ? `Reason: ${reason}` : ''}

Your booking remains active. Please attend the session as scheduled.

If you have any questions, please contact us at jha.8@alumni.iitj.ac.in

Best regards,
QuantMentor
━━━━━━━━━━━━━━━━━━━━
                `.trim();

                                await sendEmailWithBrevo(email, `Cancellation Request Rejected - Booking ${bookingId}`, htmlContent, textContent);

                                alert('✅ Cancellation request rejected.\n\nUser has been notified. Booking remains active.');
                                await loadCancellationRequests();
                            } catch (error) {
                                console.error('Error rejecting cancellation:', error);
                                alert('❌ Error: ' + error.message);
                            }
                        }

                        // Logout function
                        function logout() {
                            if (confirm('Are you sure you want to logout?')) {
                                document.getElementById('adminContainer').style.display = 'none';
                                document.getElementById('loginOverlay').style.display = 'flex';
                                document.getElementById('adminPassword').value = '';
                                // Optional: refresh page to clear any in-memory state
                                window.location.reload();
                            }
                        }

                        // Export cancellation functions to window
                        window.loadCancellationRequests = loadCancellationRequests;
                        window.approveRefund = approveRefund;
                        window.rejectCancellation = rejectCancellation;

                        // Helper function to format dates
                        function formatDate(dateString) {
                            if (!dateString) return 'N/A';
                            const date = new Date(dateString);
                            return date.toLocaleDateString('en-US', {
                                weekday: 'short',
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        }

                        // --- DASHBOARD LOGIC ---
                        let revenueChart = null;
                        let distributionChart = null;

                        async function initDashboard() {
                            console.log('📊 Initializing Dashboard...');
                            document.getElementById('adminContainer').style.display = 'block';

                            // Load components in parallel
                            await Promise.all([
                                updateDashboardStats(),
                                updateDashboardCharts(),
                                loadTopProducts(),
                                loadRecentActivity(),
                                loadClients()
                            ]);
                        }

                        async function updateDashboardStats() {
                            try {
                                const now = new Date();
                                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                                const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString();
                                const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0).toISOString();

                                // 1. Active Bookings (Upcoming + Confirmed)
                                const { count: activeBookingsCount } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*', { count: 'exact', head: true })
                                    .in('status', ['confirmed', 'upcoming']);

                                // 2. Completed Bookings (Total)
                                const { count: completedBookingsCount } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*', { count: 'exact', head: true })
                                    .eq('status', 'completed');

                                // 3. Total Sales Count
                                const { count: totalSalesCount } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('*', { count: 'exact', head: true });

                                // 4. Financials (This Month vs Last Month)
                                // We need to fetch amounts to calculate sums, but we can limit fields
                                const { data: currentMonthBookings } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('service_price')
                                    .gte('created_at', startOfMonth)
                                    .in('status', ['confirmed', 'completed', 'upcoming']);

                                const { data: currentMonthPurchases } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('amount')
                                    .gte('created_at', startOfMonth);

                                const { data: lastMonthBookings } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('service_price')
                                    .gte('created_at', startOfLastMonth)
                                    .lte('created_at', endOfLastMonth)
                                    .in('status', ['confirmed', 'completed', 'upcoming']);

                                const { data: lastMonthPurchases } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('amount')
                                    .gte('created_at', startOfLastMonth)
                                    .lte('created_at', endOfLastMonth);

                                // 5. Total Lifetime Revenue (Estimated from simplified query or pre-calculated in DB - here we do a fetch all for amounts only as it's lighter than full rows)
                                // Optimization: If history is huge, this should be a stored procedure. For <10k rows, fetching just 'amount' is fine (~50KB).
                                const { data: allBookingsRev } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('service_price')
                                    .in('status', ['confirmed', 'completed', 'upcoming']);

                                const { data: allPurchasesRev } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('amount');

                                // Calculations
                                const calcRevenue = (bookings, purchases) => {
                                    const bRev = (bookings || []).reduce((sum, b) => sum + (b.service_price || 0), 0);
                                    const pRev = (purchases || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                                    return bRev + pRev;
                                };

                                const currentRevenue = calcRevenue(currentMonthBookings, currentMonthPurchases);
                                const lastRevenue = calcRevenue(lastMonthBookings, lastMonthPurchases);
                                const totalLifetimeRevenue = calcRevenue(allBookingsRev, allPurchasesRev);

                                // Growth %
                                let growthHtml = '<span style="color: var(--text-muted);">No data yet</span>';
                                if (lastRevenue > 0) {
                                    const growth = ((currentRevenue - lastRevenue) / lastRevenue) * 100;
                                    const isPositive = growth >= 0;
                                    const color = isPositive ? '#22c55e' : '#ef4444';
                                    const icon = isPositive ? '↗' : '↘';
                                    growthHtml = `<span style="color: ${color}; font-weight: 500;">${icon} ${Math.abs(growth).toFixed(1)}%</span> <span style="color: var(--text-muted);">vs last month</span>`;
                                } else if (currentRevenue > 0) {
                                    growthHtml = `<span style="color: #22c55e; font-weight: 500;">↗ 100%</span> <span style="color: var(--text-muted);">new growth</span>`;
                                }

                                // AOV (Average Order Value)
                                const totaltransactions = (allBookingsRev?.length || 0) + (allPurchasesRev?.length || 0);
                                const aov = totaltransactions > 0 ? Math.round(totalLifetimeRevenue / totaltransactions) : 0;

                                // Update DOM
                                document.getElementById('totalRevenue').textContent = `₹${Math.round(totalLifetimeRevenue).toLocaleString()}`;
                                document.getElementById('revenueGrowth').innerHTML = growthHtml;

                                document.getElementById('activeBookings').textContent = activeBookingsCount || 0;
                                document.getElementById('completedBookingsCount').textContent = completedBookingsCount || 0;

                                document.getElementById('totalSales').textContent = totalSalesCount || 0;
                                // Sales growth logic similar to revenue if needed, for now simplified

                                document.getElementById('avgOrderValue').textContent = `₹${aov.toLocaleString()}`;

                            } catch (err) {
                                console.error('❌ Failed to load stats:', err);
                            }
                        }

                        async function loadTopProducts() {
                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('product_name, amount');

                                if (error) throw error;

                                // Group by Product
                                const productStats = {};
                                data.forEach(p => {
                                    const name = p.product_name || 'Unknown Product';
                                    if (!productStats[name]) productStats[name] = { count: 0, revenue: 0 };
                                    productStats[name].count++;
                                    productStats[name].revenue += (p.amount || 0);
                                });

                                // Convert to Array & Sort
                                const sortedProducts = Object.entries(productStats)
                                    .map(([name, stats]) => ({ name, ...stats }))
                                    .sort((a, b) => b.revenue - a.revenue)
                                    .slice(0, 5); // Start with top 5

                                const list = document.getElementById('topProductsList');
                                if (sortedProducts.length === 0) {
                                    list.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--text-muted);">No sales data yet.</td></tr>';
                                    return;
                                }

                                list.innerHTML = sortedProducts.map(p => `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <td style="padding: 12px; font-weight: 500;">${p.name}</td>
                                        <td style="padding: 12px; text-align: center;">${p.count}</td>
                                        <td style="padding: 12px; text-align: right; color: #22c55e;">₹${p.revenue.toLocaleString()}</td>
                                    </tr>
                                `).join('');

                            } catch (error) {
                                console.error('Error loading top products:', error);
                            }
                        }

                        async function loadRecentActivity() {
                            try {
                                // Fetch latest 5 bookings and 5 purchases to mix
                                const { data: bookings } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('id, name, service_name, booking_date, created_at, service_price')
                                    .order('created_at', { ascending: false })
                                    .limit(5);

                                const { data: purchases } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('id, product_name, amount, created_at, customer_email') // Assuming customer_email exists
                                    .order('created_at', { ascending: false })
                                    .limit(5);

                                // Combine and Sort
                                const activity = [
                                    ...(bookings || []).map(b => ({ type: 'booking', ...b, date: new Date(b.created_at) })),
                                    ...(purchases || []).map(p => ({ type: 'purchase', ...p, date: new Date(p.created_at) }))
                                ].sort((a, b) => b.date - a.date).slice(0, 10);

                                const feed = document.getElementById('recentActivityFeed');
                                if (activity.length === 0) {
                                    feed.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No recent activity.</div>';
                                    return;
                                }

                                feed.innerHTML = activity.map(item => {
                                    const timeAgo = getTimeAgo(item.date);
                                    if (item.type === 'booking') {
                                        return `
                                            <div style="display: flex; gap: 15px; align-items: center; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                <div style="background: rgba(168, 85, 247, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #a855f7;">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 0.95em;"><strong>${escapeHtml(item.name)}</strong> booked <strong>${escapeHtml(item.service_name || 'Session')}</strong></div>
                                                    <div style="font-size: 0.85em; color: var(--text-muted);">${timeAgo} • ₹${item.service_price}</div>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                             <div style="display: flex; gap: 15px; align-items: center; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                <div style="background: rgba(34, 197, 94, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #22c55e;">
                                                    <i class="fas fa-shopping-cart"></i>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 0.95em;">New purchase of <strong>${escapeHtml(item.product_name)}</strong></div>
                                                    <div style="font-size: 0.85em; color: var(--text-muted);">${timeAgo} • ₹${item.amount}</div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                }).join('');

                            } catch (error) {
                                console.error('Error loading activity:', error);
                            }
                        }

                        function getTimeAgo(date) {
                            const seconds = Math.floor((new Date() - date) / 1000);
                            let interval = seconds / 31536000;
                            if (interval > 1) return Math.floor(interval) + "y ago";
                            interval = seconds / 2592000;
                            if (interval > 1) return Math.floor(interval) + "mo ago";
                            interval = seconds / 86400;
                            if (interval > 1) return Math.floor(interval) + "d ago";
                            interval = seconds / 3600;
                            if (interval > 1) return Math.floor(interval) + "h ago";
                            interval = seconds / 60;
                            if (interval > 1) return Math.floor(interval) + "m ago";
                            return Math.floor(seconds) + "s ago";
                        }

                        async function updateDashboardCharts() {
                            const range = parseInt(document.getElementById('revenueRange').value);
                            const cutoffDate = new Date();
                            cutoffDate.setDate(cutoffDate.getDate() - range);

                            try {
                                // Fetch daily data limited to range
                                const { data: bookings } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('service_price, created_at, service_name')
                                    .gte('created_at', cutoffDate.toISOString())
                                    .in('status', ['confirmed', 'completed', 'pending', 'upcoming']);

                                const { data: purchases } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('amount, created_at, product_name')
                                    .gte('created_at', cutoffDate.toISOString());

                                // Daily Data Aggregation key: YYYY-MM-DD
                                const dailyData = {};
                                const distribution = {};

                                // Initialize all dates in range with 0
                                for (let i = 0; i <= range; i++) {
                                    const d = new Date();
                                    d.setDate(d.getDate() - i);
                                    dailyData[d.toLocaleDateString('en-CA')] = 0;
                                }

                                const aggregate = (items, amountField, nameField) => {
                                    (items || []).forEach(item => {
                                        // Revenue Line
                                        const d = new Date(item.created_at);
                                        const k = d.toLocaleDateString('en-CA');
                                        if (dailyData[k] !== undefined) dailyData[k] += (item[amountField] || 0);

                                        // Distribution Pie
                                        const name = item[nameField] || 'Other';
                                        distribution[name] = (distribution[name] || 0) + 1;
                                    });
                                };

                                aggregate(bookings, 'service_price', 'service_name');
                                aggregate(purchases, 'amount', 'product_name');

                                const labels = Object.keys(dailyData).sort();
                                const values = labels.map(l => Math.round(dailyData[l]));

                                // --- CHART 1: REVENUE ---
                                if (revenueChart) revenueChart.destroy();
                                const ctxRevenue = document.getElementById('revenueChart').getContext('2d');

                                // Create gradient
                                let gradient = ctxRevenue.createLinearGradient(0, 0, 0, 400);
                                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                                revenueChart = new Chart(ctxRevenue, {
                                    type: 'line',
                                    data: {
                                        labels: labels.map(l => {
                                            const [y, m, d] = l.split('-');
                                            return `${d}/${m}`;
                                        }),
                                        datasets: [{
                                            label: 'Revenue (₹)',
                                            data: values,
                                            borderColor: '#6366f1',
                                            backgroundColor: gradient,
                                            borderWidth: 2,
                                            tension: 0.4,
                                            pointRadius: 0,
                                            pointHoverRadius: 6,
                                            fill: true
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                mode: 'index',
                                                intersect: false,
                                                backgroundColor: 'rgba(30, 41, 59, 0.9)',
                                                titleColor: '#e2e8f0',
                                                bodyColor: '#e2e8f0',
                                                borderColor: 'rgba(255,255,255,0.1)',
                                                borderWidth: 1
                                            }
                                        },
                                        interaction: {
                                            mode: 'nearest',
                                            axis: 'x',
                                            intersect: false
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                grid: { color: 'rgba(255,255,255,0.05)' },
                                                ticks: { color: '#94a3b8' }
                                            },
                                            x: {
                                                grid: { display: false },
                                                ticks: { color: '#94a3b8' }
                                            }
                                        }
                                    }
                                });

                                // --- CHART 2: DISTRIBUTION ---
                                if (distributionChart) distributionChart.destroy();
                                const ctxDist = document.getElementById('distributionChart').getContext('2d');

                                // Organize Distribution Data (Top 5 + Others)
                                const sortedDist = Object.entries(distribution).sort((a, b) => b[1] - a[1]);
                                let distLabels = [], distValues = [];

                                if (sortedDist.length > 5) {
                                    distLabels = sortedDist.slice(0, 4).map(x => x[0]);
                                    distValues = sortedDist.slice(0, 4).map(x => x[1]);
                                    const otherSum = sortedDist.slice(4).reduce((sum, x) => sum + x[1], 0);
                                    distLabels.push('Others');
                                    distValues.push(otherSum);
                                } else {
                                    distLabels = sortedDist.map(x => x[0]);
                                    distValues = sortedDist.map(x => x[1]);
                                }

                                distributionChart = new Chart(ctxDist, {
                                    type: 'doughnut',
                                    data: {
                                        labels: distLabels,
                                        datasets: [{
                                            data: distValues,
                                            backgroundColor: [
                                                '#6366f1', '#a855f7', '#ec4899', '#f59e0b', '#10b981', '#64748b'
                                            ],
                                            borderWidth: 0
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                position: 'right',
                                                labels: { color: '#94a3b8', boxWidth: 12, padding: 10, font: { size: 11 } }
                                            }
                                        },
                                        layout: {
                                            padding: { left: 0, right: 0, top: 0, bottom: 0 }
                                        }
                                    }
                                });

                            } catch (err) {
                                console.error('❌ Failed to update charts:', err);
                            }
                        }
                        window.updateDashboardCharts = updateDashboardCharts;
                        // --- BLOG MANAGEMENT LOGIC ---
                        async function loadBlogs() {
                            const list = document.getElementById('blogsList');
                            if (!window.supabaseAdminClient) {
                                list.innerHTML = '<p style="color:red">Supabase Admin Client missing</p>';
                                return;
                            }
                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('blogs')
                                    .select('*')
                                    .order('created_at', { ascending: false });

                                if (error) throw error;
                                if (!data || data.length === 0) {
                                    list.innerHTML = '<p style="text-align:center; color:var(--text-muted)">No articles found.</p>';
                                    return;
                                }
                                list.innerHTML = data.map(b => `
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:1.1em; color:white;">${b.title}</strong>
                            <div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">
                                ${b.is_published ? '<span style="color:#22c55e">● Published</span>' : '<span style="color:#f59e0b">● Draft</span>'}
                                <span style="margin-left:10px;">/${b.slug}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="editBlog('${b.id}')" style="padding:6px 12px; font-size:0.9em;">Edit</button>
                            <button onclick="deleteBlog('${b.id}')" style="padding:6px 12px; font-size:0.9em; background:transparent; border:1px solid #ef4444; color:#ef4444;">Delete</button>
                        </div>
                    </div>
                `).join('');
                            } catch (e) { list.innerHTML = `<p style="color:red">Error: ${e.message}</p>`; }
                        }

                        async function saveBlog(e) {
                            e.preventDefault();
                            const id = document.getElementById('blogId').value;
                            const title = document.getElementById('blogTitle').value;
                            // Auto slug
                            let slug = document.getElementById('blogSlug').value;
                            if (!slug) slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Date.now();

                            const excerpt = document.getElementById('blogExcerpt').value;
                            const content = blogQuill ? blogQuill.root.innerHTML : '';
                            const cover = document.getElementById('blogCover').value;
                            const published = document.getElementById('blogPublished').checked;

                            const payload = { title, slug, excerpt, content, cover_image_url: cover, is_published: published };

                            try {
                                let error;
                                if (id) {
                                    const res = await window.supabaseAdminClient.from('blogs').update(payload).eq('id', id);
                                    error = res.error;
                                } else {
                                    const res = await window.supabaseAdminClient.from('blogs').insert([payload]);
                                    error = res.error;
                                }
                                if (error) throw error;
                                alert('Article saved successfully!');
                                cancelBlogEdit();
                                loadBlogs();
                            } catch (e) { alert('Error: ' + e.message); }
                        }

                        async function editBlog(id) {
                            try {
                                const { data, error } = await window.supabaseAdminClient.from('blogs').select('*').eq('id', id).single();
                                if (error) throw error;

                                document.getElementById('blogId').value = data.id;
                                document.getElementById('blogTitle').value = data.title;
                                document.getElementById('blogSlug').value = data.slug;
                                document.getElementById('blogExcerpt').value = data.excerpt || '';
                                document.getElementById('blogCover').value = data.cover_image_url || '';
                                document.getElementById('blogPublished').checked = data.is_published;
                                if (blogQuill) blogQuill.root.innerHTML = data.content || '';

                                document.getElementById('blogSubmitBtn').textContent = 'Update Article';
                                document.getElementById('blogCancelBtn').style.display = 'inline-block';
                                document.getElementById('blogForm').scrollIntoView({ behavior: 'smooth' });
                            } catch (e) { alert('Error: ' + e.message); }
                        }

                        async function deleteBlog(id) {
                            if (!confirm('Are you sure you want to delete this article?')) return;
                            const { error } = await window.supabaseAdminClient.from('blogs').delete().eq('id', id);
                            if (error) alert('Error: ' + error.message);
                            else loadBlogs();
                        }

                        function cancelBlogEdit() {
                            document.getElementById('blogForm').reset();
                            document.getElementById('blogId').value = '';
                            if (blogQuill) blogQuill.setText('');
                            document.getElementById('blogSubmitBtn').textContent = 'Save Article';
                            document.getElementById('blogCancelBtn').style.display = 'none';
                        }

                        // Export to Window
                        window.loadBlogs = loadBlogs;
                        window.editBlog = editBlog;
                        window.deleteBlog = deleteBlog;
                        window.cancelBlogEdit = cancelBlogEdit;

                        // Export Session Functions
                        // Session Management Functions - GLOBAL SCOPE
                        async function loadSessions() {
                            const list = document.getElementById('sessionsList');

                            if (!window.supabaseAdminClient) {
                                if (list) list.innerHTML = '<p style="color: red">Supabase not initialized</p>';
                                return;
                            }

                            const { data, error } = await window.supabaseAdminClient
                                .from('sessions')
                                .select('*')
                                .order('created_at', { ascending: false });

                            if (error) {
                                if (list) list.innerHTML = `<p style="color: red">Error loading sessions: ${error.message}</p>`;
                                return;
                            }

                            if (!data || data.length === 0) {
                                if (list) list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No sessions found.</p>';
                                return;
                            }

                            if (list) {
                                list.innerHTML = data.map(session => `
                    <div class="session-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); ${!session.is_active ? 'opacity: 0.6;' : ''}">
                        <div>
                            <strong>${session.name}</strong>
                            ${session.is_popular ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">POPULAR</span>' : ''}
                            ${!session.is_active ? '<span style="background: #666; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">INACTIVE</span>' : ''}
                            <br>
                            <span style="color: var(--text-muted);">
                                ${session.duration} min • ₹${session.price}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSession('${session.id}')" style="padding: 8px 16px; font-size: 0.9em; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit</button>
                            <button onclick="deleteSession('${session.id}')" style="padding: 8px 16px; font-size: 0.9em; background: transparent; border: 1px solid #ef4444; color: #ef4444;">Delete</button>
                        </div>
                    </div>
                `).join('');
                            }
                        }

                        // Edit Session
                        async function editSession(id) {
                            const { data, error } = await window.supabaseAdminClient
                                .from('sessions')
                                .select('*')
                                .eq('id', id)
                                .single();

                            if (error) {
                                alert('❌ Error loading session: ' + error.message);
                                return;
                            }

                            document.getElementById('sessionId').value = data.id;
                            document.getElementById('sessionName').value = data.name;
                            document.getElementById('sessionDuration').value = data.duration;
                            document.getElementById('sessionPrice').value = data.price;
                            document.getElementById('sessionDesc').value = data.description || '';
                            document.getElementById('sessionFeatures').value = data.features ? data.features.join('\n') : '';
                            document.getElementById('sessionPopular').checked = data.is_popular;
                            document.getElementById('sessionActive').checked = data.is_active;
                            document.getElementById('sessionSubmitBtn').textContent = 'Update Session';

                            // Scroll to form
                            document.getElementById('sessionForm').scrollIntoView({ behavior: 'smooth' });
                        }

                        // Delete Session
                        async function deleteSession(id) {
                            if (!confirm('⚠️ Are you sure you want to delete this session?')) return;

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('sessions')
                                    .delete()
                                    .eq('id', id);

                                if (error) throw error;

                                alert('✅ Session deleted successfully!');
                                await loadSessions();
                            } catch (error) {
                                alert('❌ Error deleting session: ' + error.message);
                            }
                        }

                        // Init Blog Components
                        const blogEditorEl = document.getElementById('blogContentEditor');
                        if (blogEditorEl) {
                            try {
                                blogQuill = new Quill('#blogContentEditor', {
                                    theme: 'snow',
                                    placeholder: 'Write your article...',
                                    modules: { toolbar: [['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'], [{ 'header': 1 }, { 'header': 2 }], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link', 'image'], ['clean']] }
                                });
                            } catch (e) { console.error('Blog Quill Init Error', e); }
                        }

                        const blogF = document.getElementById('blogForm');
                        if (blogF) blogF.addEventListener('submit', saveBlog);

                        // --- TESTIMONIALS MANAGEMENT ---
                        async function loadPendingTestimonials() {
                            const container = document.getElementById('pendingTestimonialsList');
                            const section = document.getElementById('testimonialsSection');

                            if (!window.supabaseAdminClient) {
                                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Supabase not connected</p>';
                                section.style.display = 'block';
                                return;
                            }

                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('testimonials')
                                    .select('*')
                                    .eq('is_published', false)
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                section.style.display = 'block';

                                if (!data || data.length === 0) {
                                    container.innerHTML = '<p style="color: var(--success); text-align: center; padding: 30px;"><i class="fas fa-check-circle"></i> No pending reviews. All caught up!</p>';
                                    return;
                                }

                                container.innerHTML = '<div style="display: grid; gap: 20px;">';

                                data.forEach(t => {
                                    const date = new Date(t.created_at).toLocaleString();
                                    container.innerHTML += `
                        <div style="background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="font-size: 1.1rem;">${escapeHtml(t.name)}</strong>
                                    <span style="color: var(--text-muted); margin-left: 10px;">${'★'.repeat(t.rating)}</span>
                                </div>
                                <span style="font-size: 0.85rem; color: var(--text-muted);">${date}</span>
                            </div>
                            <h4 style="margin: 0 0 10px 0; color: var(--accent);">${escapeHtml(t.title)}</h4>
                            <p style="margin: 0 0 15px 0; color: var(--text-secondary); line-height: 1.6;">"${escapeHtml(t.review)}"</p>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="approveTestimonial(${t.id})" class="btn btn-primary" style="padding: 8px 20px; font-size: 0.9rem;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button onclick="rejectTestimonial(${t.id})" class="btn" style="padding: 8px 20px; font-size: 0.9rem; background: transparent; border: 1px solid var(--danger); color: var(--danger);">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    `;
                                });

                                container.innerHTML += '</div>';

                            } catch (e) {
                                console.error('Error loading testimonials:', e);
                                container.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading reviews: ' + e.message + '</p>';
                            }
                        }

                        async function approveTestimonial(id) {
                            if (!confirm('Approve this review? It will be visible on the website.')) return;

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('testimonials')
                                    .update({ is_published: true, is_verified: true })
                                    .eq('id', id);

                                if (error) throw error;

                                alert('Review approved successfully!');
                                loadPendingTestimonials();
                            } catch (e) {
                                alert('Error: ' + e.message);
                            }
                        }

                        async function rejectTestimonial(id) {
                            if (!confirm('Reject and delete this review?')) return;

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('testimonials')
                                    .delete()
                                    .eq('id', id);

                                if (error) throw error;

                                alert('Review rejected and deleted.');
                                loadPendingTestimonials();
                            } catch (e) {
                                alert('Error: ' + e.message);
                            }
                        }

                        function escapeHtml(text) {
                            if (!text) return '';
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        }

                        // ================================
                        // Availability Management (Global)
                        // ================================
                        async function loadAvailability() {
                            const tbody = document.getElementById('availabilityTableBody');
                            if (!window.supabaseAdminClient) {
                                console.warn('Supabase client not ready for availability');
                                return;
                            }

                            try {
                                // Get existing patterns
                                let { data: patterns, error } = await window.supabaseAdminClient
                                    .from('availability_patterns')
                                    .select('*')
                                    .order('id', { ascending: true });

                                if (error) {
                                    if (error.code === '42P01') {
                                        throw new Error('Table "availability_patterns" does not exist. Please run the SQL script.');
                                    }
                                    throw error;
                                }

                                // Define default text days if DB is empty or partial
                                const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                                // Map or Create defaults
                                const displayPatterns = DAYS.map(day => {
                                    const existing = patterns?.find(p => p.day_of_week === day);
                                    return existing || {
                                        day_of_week: day,
                                        is_active: (day !== 'Sunday'),
                                        start_time: '10:00:00',
                                        end_time: '18:00:00'
                                    };
                                });

                                tbody.innerHTML = displayPatterns.map(p => `
                    <tr data-day="${p.day_of_week}">
                        <td style="font-weight: 500;">${p.day_of_week}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" class="avail-active" ${p.is_active ? 'checked' : ''} style="transform: scale(1.2); cursor: pointer;">
                        </td>
                        <td>
                            <input type="time" class="avail-start" value="${p.start_time.substring(0, 5)}" style="padding: 6px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                        </td>
                        <td>
                            <input type="time" class="avail-end" value="${p.end_time.substring(0, 5)}" style="padding: 6px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                        </td>
                    </tr>
                `).join('');

                            } catch (err) {
                                console.error('Error loading availability:', err);
                                tbody.innerHTML = `<tr><td colspan="4" style="color:var(--danger); text-align:center;">Error: ${err.message}</td></tr>`;
                            }
                        }

                        async function saveAvailability() {
                            if (!window.supabaseAdminClient) {
                                alert('Supabase not initialized');
                                return;
                            }

                            const btn = document.querySelector('button[onclick="saveAvailability()"]');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                            btn.disabled = true;

                            const rows = document.querySelectorAll('#availabilityTableBody tr');
                            const updates = [];

                            rows.forEach(row => {
                                const day = row.dataset.day;
                                if (!day) return;

                                const isActive = row.querySelector('.avail-active').checked;
                                const start = row.querySelector('.avail-start').value;
                                const end = row.querySelector('.avail-end').value;

                                updates.push({
                                    day_of_week: day,
                                    is_active: isActive,
                                    start_time: start,
                                    end_time: end
                                });
                            });

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('availability_patterns')
                                    .upsert(updates, { onConflict: 'day_of_week' });

                                if (error) throw error;
                                alert('✅ Availability schedule saved!');
                            } catch (err) {
                                console.error('Error saving schedule:', err);
                                alert('❌ Failed to save: ' + err.message);
                            } finally {
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }
                        }

                        // ================================
                        // Blocked Dates Management
                        // ================================
                        async function loadBlockedDates() {
                            const container = document.getElementById('blockedDatesList');
                            if (!window.supabaseAdminClient) return;

                            try {
                                const { data, error } = await window.supabaseAdminClient
                                    .from('blocked_date_ranges')
                                    .select('*')
                                    .order('start_date', { ascending: true });

                                if (error) throw error;

                                if (!data || data.length === 0) {
                                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No blocked dates currently set.</p>';
                                    return;
                                }

                                container.innerHTML = `
                                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 0.85em;">
                                                <th style="padding: 10px; text-align: left;">Start Date</th>
                                                <th style="padding: 10px; text-align: left;">End Date</th>
                                                <th style="padding: 10px; text-align: right;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.map(range => `
                                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                    <td style="padding: 10px;">${range.start_date}</td>
                                                    <td style="padding: 10px;">${range.end_date}</td>
                                                    <td style="padding: 10px; text-align: right;">
                                                        <button onclick="deleteBlockedDate('${range.id}')" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 4px 8px; font-size: 0.8em;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `;
                            } catch (err) {
                                console.error('Error loading blocked dates:', err);
                                container.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${err.message}</p>`;
                            }
                        }

                        async function addBlockedDate() {
                            const start = document.getElementById('blockStartDate').value;
                            const end = document.getElementById('blockEndDate').value;

                            if (!start || !end) {
                                alert('Please select both start and end dates.');
                                return;
                            }

                            if (new Date(start) > new Date(end)) {
                                alert('Start date cannot be after end date.');
                                return;
                            }

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('blocked_date_ranges')
                                    .insert([{ start_date: start, end_date: end }]);

                                if (error) throw error;

                                alert('✅ Date range blocked successfully!');
                                document.getElementById('blockStartDate').value = '';
                                document.getElementById('blockEndDate').value = '';
                                loadBlockedDates();
                            } catch (err) {
                                alert('❌ Error: ' + err.message);
                            }
                        }

                        async function deleteBlockedDate(id) {
                            if (!confirm('Are you sure you want to remove this block?')) return;

                            try {
                                const { error } = await window.supabaseAdminClient
                                    .from('blocked_date_ranges')
                                    .delete()
                                    .eq('id', id);

                                if (error) throw error;

                                loadBlockedDates();
                            } catch (err) {
                                alert('❌ Error: ' + err.message);
                            }
                        }

                        // Export functions globally
                        window.loadAvailability = loadAvailability;
                        window.saveAvailability = saveAvailability;
                        window.loadBlockedDates = loadBlockedDates;
                        window.addBlockedDate = addBlockedDate;
                        window.deleteBlockedDate = deleteBlockedDate;
                        window.loadPendingTestimonials = loadPendingTestimonials;
                        window.approveTestimonial = approveTestimonial;
                        window.rejectTestimonial = rejectTestimonial;

                        // ================================
                        // All Bookings Management
                        // ================================
                        let currentBookingFilter = 'all';

                        async function loadBookings(filter = 'all') {
                            currentBookingFilter = filter;

                            // Update UI buttons
                            document.querySelectorAll('.filter-tabs button').forEach(btn => {
                                btn.style.background = 'transparent';
                                btn.classList.remove('active');
                            });
                            const activeBtn = document.getElementById(`btn-filter-${filter}`);
                            if (activeBtn) {
                                activeBtn.style.background = 'var(--surface)';
                                activeBtn.classList.add('active');
                            }

                            const tbody = document.getElementById('allBookingsList');
                            if (!tbody) return;

                            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>';

                            if (!window.supabaseAdminClient) {
                                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Supabase Admin Client not ready</td></tr>';
                                return;
                            }

                            try {
                                let query = window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .order('booking_date', { ascending: false })
                                    .order('booking_time', { ascending: false });

                                // Execute Query
                                const { data, error } = await query;

                                console.log('📚 Raw bookings data:', { data, error });

                                if (error) {
                                    console.error('Supabase Error:', error);
                                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Supabase Error: ${error.message}</td></tr>`;
                                    return;
                                }

                                if (!data || data.length === 0) {
                                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No bookings found.</td></tr>';
                                    return;
                                }

                                // Filter Logic using JavaScript
                                let filteredData = data;
                                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                                if (filter === 'upcoming') {
                                    // Filter: status != completed AND != cancelled
                                    // Show ALL active bookings regardless of date (so past confirmed sessions appear)
                                    filteredData = data.filter(b => {
                                        return (b.status !== 'completed' && b.status !== 'cancelled');
                                    });
                                } else if (filter === 'completed') {
                                    filteredData = data.filter(b => b.status === 'completed');
                                } else if (filter === 'cancelled') {
                                    filteredData = data.filter(b => b.status === 'cancelled');
                                }

                                console.log(`📚 Filtered data for '${filter}':`, filteredData);

                                if (filteredData.length === 0) {
                                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No <strong>${filter}</strong> bookings found.<br><small>(Raw: ${data.length}, Filtered: 0)</small></td></tr>`;
                                    return;
                                }

                                tbody.innerHTML = filteredData.map(b => {
                                    // Format Date
                                    const dateObj = new Date(b.booking_date);
                                    const formattedDate = dateObj.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });

                                    // Format Booking Time (e.g. 14:00:00 -> 02:00 PM)
                                    let formattedTime = b.booking_time;
                                    if (b.booking_time && b.booking_time.includes(':')) {
                                        const [h, m] = b.booking_time.split(':');
                                        const d = new Date();
                                        d.setHours(h, m);
                                        formattedTime = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                    }

                                    // Status Color
                                    let statusColor = '#94a3b8'; // gray
                                    if (b.status === 'confirmed') statusColor = '#22c55e'; // green
                                    if (b.status === 'pending') statusColor = '#f59e0b'; // orange
                                    if (b.status === 'cancelled') statusColor = '#ef4444'; // red
                                    if (b.status === 'completed') statusColor = '#3b82f6'; // blue
                                    if (b.status === 'upcoming' || b.status === 'Upcoming') statusColor = '#0ea5e9'; // light blue

                                    const isActionable = b.status === 'confirmed' || b.status === 'pending' || b.status === 'upcoming' || b.status === 'Upcoming';
                                    const meetLink = b.meet_link || '#';

                                    return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 12px;">
                                <div style="font-weight: 500;">${formattedDate}</div>
                                <div style="font-size: 0.85em; color: var(--text-muted);">${formattedTime} IST</div>
                            </td>
                            <td style="padding: 12px;">
                                <div style="font-weight: 500;">${escapeHtml(b.name)}</div>
                                <div style="font-size: 0.85em; color: var(--text-muted);">${escapeHtml(b.email)}</div>
                            </td>
                            <td style="padding: 12px;">
                                <div>${escapeHtml(b.service_name)}</div>
                                <div style="font-size: 0.85em; color: var(--text-muted);">₹${b.service_price}</div>
                            </td>
                            <td style="padding: 12px;">
                                <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; text-transform: capitalize;">
                                    ${b.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: right;">
                                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                    ${meetLink !== '#' ? `<a href="${meetLink}" target="_blank" title="Join Meeting" style="color:white; padding:6px; background:#6366f1; border-radius:4px;"><i class="fas fa-video"></i></a>` : ''}
                                    ${isActionable ?
                                            `<button onclick="adminInitiateReschedule('${b.id}')" title="Reschedule Session" style="padding:6px 10px; background:rgba(168, 85, 247, 0.2); color:#a855f7; border:none; border-radius:4px; cursor:pointer;"><i class="fas fa-calendar-alt"></i></button>
                                             <button onclick="manualSendReminder('${b.id}')" title="Send Reminder" style="padding:6px 10px; background:rgba(245, 158, 11, 0.2); color:#f59e0b; border:none; border-radius:4px; cursor:pointer;"><i class="fas fa-bell"></i></button>
                                         <button onclick="updateBookingStatus('${b.id}', 'completed')" title="Mark Completed" style="padding:6px 10px; background:rgba(34, 197, 94, 0.2); color:#22c55e; border:none; border-radius:4px; cursor:pointer;"><i class="fas fa-check"></i></button>
                                         <button onclick="updateBookingStatus('${b.id}', 'cancelled')" title="Cancel" style="padding:6px 10px; background:rgba(239, 68, 68, 0.2); color:#ef4444; border:none; border-radius:4px; cursor:pointer;"><i class="fas fa-times"></i></button>`
                                            :
                                            `<button disabled style="opacity:0.3; background:transparent; border:none; color:white;"><i class="fas fa-ban"></i></button>`
                                        }
                                </div>
                            </td>
                        </tr>
                    `;
                                }).join('');

                            } catch (err) {
                                console.error('Error loading bookings:', err);
                                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error: ${err.message}</td></tr>`;
                            }
                        }

                        async function updateBookingStatus(id, newStatus) {
                            if (!confirm(`Are you sure you want to mark this booking as ${newStatus}?`)) return;

                            try {
                                // Fetch booking details first if completing, to get email/name
                                let bookingDetails = null;
                                if (newStatus === 'completed') {
                                    const { data, error } = await window.supabaseAdminClient
                                        .from('bookings')
                                        .select('email, name, service_name') // Correct column names verified from SQL
                                        .eq('id', id)
                                        .single();
                                    if (!error) bookingDetails = data;
                                }

                                const { error } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({ status: newStatus })
                                    .eq('id', id);

                                if (error) throw error;

                                // Send Email if Completed
                                if (newStatus === 'completed' && bookingDetails) {
                                    if (window.sendTestimonialRequestEmail) {
                                        const sent = await window.sendTestimonialRequestEmail(bookingDetails);
                                        if (sent) alert(`✅ Status: Completed.\n📧 Testimonial email sent to ${bookingDetails.email}`);
                                        else alert('✅ Status: Completed.\n⚠️ Email failed to send (check console).');
                                    } else {
                                        console.warn('sendTestimonialRequestEmail function missing');
                                        alert('✅ Status Updated (Email function missing)');
                                    }
                                } else {
                                    alert(`✅ Booking marked as ${newStatus}!`);
                                }

                                loadBookings(currentBookingFilter);
                                // Also update stats
                                updateDashboardStats();
                            } catch (err) {
                                alert('Error updating status: ' + err.message);
                            }
                        }

                        // Export
                        window.loadBookings = loadBookings;
                        window.updateBookingStatus = updateBookingStatus;
                        // Testimonials
                        window.loadPendingTestimonials = loadPendingTestimonials;
                        window.approveTestimonial = approveTestimonial;
                        window.rejectTestimonial = rejectTestimonial;

                        // Session Management
                        window.editSession = editSession;
                        window.deleteSession = deleteSession;

                        // Cancellation & Refunds
                        window.loadCancellationRequests = loadCancellationRequests;
                        window.approveRefund = approveRefund;
                        window.rejectCancellation = rejectCancellation;
                        window.submitAlternative = submitAlternative;
                        window.closeAlternativeModal = closeAlternativeModal;

                        // Misc
                        window.logout = logout;
                        if (typeof cropImage !== 'undefined') window.cropImage = cropImage;
                        if (typeof closeCropperModal !== 'undefined') window.closeCropperModal = closeCropperModal;




                        // ================================
                        // Automated Reminder System (Polling)
                        // ================================
                        async function checkAndSendReminders() {
                            if (!window.supabaseAdminClient) return;

                            console.log('⏰ Checking for due reminders...');

                            try {
                                // Fetch confirmed bookings that haven't finished yet
                                // "upcoming" or "confirmed" status
                                // Filter by date >= today to optimize
                                const today = new Date().toISOString().split('T')[0];

                                const { data: bookings, error } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('*')
                                    .eq('status', 'confirmed')
                                    .gte('booking_date', today); // Only future/today bookings

                                if (error) throw error;
                                if (!bookings || bookings.length === 0) return;

                                const now = new Date();

                                for (const b of bookings) {
                                    // Construct Session Start Date Object
                                    // booking_date is YYYY-MM-DD, booking_time is HH:MM:SS
                                    const sessionStart = new Date(`${b.booking_date}T${b.booking_time}`);
                                    const timeDiff = sessionStart - now; // Milliseconds
                                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                                    const minutesDiff = timeDiff / (1000 * 60);

                                    // 1. 24-Hour Reminder (Between 23.5 and 25 hours)
                                    if (hoursDiff >= 23.5 && hoursDiff <= 25 && !b.reminder_24h_sent) {
                                        await sendReminder(b, '24h');
                                    }

                                    // 2. 10-Minute Reminder (Between 0 and 15 minutes)
                                    else if (minutesDiff > 0 && minutesDiff <= 15 && !b.reminder_10m_sent) {
                                        await sendReminder(b, '10m');
                                    }
                                }

                            } catch (err) {
                                console.error('Reminder Check Error:', err);
                            }
                        }

                        async function sendReminder(booking, type) {
                            console.log(`📧 Sending ${type} reminder for ${booking.email}`);

                            const meetLink = booking.meet_link || '#';
                            const userName = booking.name || 'Learner';
                            let subject, userBody, adminBody;

                            if (type === '24h') {
                                subject = `Reminder: Session Tomorrow - ${booking.service_name}`;
                                userBody = `
                                    <p>Hi ${userName},</p>
                                    <p>This is a friendly reminder that you have a session scheduled for tomorrow.</p>
                                    <p><strong>Topic:</strong> ${booking.service_name}</p>
                                    <p><strong>Time:</strong> ${booking.booking_time} IST</p>
                                    <p>See you there! 🚀</p>
                                    <br>
                                    <p>Best,<br>QuantMentor</p>
                                `;
                                adminBody = `24h Reminder sent to ${booking.email} for ${booking.service_name}`;
                            } else {
                                subject = `Starting Soon: Your Session in 10 Minutes! ⏰`;
                                userBody = `
                                    <p>Hi ${userName},</p>
                                    <p>Your session starts in about 10 minutes.</p>
                                    <p><strong>Join Here:</strong> <a href="${meetLink}">${meetLink}</a></p>
                                    <p>Please be ready with your questions.</p>
                                    <br>
                                    <p>Best,<br>QuantMentor</p>
                                `;
                                adminBody = `10m Urgent Reminder sent to ${booking.email}. Link: ${meetLink}`;
                            }

                            // 1. Send to User
                            await sendEmailWithBrevo(booking.email, subject, userBody, userBody.replace(/<[^>]*>?/gm, ''));

                            // 2. Send to Admin (Notification)
                            // Re-using sendEmailWithBrevo to alert admin as well
                            const adminEmail = 'jha.8@alumni.iitj.ac.in';
                            await sendEmailWithBrevo(adminEmail, `Admin Alert: ${type} Reminder Sent`, `<p>${adminBody}</p>`, adminBody);

                            // 3. Update Database
                            const updateField = (type === '24h') ? { reminder_24h_sent: true } : { reminder_10m_sent: true };

                            await window.supabaseAdminClient
                                .from('bookings')
                                .update(updateField)
                                .eq('id', booking.id);

                            console.log(`✅ ${type} reminder process complete for ${booking.id}`);
                        }

                        // Manual Trigger for Reminders
                        async function manualSendReminder(bookingId) {
                            if (!window.supabaseAdminClient) return;

                            // 1. Fetch Booking
                            const { data: booking, error } = await window.supabaseAdminClient
                                .from('bookings')
                                .select('*')
                                .eq('id', bookingId)
                                .single();

                            if (error || !booking) {
                                alert('Error fetching booking details.');
                                return;
                            }

                            // 2. Calculate Context (Smart Auto-Detect)
                            const sessionStart = new Date(`${booking.booking_date}T${booking.booking_time}`);
                            const now = new Date();
                            const diffMs = sessionStart - now;
                            // Convert to hours (can be negative if in progress)
                            const diffHours = diffMs / (1000 * 60 * 60);

                            let type = '24h';
                            let contextMsg = 'Session is Tomorrow/Later';

                            // If less than 2 hours remaining, switch to Urgent/Meeting Link template
                            if (diffHours <= 2) {
                                type = '10m'; // Urgent template
                                contextMsg = 'Session is Starting Soon (< 2h)';
                            }

                            // 3. Confirm with Admin
                            const proceed = confirm(
                                `Send Reminder for ${booking.name}?\n\n` +
                                `📅 Session Time: ${sessionStart.toLocaleString()}\n` +
                                `🤖 Auto-Detected Context: ${contextMsg}\n` +
                                `📧 Email Template: ${type === '24h' ? 'Standard Reminder' : 'Urgent/Joining Link'}\n\n` +
                                `Click OK to send.`
                            );

                            if (proceed) {
                                await sendReminder(booking, type);
                                alert(`✅ ${type === '24h' ? 'Standard' : 'Urgent'} Reminder Sent!`);
                            }
                        }

                        // Export Manual Trigger
                        window.manualSendReminder = manualSendReminder;

                        // ====================================================
                        // Admin-Initiated Reschedule
                        // ====================================================
                        async function adminInitiateReschedule(bookingId) {
                            if (!window.supabaseAdminClient) {
                                alert('❌ Admin not authenticated.');
                                return;
                            }

                            // 1. Fetch Booking Details
                            const { data: booking, error } = await window.supabaseAdminClient
                                .from('bookings')
                                .select('*')
                                .eq('id', bookingId)
                                .single();

                            if (error || !booking) {
                                alert('❌ Error fetching booking details.');
                                console.error(error);
                                return;
                            }

                            // 2. Prompt for new date/time using native prompts (simple approach)
                            const proposedDate = prompt(
                                `📅 Reschedule Session for ${booking.name}\n\n` +
                                `Current: ${booking.booking_date} at ${booking.booking_time}\n\n` +
                                `Enter PROPOSED NEW DATE (YYYY-MM-DD):`,
                                new Date(Date.now() + 86400000).toISOString().split('T')[0] // Default: tomorrow
                            );

                            if (!proposedDate) return; // Cancelled

                            const proposedTime = prompt(
                                `Enter PROPOSED NEW TIME:\n\n` +
                                `Examples: 10:00 AM, 2:30 PM, 5:00 PM`,
                                '10:00 AM'
                            );

                            if (!proposedTime) return; // Cancelled

                            const reason = prompt(
                                `(Optional) Reason for rescheduling:\n\n` +
                                `This will be shown to the customer.`,
                                ''
                            );

                            // 3. Confirm with admin
                            const confirmMsg = `📆 CONFIRM RESCHEDULE REQUEST\n\n` +
                                `Customer: ${booking.name} (${booking.email})\n` +
                                `Service: ${booking.service_name}\n\n` +
                                `FROM: ${booking.booking_date} at ${booking.booking_time}\n` +
                                `TO: ${proposedDate} at ${proposedTime}\n` +
                                `${reason ? 'Reason: ' + reason : ''}\n\n` +
                                `This will send an email to the customer asking them to accept or suggest a different time.\n\n` +
                                `Proceed?`;

                            if (!confirm(confirmMsg)) return;

                            try {
                                // 4. Update booking in database
                                const { error: updateError } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .update({
                                        admin_proposed_date: proposedDate,
                                        admin_proposed_time: proposedTime,
                                        admin_reschedule_reason: reason || null,
                                        admin_reschedule_requested_at: new Date().toISOString(),
                                        status: 'admin_reschedule_pending',
                                        customer_response: null // Reset any previous response
                                    })
                                    .eq('id', bookingId);

                                if (updateError) {
                                    console.error('❌ Database update failed:', updateError);
                                    throw updateError;
                                }

                                // 5. Send email to customer
                                const myBookingsLink = window.location.origin + '/my-bookings.html';

                                const htmlContent = `
                                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                                        <h2 style="color: #a855f7;">📅 Session Reschedule Request</h2>
                                        <p>Dear ${booking.name},</p>
                                        <p>We need to reschedule your upcoming session. Please review the proposed new time below.</p>
                                        
                                        <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                            <h3 style="margin-top: 0;">Original Schedule</h3>
                                            <p>📆 Date: <strong>${booking.booking_date}</strong></p>
                                            <p>🕐 Time: <strong>${booking.booking_time}</strong></p>
                                        </div>

                                        <div style="background: #ede9fe; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #a855f7;">
                                            <h3 style="margin-top: 0; color: #7c3aed;">Proposed New Schedule</h3>
                                            <p>📆 Date: <strong>${proposedDate}</strong></p>
                                            <p>🕐 Time: <strong>${proposedTime}</strong></p>
                                            ${reason ? `<p>📝 Reason: ${reason}</p>` : ''}
                                        </div>

                                        <p>Please visit your bookings page to respond:</p>
                                        <a href="${myBookingsLink}" style="display: inline-block; background: linear-gradient(135deg, #6366f1, #a855f7); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px 0;">View My Bookings</a>

                                        <p style="margin-top: 20px;">You can either:</p>
                                        <ul>
                                            <li>✅ <strong>Accept</strong> the proposed new time</li>
                                            <li>📅 <strong>Suggest</strong> a different time that works for you</li>
                                        </ul>

                                        <p style="color: #6b7280; margin-top: 30px;">Best regards,<br>QuantMentor</p>
                                    </div>
                                `;

                                const textContent = `
Session Reschedule Request

Dear ${booking.name},

We need to reschedule your upcoming session.

ORIGINAL SCHEDULE:
- Date: ${booking.booking_date}
- Time: ${booking.booking_time}

PROPOSED NEW SCHEDULE:
- Date: ${proposedDate}
- Time: ${proposedTime}
${reason ? '- Reason: ' + reason : ''}

Please visit your bookings page to respond: ${myBookingsLink}

You can either:
- Accept the proposed new time
- Suggest a different time that works for you

Best regards,
QuantMentor
                                `;

                                await sendEmailWithBrevo(
                                    booking.email,
                                    `Session Reschedule Request - ${booking.service_name}`,
                                    htmlContent,
                                    textContent
                                );

                                alert(`✅ Reschedule request sent to ${booking.email}!\n\nThe customer will receive an email to accept or suggest a different time.`);

                                // Refresh bookings list
                                if (typeof loadAllBookings === 'function') {
                                    loadAllBookings();
                                }

                            } catch (err) {
                                console.error('❌ Error initiating reschedule:', err);
                                alert('❌ Error sending reschedule request. Please try again.');
                            }
                        }

                        // Export function to window
                        window.adminInitiateReschedule = adminInitiateReschedule;

                        // Initialize Polling
                        // Run once on load, then every 60 seconds
                        setTimeout(checkAndSendReminders, 5000); // 5s delay on start
                        setInterval(checkAndSendReminders, 60 * 1000); // Every 60 seconds

                        // ====================================================
                        // CLIENT MANAGEMENT & EXPORTS
                        // ====================================================

                        async function loadClients() {
                            const list = document.getElementById('clientListBody');
                            if (!list) return;

                            try {
                                // Fetch all bookings and purchases
                                const { data: bookings } = await window.supabaseAdminClient
                                    .from('bookings')
                                    .select('email, name, service_price, created_at, status');

                                const { data: purchases } = await window.supabaseAdminClient
                                    .from('purchases')
                                    .select('customer_email, amount, created_at');

                                const clients = {};

                                // Process Bookings
                                (bookings || []).forEach(b => {
                                    const email = b.email ? b.email.toLowerCase().trim() : 'unknown';
                                    if (email === 'unknown') return;

                                    if (!clients[email]) clients[email] = {
                                        email,
                                        name: b.name || 'Unknown',
                                        type: 'Student',
                                        orders: 0,
                                        spend: 0,
                                        lastActive: new Date(0)
                                    };

                                    clients[email].orders++;
                                    // Only count confirmed/completed spend
                                    if (['confirmed', 'completed'].includes(b.status)) {
                                        clients[email].spend += (b.service_price || 0);
                                    }

                                    const date = new Date(b.created_at);
                                    if (date > clients[email].lastActive) clients[email].lastActive = date;
                                });

                                // Process Purchases (Merge)
                                (purchases || []).forEach(p => {
                                    const email = p.customer_email ? p.customer_email.toLowerCase().trim() : 'unknown';
                                    if (email === 'unknown') return;

                                    if (!clients[email]) {
                                        clients[email] = {
                                            email,
                                            name: 'Buyer', // Purchases might not have names
                                            type: 'Buyer',
                                            orders: 0,
                                            spend: 0,
                                            lastActive: new Date(0)
                                        };
                                    } else {
                                        clients[email].type = 'Both'; // Existing client bought something
                                    }

                                    clients[email].orders++;
                                    clients[email].spend += (p.amount || 0);

                                    const date = new Date(p.created_at);
                                    if (date > clients[email].lastActive) clients[email].lastActive = date;
                                });

                                // Convert to Array, Sort by Spend
                                const clientArray = Object.values(clients).sort((a, b) => b.spend - a.spend);

                                if (clientArray.length === 0) {
                                    list.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No clients found.</td></tr>';
                                    return;
                                }

                                list.innerHTML = clientArray.slice(0, 50).map(c => `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <td style="padding: 12px;">
                                            <div style="font-weight: 500;">${c.name}</div>
                                            <div style="font-size: 0.85em; color: var(--text-muted);">${c.email}</div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                                ${c.type}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">${c.orders}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: 600;">₹${c.spend.toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 0.9em;">
                                            ${c.lastActive.toLocaleDateString()}
                                        </td>
                                    </tr>
                                `).join('');

                                // Store for export
                                window.allClientsData = clientArray;

                            } catch (e) {
                                console.error('Error loading clients:', e);
                                list.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Error: ${e.message}</td></tr>`;
                            }
                        }

                        // Export Helper (DEPRECATED: Use exportToCSVFixed)
                        function exportToCSV(data, filename) {
                            if (!data || !data.length) {
                                alert('No data to export');
                                return;
                            }

                            const separator = ',';
                            const keys = Object.keys(data[0]);
                            const csvContent =
                                keys.join(separator) +
                                '\\n' +
                                data.map(row => {
                                    return keys.map(k => {
                                        let cell = row[k] === null || row[k] === undefined ? '' : row[k];
                                        cell = cell instanceof Date ? cell.toISOString() : cell.toString();
                                        cell = cell.replace(/"/g, '""');
                                        if (cell.search(/("|,|\\n)/g) >= 0) {
                                            cell = `"${cell}"`;
                                        }
                                        return cell;
                                    }).join(separator);
                                }).join('\\n');

                            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            if (link.download !== undefined) {
                                const url = URL.createObjectURL(blob);
                                link.setAttribute('href', url);
                                link.setAttribute('download', filename);
                                link.style.visibility = 'hidden';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                        }

                        async function downloadClients() {
                            if (!window.allClientsData) {
                                await loadClients();
                            }
                            // Format for CSV
                            const data = window.allClientsData.map(c => ({
                                Name: c.name,
                                Email: c.email,
                                Type: c.type,
                                TotalOrders: c.orders,
                                TotalSpend: c.spend,
                                LastActive: c.lastActive.toISOString()
                            }));
                            exportToCSVFixed(data, `clients_export_${new Date().toISOString().slice(0, 10)}.csv`);
                        }

                        async function downloadBookings() {
                            const { data, error } = await window.supabaseAdminClient
                                .from('bookings')
                                .select('*')
                                .order('created_at', { ascending: false });

                            if (error) { alert('Error fetching bookings'); return; }
                            exportToCSVFixed(data, `bookings_export_${new Date().toISOString().slice(0, 10)}.csv`);
                        }

                        async function downloadPurchases() {
                            const { data, error } = await window.supabaseAdminClient
                                .from('purchases')
                                .select('*')
                                .order('created_at', { ascending: false });

                            if (error) { alert('Error fetching purchases'); return; }
                            exportToCSVFixed(data, `purchases_export_${new Date().toISOString().slice(0, 10)}.csv`);
                        }

                        // Make global
                        window.loadClients = loadClients;
                        window.downloadClients = downloadClients;
                        window.downloadBookings = downloadBookings;
                        window.downloadPurchases = downloadPurchases;


                        // FIXED Export Helper (CRLF + BOM)
                        function exportToCSVFixed(data, filename) {
                            if (!data || !data.length) {
                                alert('No data to export');
                                return;
                            }

                            const separator = ',';
                            const keys = Object.keys(data[0]);
                            const csvContent =
                                keys.join(separator) +
                                '\r\n' +
                                data.map(row => {
                                    return keys.map(k => {
                                        let cell = row[k] === null || row[k] === undefined ? '' : row[k];
                                        cell = cell instanceof Date ? cell.toISOString() : cell.toString();
                                        cell = cell.replace(/"/g, '""');
                                        if (cell.search(/("|,|\n|\r)/g) >= 0) {
                                            cell = `"${cell}"`;
                                        }
                                        return cell;
                                    }).join(separator);
                                }).join('\r\n');

                            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement('a');
                            if (link.download !== undefined) {
                                const url = URL.createObjectURL(blob);
                                link.setAttribute('href', url);
                                link.setAttribute('download', filename);
                                link.style.visibility = 'hidden';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                        }

                    </script>
</body>

</html>
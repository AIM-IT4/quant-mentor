<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Interview | QuantMentor</title>
    <link rel="canonical" href="https://quantmentor.vercel.app/interview.html">
    <meta name="description"
        content="Practice quant interviews with an AI interviewer ‚Äî realistic questions, real-time feedback, and performance scorecard.">
    <link rel="icon" type="image/png" href="assets/images/quantmentor-logo-icon-QM-1024.png">
    <link rel="apple-touch-icon" href="assets/images/quantmentor-logo-icon-QM-1024.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-input: #242938;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #14b8a6;
            --accent-hover: #0d9488;
            --accent-glow: rgba(20, 184, 166, 0.15);
            --user-bubble: #1e3a5f;
            --ai-bubble: #1a2332;
            --border: rgba(255, 255, 255, 0.08);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            animation: pageFadeIn 0.6s ease-out;
        }

        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‚îÄ‚îÄ Navbar ‚îÄ‚îÄ */
        .navbar {
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar a.logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.1em;
        }

        .navbar .logo-img {
            height: 32px;
            width: auto;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .timer-badge {
            display: none;
            align-items: center;
            gap: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .timer-badge.active {
            display: flex;
        }

        .timer-badge.warning {
            border-color: var(--warning);
            color: var(--warning);
        }

        .timer-badge.danger {
            border-color: var(--danger);
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.6
            }
        }

        .btn-end {
            display: none;
            padding: 6px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .btn-end:hover {
            opacity: 0.85;
        }

        .btn-end.active {
            display: inline-block;
        }

        /* ‚îÄ‚îÄ Setup Screen ‚îÄ‚îÄ */
        .setup-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            position: relative;
            overflow: hidden;
        }

        .setup-screen .particles-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .setup-wrapper {
            position: relative;
            z-index: 1;
            max-width: 580px;
            width: 100%;
        }

        .setup-hero {
            text-align: center;
            margin-bottom: 32px;
        }

        .setup-hero h1 {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .setup-hero h1 .gradient-text {
            background: linear-gradient(135deg, var(--accent), #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .setup-hero p {
            color: var(--text-secondary);
            font-size: 1.05em;
            max-width: 460px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .trust-badges span {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .trust-badges i {
            color: var(--accent);
        }

        .setup-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        /* Animated gradient border glow */
        .setup-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 21px;
            background: linear-gradient(135deg, var(--accent), #818cf8, #f472b6, var(--accent));
            background-size: 300% 300%;
            animation: borderGlow 6s ease-in-out infinite;
            z-index: -1;
            opacity: 0.5;
        }

        @keyframes borderGlow {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .setup-card h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent), #818cf8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: none;
            /* Hidden - hero replaces this */
        }

        .setup-card .subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 0.95em;
            display: none;
            /* Hidden - hero replaces this */
        }

        /* Staggered form group entry */
        .setup-card .form-group {
            animation: formSlideIn 0.5s ease-out backwards;
        }

        .setup-card .form-group:nth-child(1) {
            animation-delay: 0.1s;
        }

        .setup-card .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .setup-card .form-group:nth-child(3) {
            animation-delay: 0.3s;
        }

        .setup-card .form-group:nth-child(4) {
            animation-delay: 0.4s;
        }

        .setup-card .form-group:nth-child(5) {
            animation-delay: 0.5s;
        }

        .setup-card .form-group:nth-child(6) {
            animation-delay: 0.6s;
        }

        @keyframes formSlideIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .setup-card .badge-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .setup-card .badge-row span {
            background: var(--accent-glow);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-group label i {
            margin-right: 6px;
            color: var(--accent);
        }

        .form-group select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95em;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
        }

        .btn-start {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #0d9488);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(20, 184, 166, 0.25);
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(20, 184, 166, 0.35);
        }

        .btn-start::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-start:hover::after {
            opacity: 1;
        }

        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
        }

        .duration-options {
            display: flex;
            gap: 12px;
        }

        .duration-option {
            flex: 1;
            padding: 16px 12px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .duration-option:hover {
            border-color: rgba(20, 184, 166, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .duration-option.active {
            border-color: var(--accent);
            background: rgba(20, 184, 166, 0.08);
            box-shadow: 0 0 20px rgba(20, 184, 166, 0.15);
        }

        .duration-option .dur-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .dur-time {
            font-weight: 700;
            font-size: 0.95em;
        }

        .dur-price {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9em;
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ Chat Screen ‚îÄ‚îÄ */
        .chat-screen {
            display: none;
            flex: 1;
            flex-direction: column;
            max-width: 850px;
            width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 10px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            margin-top: 2px;
            border: 2px solid var(--border);
        }

        .message .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.ai .avatar {
            border-color: var(--accent);
        }

        .message.user .avatar {
            border-color: #3b82f6;
            order: 2;
        }

        .message .bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 0.93em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message .bubble p {
            margin-bottom: 0.8em;
        }

        .message .bubble p:last-child {
            margin-bottom: 0;
        }

        .message .bubble code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        .message .bubble pre {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message.ai .bubble {
            background: var(--ai-bubble);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.user .bubble {
            background: var(--user-bubble);
            border-bottom-right-radius: 4px;
        }

        .message .bubble strong {
            color: var(--accent);
        }

        .message .bubble h2,
        .message .bubble h3 {
            margin: 12px 0 6px;
            font-size: 1.05em;
        }

        .message .bubble table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.88em;
        }

        .message .bubble th,
        .message .bubble td {
            padding: 6px 10px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .message .bubble th {
            background: rgba(20, 184, 166, 0.1);
            font-weight: 600;
        }

        .message .bubble ul,
        .message .bubble ol {
            padding-left: 20px;
            margin: 6px 0;
        }

        .message .bubble li {
            margin-bottom: 4px;
        }

        .typing-indicator {
            display: none;
            padding: 12px 20px;
        }

        .typing-indicator .dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator .dots span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator .dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: translateY(0)
            }

            40% {
                transform: translateY(-6px)
            }
        }

        /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
        .chat-input-area {
            padding: 12px 20px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.93em;
            resize: none;
            min-height: 46px;
            max-height: 140px;
            line-height: 1.5;
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chat-input-area textarea::placeholder {
            color: var(--text-muted);
        }

        .btn-send {
            width: 46px;
            height: 46px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .btn-send:hover {
            background: var(--accent-hover);
        }

        .btn-send:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ‚îÄ‚îÄ Scorecard Modal ‚îÄ‚îÄ */
        .scorecard-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .scorecard-overlay.active {
            display: flex;
        }

        .scorecard-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 650px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            animation: fadeIn 0.4s ease;
        }

        .scorecard-box h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .scorecard-content {
            line-height: 1.7;
            font-size: 0.95em;
        }

        .scorecard-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
        }

        .scorecard-content th,
        .scorecard-content td {
            padding: 8px 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .scorecard-content th {
            background: rgba(20, 184, 166, 0.1);
            font-weight: 600;
        }

        .scorecard-content h2,
        .scorecard-content h3 {
            margin: 16px 0 8px;
        }

        .scorecard-content ul {
            padding-left: 20px;
        }

        .scorecard-content li {
            margin-bottom: 4px;
        }

        .scorecard-content strong {
            color: var(--accent);
        }

        .scorecard-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
        }

        .scorecard-actions button {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: opacity 0.2s;
        }

        .scorecard-actions button:hover {
            opacity: 0.85;
        }

        .scorecard-actions .btn-primary {
            background: var(--accent);
            color: white;
        }

        .scorecard-actions .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .setup-card {
                padding: 28px 20px;
            }

            .setup-card h1 {
                font-size: 1.4em;
            }

            .message .bubble {
                max-width: 85%;
                font-size: 0.9em;
            }

            .message .avatar {
                width: 28px;
                height: 28px;
                font-size: 0.75em;
            }

            .scorecard-box {
                padding: 20px;
            }

            .navbar {
                padding: 10px 16px;
            }

            .timer-badge {
                font-size: 0.8em;
                padding: 4px 10px;
            }
        }

        /* Speech Styles */
        .mic-btn {
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.3s;
            margin-right: 5px;
            padding: 8px;
        }

        .mic-btn:hover {
            color: var(--text-primary);
        }

        .mic-btn.listening {
            color: #ef4444;
            animation: pulse 1s infinite;
        }

        .speak-btn {
            background: none;
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 1.1em;
            margin-left: 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .speak-btn:hover {
            opacity: 1;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="logo" onclick="stopInterview()"
            style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
            <img src="assets/images/quantmentor-logo-icon-QM-1024.png" alt="QuantMentor" class="logo-img"
                style="height: 32px; width: auto;">
            <span style="font-weight: 700; font-size: 1.2rem; color: var(--text-primary);">QuantMentor</span>
        </a>
        <div class="nav-right">
            <div class="timer-badge" id="timer">
                <i class="fas fa-clock"></i>
                <span id="timer-display">45:00</span>
            </div>
            <button class="btn-end" id="btn-end" onclick="endInterview()">
                <i class="fas fa-flag-checkered"></i> Finish & Get Report
            </button>
        </div>
    </nav>

    <!-- Setup Screen -->
    <div class="setup-screen" id="setup-screen">
        <canvas class="particles-bg" id="interviewParticles"></canvas>
        <div class="setup-wrapper">
            <!-- Mini Hero -->
            <div class="setup-hero">
                <h1>Master Your <span class="gradient-text">Quant Interview</span> with AI</h1>
                <p>Practice with a realistic AI interviewer trained on real quant interview questions from top firms.
                </p>
                <div class="trust-badges">
                    <span><i class="fas fa-check-circle"></i> Real-time feedback</span>
                    <span><i class="fas fa-check-circle"></i> Industry-standard questions</span>
                    <span><i class="fas fa-check-circle"></i> Detailed scorecard</span>
                </div>
            </div>

            <div class="setup-card">
                <h1><i class="fas fa-brain"></i> AI Mock Interview</h1>
                <p class="subtitle">Practice with a realistic AI quant interviewer</p>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Your Name</label>
                    <input type="text" id="user-name" placeholder="John Doe" class="input-field">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email Address (for report)</label>
                    <input type="email" id="user-email" placeholder="john@example.com" class="input-field">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Duration & Plan</label>
                    <div class="duration-options">
                        <div class="duration-option active" onclick="selectDuration(10, 0, this)">
                            <div class="dur-icon">üöÄ</div>
                            <div class="dur-time">10 Min Trial</div>
                            <div class="dur-price">Free</div>
                        </div>
                        <div class="duration-option" onclick="selectDuration(30, 499, this)">
                            <div class="dur-badge">Popular</div>
                            <div class="dur-icon">‚ö°</div>
                            <div class="dur-time">30 Mins</div>
                            <div class="dur-price">‚Çπ499</div>
                        </div>
                        <div class="duration-option" onclick="selectDuration(45, 799, this)">
                            <div class="dur-icon">üéØ</div>
                            <div class="dur-time">45 Mins</div>
                            <div class="dur-price">‚Çπ799</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-book"></i> Focus Topic</label>
                    <select id="topic-select">
                        <option value="General Quant (mix of all topics)">General Quant (All Topics)</option>
                        <option value="Stochastic Calculus & SDEs">Stochastic Calculus & SDEs</option>
                        <option value="Probability & Statistics">Probability & Statistics</option>
                        <option value="Pricing, Greeks & Hedging">Pricing, Greeks & Hedging</option>
                        <option value="Fixed Income & Rate Models">Fixed Income & Rate Models</option>
                        <option value="Credit Models & XVA">Credit Models & XVA</option>
                        <option value="Programming (Python & C++)">Programming (Python & C++)</option>
                        <option value="Risk Management, VaR & P&L Attribution">Risk & P&L Attribution</option>
                        <option value="Mental Math & Market Intuition">Mental Math & Market Intuition</option>
                        <option value="FX, Commodities & Inflation">FX, Commodities & Inflation</option>
                        <option value="Machine Learning for Quants">Machine Learning for Quants</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-signal"></i> Difficulty</label>
                    <select id="difficulty-select">
                        <option value="Junior (entry-level, recent graduate)">Junior</option>
                        <option value="Mid-level (1-3 years experience)" selected>Mid-level</option>
                        <option value="Senior (5+ years, desk quant level)">Senior</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-microphone-alt"></i> Interviewer Voice</label>
                    <select id="voice-select">
                        <!-- Populated via JS -->
                    </select>
                </div>

                <button class="btn-start" id="btn-start" onclick="initiatePayment()">
                    <i class="fas fa-play"></i> Start Free Trial
                </button>
            </div>

            <!-- Feature Highlights -->
            <div class="features-row">
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-comments"></i></div>
                    <h4>Real-time Chat</h4>
                    <p>Natural conversation with follow-up questions and probing</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-chart-bar"></i></div>
                    <h4>Performance Analytics</h4>
                    <p>Detailed scorecard with topic-wise breakdown emailed to you</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-microphone"></i></div>
                    <h4>Voice Mode</h4>
                    <p>Speak your answers and hear AI responses in natural voice</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div class="chat-screen" id="chat-screen">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="typing-indicator" id="typing">
            <div class="dots"><span></span><span></span><span></span></div>
        </div>
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea id="user-input" placeholder="Type your answer..." rows="1" onkeydown="handleKeyDown(event)"
                    oninput="autoResize(this)"></textarea>
                <button id="mic-btn" class="mic-btn" onclick="toggleMic()" title="Speak answer"><i
                        class="fas fa-microphone"></i></button>
                <button class="btn-send" id="btn-send" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scorecard Overlay -->
    <div class="scorecard-overlay" id="scorecard-overlay">
        <div class="scorecard-box">
            <h2>üìä Your Performance Scorecard</h2>
            <div class="scorecard-content" id="scorecard-content"></div>
            <div class="scorecard-actions">
                <button class="btn-primary" onclick="restartInterview()">
                    <i class="fas fa-redo"></i> New Interview
                </button>
                <button class="btn-secondary" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Home
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ Speech API Setup ‚îÄ‚îÄ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 3; // Better accuracy with multiple candidates
        }

        const synth = window.speechSynthesis;
        let isSpeaking = false;
        let autoVoiceMode = false;
        let isAIProcessing = false; // New flag to prevent race conditions
        let silenceTimer = null;
        let finalTranscript = '';
        let currentPuterAudio = null; // Track audio for stopping on exit

        recognition.onresult = (event) => {
            if (isAIProcessing) return; // Ignore input if AI is thinking

            let interim = '';
            // Loop through results to handle continuous stream
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interim += event.results[i][0].transcript;
                }
            }

            // Update UI
            document.getElementById('user-input').value = finalTranscript + interim;

            // Auto-send logic with 3-second silence detection (User requested 3s)
            if (autoVoiceMode) {
                clearTimeout(silenceTimer);

                // Visual feedback: Pulse red
                const micBtn = document.getElementById('mic-btn');
                micBtn.style.color = '#ef4444';

                silenceTimer = setTimeout(() => {
                    // Send if we have content
                    const inputValue = document.getElementById('user-input').value.trim();
                    if (inputValue.length > 0) {
                        // Auto-send after 2 seconds of silence
                        sendMessage();
                        finalTranscript = '';
                    }
                }, 2000); // Reduced to 2 seconds for natural conversation
            }
        };

        recognition.onend = () => {
            // Auto-restart if mode is ON and we are not engaged in AI Speech/Processing
            if (autoVoiceMode && !isAIProcessing && !isSpeaking) {
                try {
                    recognition.start();
                } catch (e) { console.log('Mic auto-restart', e); }
            } else {
                document.getElementById('mic-btn').classList.remove('listening');
                document.getElementById('mic-btn').style.color = '';
            }
        };

        recognition.onerror = (event) => {
            console.error('Speech error:', event.error);
            document.getElementById('mic-btn').classList.remove('listening');
            autoVoiceMode = false;
        };

        window.toggleMic = function () {
            if (!recognition) {
                alert("Your browser doesn't support speech recognition. Please use Chrome, Edge, or Safari.");
                return;
            }
            const btn = document.getElementById('mic-btn');
            if (btn.classList.contains('listening')) {
                recognition.stop();
                btn.classList.remove('listening');
                autoVoiceMode = false;
            } else {
                recognition.start();
                btn.classList.add('listening');
                autoVoiceMode = true; // Enable auto-conversation
            }
        }

        // ‚îÄ‚îÄ Groq Orpheus TTS Voice List (Natural, Human-like) ‚îÄ‚îÄ
        const ORPHEUS_VOICES = [
            { id: 'troy', name: 'üéôÔ∏è Troy (Male) - Professional', gender: 'Male' },
            { id: 'austin', name: 'üéôÔ∏è Austin (Male) - Confident', gender: 'Male' },
            { id: 'daniel', name: 'üéôÔ∏è Daniel (Male) - Warm', gender: 'Male' },
            { id: 'autumn', name: 'üéôÔ∏è Autumn (Female) - Natural', gender: 'Female' },
            { id: 'diana', name: 'üéôÔ∏è Diana (Female) - Professional', gender: 'Female' },
            { id: 'hannah', name: 'üéôÔ∏è Hannah (Female) - Friendly', gender: 'Female' }
        ];

        function populateVoiceList() {
            const voiceSelect = document.getElementById('voice-select');
            voiceSelect.innerHTML = '';

            ORPHEUS_VOICES.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = voice.name;
                voiceSelect.appendChild(option);
            });

            // Default to Troy (professional male voice - best for interviewer)
            voiceSelect.value = 'troy';
            console.log('‚úÖ Groq Orpheus voices loaded:', ORPHEUS_VOICES.length);
        }

        // Load voices on page load
        populateVoiceList();

        function getSelectedVoice() {
            const voiceSelect = document.getElementById('voice-select');
            return (voiceSelect && voiceSelect.value) ? voiceSelect.value : 'troy';
        }

        // ‚îÄ‚îÄ Determine API base URL ‚îÄ‚îÄ
        const API_BASE = window.location.hostname === 'localhost' || window.location.protocol === 'file:'
            ? 'https://quant-mentor.vercel.app'
            : '';

        // ‚îÄ‚îÄ Groq Orpheus TTS (High-Quality, Natural Voice) ‚îÄ‚îÄ
        async function speakText(text) {
            // Reset all flags fresh for this call
            isSpeaking = true;
            isAIProcessing = true;

            // Stop any current audio immediately
            if (synth.speaking) { synth.cancel(); }
            if (currentPuterAudio) {
                currentPuterAudio.pause();
                currentPuterAudio.currentTime = 0;
                currentPuterAudio = null;
            }

            // Clean text for speech (remove markdown, emojis)
            const cleanText = text
                .replace(/\*\*/g, '')
                .replace(/\*/g, '')
                .replace(/#[#]?/g, '')
                .replace(/[\u{1F600}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/üìä|üìù|‚úÖ|‚ùå|üß†|üí°|üîä|üéôÔ∏è|üéØ|‚ö°|üöÄ/g, '')
                .replace(/\n/g, '. ')
                .replace(/\.(\s*\.)+/g, '.')
                .trim();

            if (!cleanText || cleanText.length < 2) {
                isSpeaking = false;
                isAIProcessing = false;
                return;
            }

            const selectedVoice = getSelectedVoice();
            console.log(`üéôÔ∏è TTS Request: voice=${selectedVoice}, chars=${cleanText.length}`);

            // Try Groq TTS with retry
            for (let attempt = 0; attempt < 2; attempt++) {
                try {
                    // Use AbortController for fetch timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

                    const response = await fetch(`${API_BASE}/api/tts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: cleanText.substring(0, 1500), // Cap at 1500 chars for fast response
                            voice: selectedVoice
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        console.warn(`TTS attempt ${attempt + 1} failed: ${response.status}`, errData);
                        if (attempt === 0) {
                            await new Promise(r => setTimeout(r, 1000)); // Wait 1s before retry
                            continue;
                        }
                        throw new Error(`TTS API returned ${response.status}`);
                    }

                    // Verify we got audio data
                    const contentType = response.headers.get('Content-Type') || '';
                    if (!contentType.includes('audio')) {
                        console.warn(`TTS returned non-audio content: ${contentType}`);
                        if (attempt === 0) continue;
                        throw new Error('TTS returned non-audio response');
                    }

                    // Convert response to audio blob and play
                    const audioBlob = await response.blob();
                    console.log(`‚úÖ TTS audio received: ${(audioBlob.size / 1024).toFixed(1)}KB`);

                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    currentPuterAudio = audio;

                    // Safety timeout for playback
                    const playbackTimer = setTimeout(() => {
                        console.warn('TTS playback timeout - resetting');
                        isSpeaking = false;
                        isAIProcessing = false;
                        if (currentPuterAudio === audio) currentPuterAudio = null;
                    }, 60000);

                    audio.onended = () => {
                        clearTimeout(playbackTimer);
                        isSpeaking = false;
                        isAIProcessing = false;
                        URL.revokeObjectURL(audioUrl);
                        if (currentPuterAudio === audio) currentPuterAudio = null;
                        // Auto-restart mic if in voice mode
                        if (autoVoiceMode && interviewActive && recognition) {
                            try {
                                recognition.start();
                                document.getElementById('mic-btn').classList.add('listening');
                            } catch (e) { }
                        }
                    };

                    audio.onerror = (e) => {
                        clearTimeout(playbackTimer);
                        console.warn('Audio playback error', e);
                        URL.revokeObjectURL(audioUrl);
                        if (currentPuterAudio === audio) currentPuterAudio = null;
                        isSpeaking = false;
                        isAIProcessing = false;
                        // Don't fall back to browser here - just stop
                    };

                    await audio.play();
                    console.log('üîä Groq TTS playing!');
                    return; // Success ‚Äî exit the function

                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.warn(`TTS attempt ${attempt + 1} timed out`);
                    } else {
                        console.warn(`TTS attempt ${attempt + 1} error:`, err.message);
                    }
                    if (attempt === 0) {
                        await new Promise(r => setTimeout(r, 500));
                        continue; // Retry once
                    }
                }
            }

            // All Groq TTS attempts failed ‚Äî use browser fallback
            console.warn('All Groq TTS attempts failed, using browser fallback');
            useBrowserFallback(cleanText);
        }

        // ‚îÄ‚îÄ Browser TTS Fallback (only if Groq TTS fails) ‚îÄ‚îÄ
        function useBrowserFallback(text) {
            console.log('üîä Using browser TTS fallback...');
            if (synth.speaking) { synth.cancel(); }

            const utterance = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();

            // Try to find best English voice
            const bestVoice = voices.find(v =>
                v.name.includes('Google') ||
                v.name.includes('Natural') ||
                v.name.includes('Premium') ||
                v.lang === 'en-US'
            ) || voices[0];

            if (bestVoice) utterance.voice = bestVoice;
            utterance.rate = 0.95;
            utterance.pitch = 1.0;

            utterance.onend = () => {
                isSpeaking = false;
                isAIProcessing = false;
                if (autoVoiceMode && interviewActive && recognition) {
                    try {
                        recognition.start();
                        document.getElementById('mic-btn').classList.add('listening');
                    } catch (e) { }
                }
            };

            utterance.onerror = () => {
                isSpeaking = false;
                isAIProcessing = false;
            };

            synth.speak(utterance);
        }

        function createStatusElement() {
            try {
                const div = document.createElement('div');
                div.id = 'mic-status';
                div.style.fontSize = '0.8em';
                div.style.marginTop = '5px';
                div.style.textAlign = 'center';
                const container = document.querySelector('.chat-input-area') || document.body;
                container.appendChild(div);
                return div;
            } catch (e) { console.error("Status UI Error", e); return { innerText: '', style: {} }; }
        }

        window.stopInterview = function () {
            interviewActive = false;
            autoVoiceMode = false;
            clearInterval(timerInterval);

            // Stop Audio & Mic Immediately
            if (currentPuterAudio) { currentPuterAudio.pause(); currentPuterAudio = null; }
            if (synth.speaking) { synth.cancel(); }
            recognition.stop();
            clearTimeout(silenceTimer);

            // UI Updates - These IDs are not in the original HTML, so commenting out or adapting
            // document.getElementById('interview-interface').style.display = 'none';
            // document.getElementById('setup-panel').style.display = 'block';
            document.getElementById('mic-btn').classList.remove('listening');
            document.getElementById('mic-btn').style.color = ''; // Reset mic button color
        }

        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let conversationHistory = [];
        let timerInterval = null;
        let selectedDuration = 10;
        let selectedPrice = 0;
        let timeRemaining = 10 * 60;
        let interviewActive = false;
        let selectedTopic = '';
        let selectedDifficulty = '';
        let userName = '';
        let userEmail = '';
        let paymentId = '';

        const RAZORPAY_KEY_ID = 'rzp_live_SBbq38M84PSrrG'; // Live Key from script.js

        window.selectDuration = function (mins, price, el) {
            selectedDuration = mins;
            selectedPrice = price;
            // Update UI
            document.querySelectorAll('.duration-option').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            // Update button
            const btn = document.getElementById('btn-start');
            if (price === 0) {
                btn.innerHTML = `<i class="fas fa-play"></i> Start Free Trial`;
            } else {
                btn.innerHTML = `<i class="fas fa-lock"></i> Pay ‚Çπ${price} & Start Interview`;
            }
        }

        window.initiatePayment = function () {
            userName = document.getElementById('user-name').value.trim();
            userEmail = document.getElementById('user-email').value.trim();

            if (!userName || !userEmail || !userEmail.includes('@')) {
                alert('Please enter your Name and a valid Email Address to receive the report.');
                return;
            }

            // FREE TRIAL BYPASS
            if (selectedPrice === 0) {
                paymentId = 'FREE_TRIAL_' + Date.now();
                startInterview();
                return;
            }

            const options = {
                "key": RAZORPAY_KEY_ID,
                "amount": selectedPrice * 100, // Amount in paise
                "currency": "INR",
                "name": "QuantMentor AI Interview",
                "description": `${selectedDuration} Min Mock Interview Session`,
                "image": "assets/images/logo.png",
                "handler": function (response) {
                    paymentId = response.razorpay_payment_id;
                    startInterview();
                },
                "prefill": {
                    "name": userName,
                    "email": userEmail
                },
                "theme": {
                    "color": "#14b8a6"
                }
            };
            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert("Payment Failed: " + response.error.description);
            });
            rzp1.open();
        }

        // ‚îÄ‚îÄ API Call ‚îÄ‚îÄ
        async function callInterviewAPI(action, extraData = {}) {
            const maxRetries = 2;
            let lastError = null;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch('/api/interview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action,
                            messages: conversationHistory,
                            topic: selectedTopic,
                            difficulty: selectedDifficulty,
                            ...extraData
                        }),
                        timeout: 30000 // 30 second timeout
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || `API error: ${response.status}`);
                    }

                    return response.json();
                } catch (err) {
                    lastError = err;
                    console.warn(`API attempt ${attempt + 1} failed:`, err.message);
                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1))); // Backoff
                    }
                }
            }

            throw lastError || new Error('API request failed after retries');
        }

        // ‚îÄ‚îÄ Start Interview ‚îÄ‚îÄ
        async function startInterview() {
            const btn = document.getElementById('btn-start');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting up interview...';

            selectedTopic = document.getElementById('topic-select').value;
            selectedDifficulty = document.getElementById('difficulty-select').value;
            conversationHistory = [];
            timeRemaining = selectedDuration * 60;
            // Format timer display properly (e.g., "10:00" not "10:0")
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            document.getElementById('timer-display').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            try {
                const data = await callInterviewAPI('start', {
                    email: userEmail,
                    name: userName,
                    paymentId: paymentId
                });

                // Switch to chat screen
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                document.getElementById('timer').classList.add('active');
                document.getElementById('btn-end').classList.add('active');

                // Add AI's first message
                conversationHistory.push({ role: 'assistant', content: data.reply });
                addMessage('ai', data.reply);

                // Start timer
                interviewActive = true;
                startTimer();

                // Focus input
                document.getElementById('user-input').focus();

            } catch (err) {
                alert('Failed to start interview: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Interview';
            }
        }

        // ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !interviewActive) return;

            // Stop mic while processing
            if (autoVoiceMode) {
                isAIProcessing = true; // Lock the mic
                recognition.stop();
                clearTimeout(silenceTimer);
                document.getElementById('mic-btn').classList.remove('listening');
                document.getElementById('mic-btn').style.color = ''; // Reset color
            }

            // Add user message
            addMessage('user', text);
            conversationHistory.push({ role: 'user', content: text });
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            const sendBtn = document.getElementById('btn-send');
            sendBtn.disabled = true;
            document.getElementById('typing').style.display = 'block';
            scrollToBottom();

            try {
                const data = await callInterviewAPI('respond');
                document.getElementById('typing').style.display = 'none';

                conversationHistory.push({ role: 'assistant', content: data.reply });
                addMessage('ai', data.reply);

            } catch (err) {
                document.getElementById('typing').style.display = 'none';
                addMessage('ai', '‚ö†Ô∏è Sorry, I encountered an error. Please try again or rephrase your answer.');
                console.error('API error:', err);
            }

            sendBtn.disabled = false;
            document.getElementById('user-input').focus();
        }

        // ‚îÄ‚îÄ End Interview ‚îÄ‚îÄ
        window.endInterview = async function () {
            if (!interviewActive) return;
            if (!confirm('End the interview and get your scorecard?')) return;

            interviewActive = false;
            clearInterval(timerInterval);

            document.getElementById('user-input').disabled = true;
            document.getElementById('btn-send').disabled = true;
            document.getElementById('btn-end').classList.remove('active');

            // Show sending status
            document.getElementById('typing').style.display = 'block';
            addMessage('ai', 'üìù Analyzing performance and generating report...');
            scrollToBottom();

            try {
                // Call API to generate report and email it
                const data = await callInterviewAPI('evaluate', {
                    email: userEmail,
                    name: userName
                });

                document.getElementById('typing').style.display = 'none';

                // Show completion message with scorecard
                addMessage('ai', `‚úÖ **Interview Complete!**\n\nYour detailed performance scorecard has been sent to **${userEmail}**.\n\nüì© Check your inbox (and spam folder) in a few minutes.\n\nYou can also see a summary below:`);

                // Show scorecard overlay
                setTimeout(() => {
                    document.getElementById('scorecard-overlay').classList.add('active');
                    document.getElementById('scorecard-content').innerHTML = `
                        <div style="text-align: left; max-height: 400px; overflow-y: auto; padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: var(--accent);">üìä Performance Summary</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                                Detailed report sent to <strong>${userEmail}</strong><br>
                                Check your email for topic-wise ratings, strengths, weaknesses, and study plan.
                            </p>
                            <div style="background: var(--bg-ai-bubble); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <p><strong>Interview Duration:</strong> ${selectedDuration} minutes</p>
                                <p><strong>Topic:</strong> ${selectedTopic}</p>
                                <p><strong>Difficulty:</strong> ${selectedDifficulty}</p>
                                <p><strong>Questions Answered:</strong> ${Math.floor(conversationHistory.length / 2)}</p>
                            </div>
                        </div>
                    `;
                }, 1000);

            } catch (err) {
                document.getElementById('typing').style.display = 'none';
                addMessage('ai', '‚ö†Ô∏è Error generating report: ' + err.message + '\n\nPlease screenshot this conversation for your records.');
            }
        }

        // ‚îÄ‚îÄ Restart ‚îÄ‚îÄ
        window.restartInterview = function () {
            conversationHistory = [];
            timeRemaining = 45 * 60;
            interviewActive = false;
            clearInterval(timerInterval);

            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('scorecard-overlay').classList.remove('active');
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'flex';
            document.getElementById('timer').classList.remove('active', 'warning', 'danger');
            document.getElementById('timer-display').textContent = '45:00';
            document.getElementById('btn-end').classList.remove('active');
            document.getElementById('user-input').disabled = false;
            document.getElementById('btn-send').disabled = false;

            const btn = document.getElementById('btn-start');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Start Interview';
        }

        // ‚îÄ‚îÄ Timer ‚îÄ‚îÄ
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    endInterview();
                    return;
                }
                timeRemaining--;
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                document.getElementById('timer-display').textContent =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                const timerEl = document.getElementById('timer');
                timerEl.classList.remove('warning', 'danger');
                if (timeRemaining <= 120) timerEl.classList.add('danger');
                else if (timeRemaining <= 300) timerEl.classList.add('warning');
            }, 1000);
        }

        // ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ
        function addMessage(role, content) {
            const messagesEl = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${role}`;

            const avatarImg = role === 'ai'
                ? '<img src="assets/images/interviewer-avatar.png" alt="Interviewer">'
                : '<img src="assets/images/candidate-avatar.png" alt="You">';

            div.innerHTML = `
                <div class="avatar">${avatarImg}</div>
                <div class="bubble">
                    ${marked.parse(content)} 
                    ${role === 'ai' ? `<button class="speak-btn" onclick="speakText(this.parentElement.innerText.replace('üîä',''))" title="Listen">üîä</button>` : ''}
                </div>
            `;
            messagesEl.appendChild(div);
            scrollToBottom();

            // Auto-speak AI response (voice mode auto-speaks, manual still has üîä button)
            if (role === 'ai' && autoVoiceMode) {
                const textToSpeak = content.replace(/[\u{1F600}-\u{1F6FF}]/gu, '').replace(/\*/g, '');
                speakText(textToSpeak);
            }
        }

        function scrollToBottom() {
            const el = document.getElementById('chat-messages');
            setTimeout(() => el.scrollTop = el.scrollHeight, 50);
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 140) + 'px';
        }


        // Global Cleanup on Tab Close / Navigation
        window.addEventListener('beforeunload', () => {
            if (synth.speaking) synth.cancel();
            if (currentPuterAudio) { currentPuterAudio.pause(); }
            if (recognition) recognition.stop();
        });

        // ‚îÄ‚îÄ Interview Setup Particle Animation ‚îÄ‚îÄ
        (function () {
            const canvas = document.getElementById('interviewParticles');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const PARTICLE_COUNT = 50;
            const CONNECTION_DIST = 110;

            function resizeCanvas() {
                const screen = document.getElementById('setup-screen');
                if (!screen) return;
                canvas.width = screen.offsetWidth;
                canvas.height = screen.offsetHeight;
            }

            function createParticles() {
                particles = [];
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 0.4,
                        vy: (Math.random() - 0.5) * 0.4,
                        r: Math.random() * 1.5 + 0.5,
                        alpha: Math.random() * 0.4 + 0.1
                    });
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Connections
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < CONNECTION_DIST) {
                            const opacity = (1 - dist / CONNECTION_DIST) * 0.12;
                            ctx.strokeStyle = `rgba(20, 184, 166, ${opacity})`;
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
                // Particles
                for (const p of particles) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fill();
                    p.x += p.vx; p.y += p.vy;
                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                }
                requestAnimationFrame(draw);
            }

            resizeCanvas();
            createParticles();
            draw();
            window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        })();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | QuantMentor</title>
    <link rel="canonical" href="https://quantmentor.vercel.app/product.html">

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="assets/images/quantmentor-logo-icon-QM-1024.png">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="QuantMentor Premium Resource">
    <meta property="og:description" content="Premium digital resource for quantitative finance professionals.">
    <meta property="og:image" content="assets/images/logo.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
    <style>
        .product-page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 20px 60px;
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-detail-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            width: 100%;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .product-detail-image {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            height: 400px;
            position: relative;
        }

        .product-detail-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .product-detail-placeholder {
            font-size: 5rem;
            color: var(--text-muted);
        }

        .product-info h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .product-price-tag {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .product-description-full {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 40px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            /* Fallback */
            word-break: break-word;
            max-width: 100%;
        }

        .product-info {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .product-page-container {
                padding: 100px 15px 40px;
                overflow-x: hidden;
            }

            .product-detail-card {
                grid-template-columns: 1fr;
                gap: 30px;
                padding: 20px;
                border-radius: var(--radius-lg);
            }

            .product-detail-image {
                height: 250px;
            }

            .product-info {
                position: static;
                text-align: left;
            }

            .product-info h1 {
                font-size: 1.8rem;
                word-break: break-word;
                /* Wrap long titles */
                overflow-wrap: anywhere;
            }

            .product-price-tag {
                font-size: 1.5rem;
                justify-content: flex-start;
            }

            .product-description-full {
                font-size: 1rem;
                margin-bottom: 30px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .coupon-row {
                flex-direction: column;
                align-items: stretch;
            }

            .coupon-row input {
                width: 100%;
            }

            .product-badges {
                flex-wrap: wrap;
            }

            .reviews-carousel-section {
                padding: 40px 15px;
            }

            .reviews-carousel-container {
                padding: 0 40px;
            }

            .carousel-btn {
                width: 35px;
                height: 35px;
            }

            .carousel-btn.prev {
                left: 0;
            }

            .carousel-btn.next {
                right: 0;
            }

            .review-slide {
                min-width: 100%;
                padding: 20px;
            }
        }

        /* Product Badges */
        .product-badges {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .product-badge-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fef08a;
            color: #1a1a1a;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .product-badge-item i {
            font-size: 1rem;
        }

        .product-badge-item.rating {
            background: #fef08a;
        }

        .product-badge-item.rating i {
            color: #1a1a1a;
        }

        .product-badge-item.digital {
            background: #fef08a;
        }

        .product-badge-item.sales {
            background: #fef08a;
        }

        /* Reviews Carousel Section */
        .reviews-carousel-section {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
            text-align: center;
        }

        .reviews-carousel-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        .reviews-carousel-container {
            position: relative;
            overflow: hidden;
            padding: 0 50px;
        }

        .reviews-carousel-track {
            display: flex;
            transition: transform 0.4s ease-in-out;
        }

        .review-slide {
            min-width: 100%;
            padding: 30px;
            box-sizing: border-box;
        }

        .review-card {
            background: #fef3e2;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .review-card .review-text {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #333;
            margin-bottom: 20px;
            font-style: normal;
        }

        .review-card .review-author {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 1rem;
        }

        .review-card .review-date {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .carousel-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .carousel-btn.prev {
            left: 0;
        }

        .carousel-btn.next {
            right: 0;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-light);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .carousel-dot.active {
            background: var(--accent-primary);
            transform: scale(1.2);
        }

        .no-reviews-message {
            color: var(--text-muted);
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- Setup config for script.js to pick up -->
    <script>
        // Load config.js if it exists, otherwise gracefully fallback
        (function () {
            var script = document.createElement('script');
            script.src = 'config.js';
            script.onerror = function () {
                console.log('ℹ️ config.js not found. Using fallback configuration from script.js');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script src="script.js"></script>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo"
                style="text-decoration: none; display: flex; align-items: center; gap: 10px;">
                <img src="assets/images/quantmentor-logo-icon-QM-1024.png" alt="QuantMentor" class="logo-img"
                    style="height: 32px; width: auto;">
                <span class="logo-text"
                    style="font-weight: 700; font-size: 1.2rem; background: linear-gradient(135deg, white 0%, #a5b4fc 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">QuantMentor</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html#products">All Products</a></li>
                <li><a href="index.html#contact" class="nav-cta">Book Session</a></li>
            </ul>
            <div class="nav-actions">
                <button id="themeToggle" class="theme-toggle" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="product-page-container">
        <div id="loading" style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--accent-primary);"></i>
            <p style="margin-top: 20px; color: var(--text-muted);">Loading product details...</p>
        </div>

        <div id="product-content" class="product-detail-card" style="display: none;">
            <div class="product-detail-image">
                <img id="p-image" src="" alt="Product Cover" style="display: none;">
                <div id="p-placeholder" class="product-detail-placeholder">
                    <i class="fas fa-file-pdf"></i>
                </div>
            </div>

            <div class="product-info">
                <!-- Product Badges -->
                <div class="product-badges" id="p-badges">
                    <span class="product-badge-item rating" id="p-rating-badge">
                        <i class="fas fa-star"></i> <span id="p-rating">5</span>
                    </span>
                    <span class="product-badge-item digital">
                        <i class="far fa-check-square"></i> Digital Product
                    </span>
                    <span class="product-badge-item sales" id="p-sales-badge">
                        <i class="fas fa-bolt"></i> <span id="p-sales">0</span> Sales
                    </span>
                </div>
                <h1 id="p-title">Product Title</h1>
                <div class="product-price-tag" id="p-price">₹0</div>
                <div class="product-description-full" id="p-desc">
                    Product description...
                </div>

                <div class="action-buttons">
                    <button id="buy-btn" class="btn btn-primary" style="padding: 16px 40px; font-size: 1.1rem;">
                        <i class="fas fa-shopping-cart"></i> Buy Now
                    </button>
                    <a href="index.html#products" class="btn btn-secondary">
                        Browse More
                    </a>
                </div>
            </div>
        </div>

        <div id="error-content" style="display: none; text-align: center;">
            <h2 style="color: #ef4444; margin-bottom: 20px;">Product Not Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">The product you are looking for does not exist
                or has been removed.</p>
            <a href="index.html" class="btn btn-primary">Return Home</a>
        </div>
    </div>

    <!-- Reviews Carousel Section -->
    <section class="reviews-carousel-section" id="reviews-section" style="display: none;">
        <h2>What are people saying</h2>
        <div class="reviews-carousel-container">
            <button class="carousel-btn prev" id="carousel-prev" onclick="moveCarousel(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="reviews-carousel-track" id="carousel-track">
                <!-- Reviews will be loaded dynamically -->
            </div>
            <button class="carousel-btn next" id="carousel-next" onclick="moveCarousel(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="carousel-dots" id="carousel-dots">
            <!-- Dots will be added dynamically -->
        </div>
    </section>

    <!-- Footer -->
    <footer style="border-top: 1px solid var(--border-subtle); padding: 40px 0; background: var(--bg-secondary);">
        <div class="nav-container" style="text-align: center;">
            <p style="color: var(--text-muted);">&copy; 2026 QuantMentor. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Get Product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let productId = urlParams.get('id');

            // Bug fix: If ID has wrapping quotes (e.g. "'123'"), strip them
            if (productId) {
                productId = productId.replace(/^['"]|['"]$/g, '');
            }

            if (!productId) {
                showError();
                return;
            }

            // Initialize Supabase immediately for product page
            if (window.supabaseClient) {
                await loadProduct(productId);
            } else if (window.supabase && typeof window.supabase.createClient === 'function') {
                const SUPABASE_URL = 'https://dntabmyurlrlnoajdnja.supabase.co';
                const SUPABASE_KEY = 'sb_publishable_OhbTYIuMYgGgmKPQJ9W7RA_rhKyaad0'; // Hardcoded fallback
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                await loadProduct(productId);
            } else {
                // If the SDK script hasn't downloaded yet, retry briefly
                let attempts = 0;
                const checkSupabase = setInterval(async () => {
                    attempts++;
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        clearInterval(checkSupabase);
                        const SUPABASE_URL = 'https://dntabmyurlrlnoajdnja.supabase.co';
                        const SUPABASE_KEY = 'sb_publishable_OhbTYIuMYgGgmKPQJ9W7RA_rhKyaad0';
                        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        await loadProduct(productId);
                    } else if (attempts > 20) { // Max 2 seconds (20 * 100ms)
                        clearInterval(checkSupabase);
                        alert('Failed to load database. Please reload the page.');
                    }
                }, 100);
            }
        });

        async function loadProduct(id) {
            try {
                const { data: product, error } = await window.supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !product) {
                    console.error('Product load error:', error);
                    showError();
                    return;
                }

                // Populate UI
                document.getElementById('p-title').textContent = product.name;

                // Description
                const descEl = document.getElementById('p-desc');
                descEl.innerHTML = product.description || 'No description available.';

                // Image
                if (product.cover_image_url) {
                    const img = document.getElementById('p-image');
                    img.src = product.cover_image_url;
                    img.style.display = 'block';
                    document.getElementById('p-placeholder').style.display = 'none';
                }

                // Update Product Badges (Rating, Sales)
                if (product.average_rating !== undefined) {
                    document.getElementById('p-rating').textContent = product.average_rating || 5;
                }
                if (product.sales_count !== undefined) {
                    document.getElementById('p-sales').textContent = product.sales_count || 0;
                }

                // Load Product-Specific Reviews
                loadProductReviews(id);

                // Price Setup (Instant Display in INR)
                const priceEl = document.getElementById('p-price');
                const buyBtn = document.getElementById('buy-btn');

                let priceText = '₹' + product.price;

                if (product.price === 0) {
                    priceEl.textContent = 'Free';
                    priceEl.style.color = '#22c55e';
                    buyBtn.innerHTML = '<i class="fas fa-download"></i> Download Free';
                    buyBtn.classList.replace('btn-primary', 'btn-success');
                    buyBtn.style.background = '#22c55e';
                } else {
                    let originalPriceDisplay = '';
                    if (product.original_price > product.price) {
                        originalPriceDisplay = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">₹${product.original_price}</span>`;
                    }
                    priceEl.innerHTML = `${originalPriceDisplay}${priceText}`;
                    buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceText}`;

                    // Add Coupon UI if price > 0
                    const couponContainer = document.createElement('div');
                    // ... coupon structure intact ...
                    couponContainer.id = 'coupon-section';
                    couponContainer.style.marginBottom = '24px';
                    couponContainer.innerHTML = `
                        <div class="coupon-row">
                            <input type="text" id="coupon-input" placeholder="Have a coupon code?" />
                            <button id="apply-coupon-btn" class="btn btn-secondary" type="button">
                                Apply
                            </button>
                        </div>
                    `;
                    // Insert coupon before action buttons
                    const actionButtons = document.querySelector('.action-buttons');
                    priceEl.parentNode.insertBefore(couponContainer, actionButtons);

                    // Create Feedback Element
                    const feedbackMsg = document.createElement('div');
                    feedbackMsg.id = 'coupon-feedback';
                    feedbackMsg.style.marginTop = '8px';
                    feedbackMsg.style.fontSize = '0.9rem';
                    couponContainer.appendChild(feedbackMsg);

                    // Coupon Logic
                    document.getElementById('apply-coupon-btn').addEventListener('click', async function () {
                        const codeInput = document.getElementById('coupon-input');
                        const code = codeInput.value.trim();
                        feedbackMsg.textContent = ''; // Reset
                        feedbackMsg.style.color = 'var(--text-muted)';

                        if (!code) return;

                        if (product.coupon_code && code === product.coupon_code) {
                            const discount = product.discount_percentage || 0;
                            const originalPrice = parseFloat(buyBtn.dataset.price);
                            // Calculate new price
                            const discountedPrice = Math.max(0, Math.round(originalPrice * (100 - discount) / 100));

                            // Update Display
                            let priceDisplay = '';
                            const currentCurrency = buyBtn.dataset.currency || 'INR';

                            if (currentCurrency === 'INR') {
                                priceDisplay = `₹${discountedPrice}`;
                                priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">₹${originalPrice}</span> ${priceDisplay}`;
                            } else {
                                priceDisplay = `${discountedPrice} ${currentCurrency}`;
                                priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">${originalPrice} ${currentCurrency}</span> ${priceDisplay}`;
                            }

                            // Update Button
                            buyBtn.dataset.price = discountedPrice;
                            buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceDisplay}`;

                            // Success Feedback
                            feedbackMsg.textContent = `Coupon '${code}' applied! ${discount}% OFF applied successfully.`;
                            feedbackMsg.style.color = '#22c55e'; // Success Green

                            // Disable input
                            codeInput.disabled = true;
                            this.disabled = true;
                            this.textContent = 'Applied';
                        } else {
                            // Error Feedback
                            feedbackMsg.textContent = 'Invalid coupon code for this product.';
                            feedbackMsg.style.color = '#ef4444'; // Error Red
                        }
                    });
                }

                // Set Page Title
                document.title = `${product.name} | QuantMentor`;

                buyBtn.onclick = function () {
                    if (typeof window.initRazorpayCheckout === 'function') {
                        // Calculate checkout parameters
                        let checkoutPrice = product.price;
                        let checkoutCurrency = 'INR';
                        const loggingPrice = product.price;

                        // Pass to Razorpay with simplest defaults for now (relying on script.js globals/logic if needed, but explicit args here)
                        // If we had local price, we could pass it. But for stability, let's stick to base price or re-fetch locally if needed.
                        // Actually, let's try to pass the computed local price if available.

                        if (buyBtn.dataset.price) {
                            checkoutPrice = parseFloat(buyBtn.dataset.price);
                        }
                        if (buyBtn.dataset.currency) {
                            checkoutCurrency = buyBtn.dataset.currency;
                        }

                        window.initRazorpayCheckout(product.name, checkoutPrice, checkoutCurrency, loggingPrice);
                    } else {
                        alert('Payment system loading... please try again.');
                    }
                };

                // Show Content IMMEDIATELY (Do not block on currency conversion)
                document.getElementById('loading').style.display = 'none';
                document.getElementById('product-content').style.display = 'grid';

                // Store base price on button for the handler
                buyBtn.dataset.price = product.price;
                buyBtn.dataset.currency = 'INR';

                // Asynchronous currency conversion (Non-blocking)
                if (window.convertPrice && window.getUserCountry && product.price > 0) {
                    window.getUserCountry().then(country => {
                        return window.convertPrice(product.price, country).then(localPrice => {
                            if (localPrice.currency.code !== 'INR') {
                                // Update Buy Button Dataset
                                buyBtn.dataset.price = localPrice.amount;
                                buyBtn.dataset.currency = localPrice.currency.code;

                                // Update Display Text
                                let newPriceText = `${localPrice.currency.symbol}${localPrice.amount} ${localPrice.currency.code}`;

                                let newOriginalDisplay = '';
                                if (product.original_price > product.price) {
                                    const rate = localPrice.rate || 1;
                                    let convertedOriginal = product.original_price * rate;

                                    const weakersCurrencies = [
                                        'PKR', 'BDT', 'LKR', 'NPR', 'NGN', 'EGP', 'KES', 'GHS', 'ZAR',
                                        'VND', 'IDR', 'PHP', 'MYR', 'THB', 'TRY', 'RUB', 'UAH',
                                        'BRL', 'MXN', 'ARS', 'COP', 'CLP', 'PEN'
                                    ];

                                    if (!weakersCurrencies.includes(localPrice.currency.code)) {
                                        convertedOriginal = convertedOriginal * 1.5;
                                    }

                                    newOriginalDisplay = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">${localPrice.currency.symbol}${Math.round(convertedOriginal).toLocaleString()}</span>`;
                                }

                                priceEl.innerHTML = `${newOriginalDisplay}${newPriceText}`;
                                buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${newPriceText}`;
                            }
                        });
                    }).catch(err => console.warn('Deferred currency conversion failed', err));
                }

                // --- User Details Modal Logic ---
                const productUserModal = document.getElementById('user-details-modal');
                const productUserForm = document.getElementById('user-details-form');
                const productUserClose = document.getElementById('ud-close');

                // Update Buy Button Handler
                buyBtn.onclick = function (e) {
                    e.preventDefault();
                    if (productUserModal) {
                        productUserModal.style.display = 'flex';
                    }
                };

                // Close Modal Handler
                if (productUserClose) {
                    productUserClose.onclick = function () {
                        productUserModal.style.display = 'none';
                    };
                }

                // Form Submit Handler
                if (productUserForm) {
                    productUserForm.onsubmit = function (e) {
                        e.preventDefault();

                        const name = document.getElementById('ud-name').value.trim();
                        const email = document.getElementById('ud-email').value.trim();
                        const phone = document.getElementById('ud-phone').value.trim();

                        if (name && email) {
                            if (typeof window.initRazorpayCheckout === 'function') {
                                productUserModal.style.display = 'none';

                                // Calculate checkout parameters
                                let checkoutPrice = product.price;
                                let checkoutCurrency = 'INR';
                                const loggingPrice = product.price;

                                if (buyBtn.dataset.price) {
                                    checkoutPrice = parseFloat(buyBtn.dataset.price);
                                }
                                if (buyBtn.dataset.currency) {
                                    checkoutCurrency = buyBtn.dataset.currency;
                                }

                                // Pass User Details to Init
                                window.initRazorpayCheckout(product.name, checkoutPrice, checkoutCurrency, loggingPrice, {
                                    name: name,
                                    email: email,
                                    phone: phone // Optional, can be empty
                                });
                            } else {
                                alert('Payment system loading... please try again.');
                            }
                        }
                    };
                }

            } catch (err) {
                console.error(err);
                showError();
            }
        }

        // Reviews Carousel Variables
        let currentSlide = 0;
        let totalSlides = 0;

        // Load product-specific reviews from junction table
        async function loadProductReviews(productId) {
            try {
                // Fetch reviews linked to this product
                const { data: linkedReviews, error: linkError } = await window.supabaseClient
                    .from('product_reviews')
                    .select(`
                        display_order,
                        testimonials (
                            id,
                            name,
                            review,
                            rating,
                            created_at
                        )
                    `)
                    .eq('product_id', productId)
                    .order('display_order', { ascending: true });

                if (linkError) {
                    console.log('No product_reviews table or error:', linkError);
                    // Fallback: load some published testimonials
                    return loadFallbackReviews();
                }

                if (!linkedReviews || linkedReviews.length === 0) {
                    // Fallback: load published testimonials as carousel
                    return loadFallbackReviews();
                }

                // Extract testimonials data
                const reviews = linkedReviews
                    .filter(r => r.testimonials)
                    .map(r => r.testimonials);

                if (reviews.length > 0) {
                    renderReviewsCarousel(reviews);
                }
            } catch (e) {
                console.error('Error loading product reviews:', e);
                loadFallbackReviews();
            }
        }

        // Fallback: Load published testimonials if no product_reviews linked
        async function loadFallbackReviews() {
            try {
                const { data: reviews, error } = await window.supabaseClient
                    .from('testimonials')
                    .select('*')
                    .eq('is_published', true)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (!error && reviews && reviews.length > 0) {
                    renderReviewsCarousel(reviews);
                }
            } catch (e) {
                console.error('Fallback reviews load error:', e);
            }
        }

        // Render reviews into carousel
        function renderReviewsCarousel(reviews) {
            const track = document.getElementById('carousel-track');
            const dotsContainer = document.getElementById('carousel-dots');
            const section = document.getElementById('reviews-section');

            if (!track || !reviews || reviews.length === 0) return;

            totalSlides = reviews.length;
            currentSlide = 0;

            // Build slides
            track.innerHTML = reviews.map((r, index) => {
                const date = new Date(r.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const escapedReview = r.review.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const escapedName = r.name.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `
                    <div class="review-slide">
                        <div class="review-card">
                            <p class="review-text">"${escapedReview}"</p>
                            <p class="review-author">— ${escapedName}</p>
                            <p class="review-date">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Build dots
            if (dotsContainer && totalSlides > 1) {
                dotsContainer.innerHTML = reviews.map((_, i) =>
                    `<button class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></button>`
                ).join('');
            }

            // Show section
            section.style.display = 'block';

            // Hide arrows if only 1 review
            if (totalSlides <= 1) {
                document.getElementById('carousel-prev').style.display = 'none';
                document.getElementById('carousel-next').style.display = 'none';
            }
        }

        // Move carousel by direction (-1 or +1)
        function moveCarousel(direction) {
            currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
            updateCarousel();
        }

        // Go to specific slide
        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
        }

        // Update carousel position
        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            if (track) {
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
            }

            // Update dots
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === currentSlide);
            });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
        }
    </script>

    <!-- User Details Modal (Product Page) -->
    <div id="user-details-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div
            style="background: var(--bg-card); padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; border: 1px solid var(--border-light); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <h3 style="margin-bottom: 20px; font-size: 1.5rem; text-align: center; color: var(--text-primary);">Enter
                Your Details</h3>
            <p style="color:var(--text-muted); text-align:center; margin-bottom: 24px;">Please provide via secure form
                so we can send your resource via email.</p>

            <form id="user-details-form" style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                    <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">Full
                        Name *</label>
                    <input type="text" id="ud-name" required placeholder="John Doe"
                        style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-light); background:var(--bg-tertiary); color:var(--text-primary);">
                </div>
                <div>
                    <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">Email
                        Address *</label>
                    <input type="email" id="ud-email" required placeholder="john@example.com"
                        style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-light); background:var(--bg-tertiary); color:var(--text-primary);">
                </div>
                <div>
                    <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:0.9rem;">Phone
                        Number (Optional)</label>
                    <input type="tel" id="ud-phone" placeholder="+91 9876543210"
                        style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-light); background:var(--bg-tertiary); color:var(--text-primary);">
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width:100%; padding:14px; margin-top:10px; font-size:1.1rem;">
                    Proceed to Payment <i class="fas fa-arrow-right" style="margin-left:8px;"></i>
                </button>
                <button type="button" id="ud-close"
                    style="background:none; border:none; color:var(--text-muted); padding:10px; cursor:pointer; width:100%; text-align:center;">Cancel</button>
            </form>
        </div>
    </div>

</body>

</html>
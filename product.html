<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | QuantMentor</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="assets/images/logo.png">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="QuantMentor Premium Resource">
    <meta property="og:description" content="Premium digital resource for quantitative finance professionals.">
    <meta property="og:image" content="assets/images/logo.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
    <style>
        .product-page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 20px 60px;
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-detail-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            width: 100%;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .product-detail-image {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            height: 400px;
            position: relative;
        }

        .product-detail-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .product-detail-placeholder {
            font-size: 5rem;
            color: var(--text-muted);
        }

        .product-info h1 {
            font-size: 2.5rem;
            margin-bottom: 16px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .product-price-tag {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .product-description-full {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 40px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .product-detail-card {
                grid-template-columns: 1fr;
                gap: 40px;
                padding: 24px;
            }

            .product-detail-image {
                height: 300px;
            }

            .product-info h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <!-- Setup config for script.js to pick up -->
    <script src="config.js"></script>
    <script src="script.js"></script>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="QuantMentor" class="logo-img"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                <span class="logo-icon" style="display:none;">üìä</span>
                <span class="logo-text">QuantMentor</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html#products">All Products</a></li>
                <li><a href="index.html#contact" class="nav-cta">Book Session</a></li>
            </ul>
        </div>
    </nav>

    <div class="product-page-container">
        <div id="loading" style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--accent-primary);"></i>
            <p style="margin-top: 20px; color: var(--text-muted);">Loading product details...</p>
        </div>

        <div id="product-content" class="product-detail-card" style="display: none;">
            <div class="product-detail-image">
                <img id="p-image" src="" alt="Product Cover" style="display: none;">
                <div id="p-placeholder" class="product-detail-placeholder">
                    <i class="fas fa-file-pdf"></i>
                </div>
            </div>

            <div class="product-info">
                <h1 id="p-title">Product Title</h1>
                <div class="product-price-tag" id="p-price">‚Çπ0</div>

                <!-- Coupon Section -->
                <div id="coupon-section" style="margin-bottom: 24px; display: none;">
                    <div style="display: flex; gap: 10px; max-width: 400px;">
                        <input type="text" id="coupon-input" placeholder="Have a coupon code?"
                            style="flex: 1; padding: 12px; border: 1px solid var(--border-light); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary);">
                        <button id="apply-coupon-btn" class="btn btn-secondary" style="padding: 12px 20px;">
                            Apply
                        </button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="buy-btn" class="btn btn-primary" style="padding: 16px 40px; font-size: 1.1rem;">
                        <i class="fas fa-shopping-cart"></i> Buy Now
                    </button>
                    <a href="index.html#products" class="btn btn-secondary">
                        Browse More
                    </a>
                </div>
            </div>
        </div>

        <div id="error-content" style="display: none; text-align: center;">
            <h2 style="color: #ef4444; margin-bottom: 20px;">Product Not Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">The product you are looking for does not exist
                or has been removed.</p>
            <a href="index.html" class="btn btn-primary">Return Home</a>
        </div>
    </div>

    <!-- Footer -->
    <footer style="border-top: 1px solid var(--border-subtle); padding: 40px 0; background: var(--bg-secondary);">
        <div class="nav-container" style="text-align: center;">
            <p style="color: var(--text-muted);">&copy; 2026 QuantMentor. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Get Product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let productId = urlParams.get('id');

            // Bug fix: If ID has wrapping quotes (e.g. "'123'"), strip them
            if (productId) {
                productId = productId.replace(/^['"]|['"]$/g, '');
            }

            if (!productId) {
                showError();
                return;
            }

            // Initialize Supabase
            // Note: We use the same initialization logic as script.js via global config if available
            // But since we are standalone, let's wait for script.js to init or init ourselves

            // Wait a moment for script.js to initialize Supabase
            let attempts = 0;
            const checkSupabase = setInterval(async () => {
                attempts++;
                if (window.supabaseClient) {
                    clearInterval(checkSupabase);
                    await loadProduct(productId);
                } else if (attempts > 10) {
                    // Force init if script.js fails
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        const SUPABASE_URL = 'https://dntabmyurlrlnoajdnja.supabase.co';
                        const SUPABASE_KEY = 'sb_publishable_OhbTYIuMYgGgmKPQJ9W7RA_rhKyaad0'; // Hardcoded fallback from script.js
                        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        clearInterval(checkSupabase);
                        await loadProduct(productId);
                    } else {
                        clearInterval(checkSupabase);
                        alert('Failed to load database. Please reload.');
                    }
                }
            }, 500);
        });

        async function loadProduct(id) {
            try {
                console.log('üîç loadProduct called with ID:', id);
                console.log('üîç ID Type:', typeof id);

                const { data: product, error } = await window.supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                console.log('üîç Supabase Response:', { product, error });

                // visual debug for user
                // alert('Debug: Loading Product ID: ' + id);

                if (error || !product) {
                    console.error('Product load error:', error);
                    // alert('Debug: Supabase Error: ' + JSON.stringify(error));
                    showError();
                    return;
                }

                // Populate UI
                document.getElementById('p-title').textContent = product.name;

                // Description (strip HTML if needed or safe innerHTML)
                const descEl = document.getElementById('p-desc');
                descEl.innerHTML = product.description || 'No description available.';

                // Image
                if (product.cover_image_url) {
                    const img = document.getElementById('p-image');
                    img.src = product.cover_image_url;
                    img.style.display = 'block';
                    document.getElementById('p-placeholder').style.display = 'none';
                }

                // Price
                const priceEl = document.getElementById('p-price');
                const buyBtn = document.getElementById('buy-btn');

                // We'll reuse script.js convertPrice if available, else fallback
                let priceText = '‚Çπ' + product.price;
                if (window.convertPrice && window.getUserCountry) {
                    const country = await window.getUserCountry();
                    const localPrice = await window.convertPrice(product.price, country);
                    if (localPrice.currency.code !== 'INR') {
                        priceText = `${localPrice.currency.symbol}${localPrice.amount} ${localPrice.currency.code}`;
                    }
                }

                if (product.price === 0) {
                    priceEl.textContent = 'Free';
                    priceEl.style.color = '#22c55e';
                    buyBtn.innerHTML = '<i class="fas fa-download"></i> Download Free';
                    buyBtn.classList.replace('btn-primary', 'btn-success'); // Assuming green button
                    buyBtn.style.background = '#22c55e';
                } else {
                    priceEl.textContent = priceText;
                    buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceText}`;
                }

                // Set Page Title
                document.title = `${product.name} | QuantMentor`;

                // Coupon Logic
                const couponSection = document.getElementById('coupon-section');
                if (product.price > 0) {
                    couponSection.style.display = 'block';
                }

                document.getElementById('apply-coupon-btn').addEventListener('click', async function () {
                    const code = document.getElementById('coupon-input').value.trim();
                    if (!code) return;

                    // Check against product coupon
                    if (product.coupon_code && code.toLowerCase() === product.coupon_code.toLowerCase()) {
                        const discount = product.coupon_percent || 0;
                        const originalPrice = parseFloat(buyBtn.dataset.price); // Current base price (local or INR)

                        // Calculate new price
                        const discountedPrice = Math.max(0, Math.round(originalPrice * (100 - discount) / 100));

                        // Update UI
                        const currentCurrency = buyBtn.dataset.currency;
                        const currencySymbol = currentCurrency === 'INR' ? '‚Çπ' : (await window.convertPrice(1, await window.getUserCountry())).currency.symbol; // Approx symbol fetch

                        // We need to fetch symbol properly or store it. 
                        let priceDisplay = '';
                        if (currentCurrency === 'INR') {
                            priceDisplay = `‚Çπ${discountedPrice}`;
                            priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">‚Çπ${originalPrice}</span> ${priceDisplay}`;
                        } else {
                            priceDisplay = `${discountedPrice} ${currentCurrency}`;
                            priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">${originalPrice} ${currentCurrency}</span> ${priceDisplay}`;
                        }

                        // Update Button Data
                        buyBtn.dataset.price = discountedPrice;
                        buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceDisplay}`;

                        alert(`Coupon '${code}' applied! ${discount}% OFF`);

                        // Disable input
                        document.getElementById('coupon-input').disabled = true;
                        this.disabled = true;
                        this.textContent = 'Applied';
                    } else {
                        alert('Invalid coupon code for this product.');
                    }
                });

                buyBtn.onclick = function () {
                    if (typeof window.initRazorpayCheckout === 'function') {
                        // Calculate checkout parameters
                        let checkoutPrice = product.price;
                        let checkoutCurrency = 'INR';

                        // Use calculated local price if available (from window.currentProductLocalPrice which we can mimic or re-calculate)
                        // Or better, just rely on what we computed above?
                        // Actually, let's just re-use the logic if we have it, or fallback to INR.

                        // Check if we found a local price during render
                        if (window.convertPrice && window.getUserCountry) {
                            // We already did this above, but local variables scope might be tricky if not stored.
                            // Let's just fetch it again or store it in dataset.
                        }

                        // For simplicity and robustness, let's grab it from the display or re-calculate IF needed.
                        // But wait, initRazorpayCheckout takes (name, amount, currency, loggingAmount).

                        // Let's assume INR default to avoid complexity, OR re-do the async check?
                        // No, onclick can't easily be async without care.
                        // Let's store the computed values on the button dataset when loading!

                        const finalPrice = parseFloat(buyBtn.dataset.price || product.price);
                        const finalCurrency = buyBtn.dataset.currency || 'INR';
                        const loggingPrice = product.price;

                        window.initRazorpayCheckout(product.name, finalPrice, finalCurrency, loggingPrice);
                    } else {
                        alert('Payment system loading... please try again.');
                    }
                };

                // Store price on button for the handler
                buyBtn.dataset.price = product.price;
                buyBtn.dataset.currency = 'INR';

                if (window.convertPrice && window.getUserCountry) {
                    const country = await window.getUserCountry();
                    const localPrice = await window.convertPrice(product.price, country);
                    if (localPrice.currency.code !== 'INR') {
                        buyBtn.dataset.price = localPrice.amount;
                        buyBtn.dataset.currency = localPrice.currency.code;
                    }
                }

                // Show Content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('product-content').style.display = 'grid';

            } catch (err) {
                console.error(err);
                showError();
            }
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
        }
    </script>
</body>

</html>
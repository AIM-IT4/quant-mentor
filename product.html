<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | QuantMentor</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="assets/images/logo.png">

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="QuantMentor Premium Resource">
    <meta property="og:description" content="Premium digital resource for quantitative finance professionals.">
    <meta property="og:image" content="assets/images/logo.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
    <style>
        .product-page-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 120px 20px 60px;
            min-height: 80vh;
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 60px;
            align-items: start;
        }

        /* Left Column: Main Content */
        .product-main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .product-header {
            margin-bottom: 20px;
        }

        .product-title {
            font-size: 2.5rem;
            line-height: 1.2;
            margin-bottom: 16px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .product-image-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-description-container {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 30px;
        }

        .product-description-container h3 {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .product-description-text {
            color: var(--text-secondary);
            font-size: 1.05rem;
            line-height: 1.7;
            white-space: pre-line;
            /* Preserves line breaks */
        }

        /* Right Column: Sticky Checkout Card */
        .product-checkout-sidebar {
            position: sticky;
            top: 20px;
            /* Adjust based on navbar height */
        }

        .checkout-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .checkout-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .checkout-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 10px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .feature-item i {
            color: var(--accent-primary);
        }

        .btn-buy-full {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            justify-content: center;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .product-page-container {
                grid-template-columns: 1fr;
                gap: 40px;
                padding-top: 100px;
            }

            .product-checkout-sidebar {
                position: static;
                order: -1;
                /* Show checkout top on mobile? Or bottom? Topmate usually puts basic info top, but full buy bottom. Let's keep standard stack for now. */
                order: 1;
                /* Actually, content first, buy card below is often better for detail heavy stuff, OR Title top, Buy Card, Description. */
            }

            /* Let's keep Title in main content so standard flow is Title/Img/Desc -> Buy. 
               But user might want Buy button higher. 
               For now, standard column stacking. */
        }
    </style>
</head>

<body>
    <!-- Setup config for script.js to pick up -->
    <script src="config.js"></script>
    <script src="script.js"></script>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="QuantMentor" class="logo-img"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                <span class="logo-icon" style="display:none;">ðŸ“Š</span>
                <span class="logo-text">QuantMentor</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html#products">All Products</a></li>
                <li><a href="index.html#contact" class="nav-cta">Book Session</a></li>
            </ul>
        </div>
    </nav>

    <div class="product-page-container">
        <div id="loading" style="grid-column: 1 / -1; text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--accent-primary);"></i>
            <p style="margin-top: 20px; color: var(--text-muted);">Loading product details...</p>
        </div>

        <div id="error-content" style="grid-column: 1 / -1; display: none; text-align: center;">
            <h2 style="color: #ef4444; margin-bottom: 20px;">Product Not Found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">The product you are looking for does not exist
                or has been removed.</p>
            <a href="index.html" class="btn btn-primary">Return Home</a>
        </div>

        <!-- NEW 2-COLUMN LAYOUT -->
        <!-- Populated via JS -->
        <div id="left-col" class="product-main-content" style="display: none;">
            <div class="product-header">
                <h1 id="p-title" class="product-title">Product Title</h1>
            </div>

            <div class="product-image-container">
                <img id="p-image" src="" alt="Product Cover" style="display: none;">
                <div id="p-placeholder" style="font-size: 4rem; color: var(--text-muted);">
                    <i class="fas fa-file-pdf"></i>
                </div>
            </div>

            <div class="product-description-container">
                <h3>About this Resource</h3>
                <div id="p-desc" class="product-description-text">
                    Loading description...
                </div>
            </div>
        </div>

        <div id="right-col" class="product-checkout-sidebar" style="display: none;">
            <div class="checkout-card">
                <div id="p-price" class="checkout-price">â‚¹0</div>

                <div class="checkout-features">
                    <div class="feature-item"><i class="fas fa-check-circle"></i> <span>Instant Digital Download</span>
                    </div>
                    <div class="feature-item"><i class="fas fa-lock"></i> <span>Secure Payment via Razorpay</span></div>
                    <div class="feature-item"><i class="fas fa-envelope"></i> <span>Delivered to Email</span></div>
                </div>

                <!-- Coupon Section will be injected here via JS -->
                <!-- <div id="coupon-section"></div> -->

                <!-- Action Button -->
                <button id="buy-btn" class="btn btn-primary btn-buy-full">
                    <i class="fas fa-shopping-cart"></i> Buy Now
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="border-top: 1px solid var(--border-subtle); padding: 40px 0; background: var(--bg-secondary); grid-column: 1/-1;">
        <div class="nav-container" style="text-align: center;">
            <p style="color: var(--text-muted);">&copy; 2026 QuantMentor. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Get Product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let productId = urlParams.get('id');

            // Bug fix: If ID has wrapping quotes (e.g. "'123'"), strip them
            if (productId) {
                productId = productId.replace(/^['"]|['"]$/g, '');
            }

            if (!productId) {
                showError();
                return;
            }

            // Initialize Supabase
            // Note: We use the same initialization logic as script.js via global config if available
            // But since we are standalone, let's wait for script.js to init or init ourselves

            // Wait a moment for script.js to initialize Supabase
            let attempts = 0;
            const checkSupabase = setInterval(async () => {
                attempts++;
                if (window.supabaseClient) {
                    clearInterval(checkSupabase);
                    await loadProduct(productId);
                } else if (attempts > 10) {
                    // Force init if script.js fails
                    if (window.supabase && typeof window.supabase.createClient === 'function') {
                        const SUPABASE_URL = 'https://dntabmyurlrlnoajdnja.supabase.co';
                        const SUPABASE_KEY = 'sb_publishable_OhbTYIuMYgGgmKPQJ9W7RA_rhKyaad0'; // Hardcoded fallback from script.js
                        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        clearInterval(checkSupabase);
                        await loadProduct(productId);
                    } else {
                        clearInterval(checkSupabase);
                        alert('Failed to load database. Please reload.');
                    }
                }
            }, 500);
        });

        async function loadProduct(id) {
            try {
                const { data: product, error } = await window.supabaseClient
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !product) {
                    console.error('Product load error:', error);
                    showError();
                    return;
                }

                // Populate UI
                document.getElementById('p-title').textContent = product.name;

                // Description
                const descEl = document.getElementById('p-desc');
                descEl.innerHTML = product.description || 'No description available.';

                // Image
                if (product.cover_image_url) {
                    const img = document.getElementById('p-image');
                    img.src = product.cover_image_url;
                    img.style.display = 'block';
                    document.getElementById('p-placeholder').style.display = 'none';
                }

                // Price
                const priceEl = document.getElementById('p-price');
                const buyBtn = document.getElementById('buy-btn');

                // We'll reuse script.js convertPrice if available, else fallback
                let priceText = 'â‚¹' + product.price;
                if (window.convertPrice && window.getUserCountry) {
                    const country = await window.getUserCountry();
                    const localPrice = await window.convertPrice(product.price, country);
                    if (localPrice.currency.code !== 'INR') {
                        priceText = `${localPrice.currency.symbol}${localPrice.amount} ${localPrice.currency.code}`;
                    }
                }

                if (product.price === 0) {
                    priceEl.textContent = 'Free';
                    priceEl.style.color = '#22c55e';
                    buyBtn.innerHTML = '<i class="fas fa-download"></i> Download Free';
                    buyBtn.classList.replace('btn-primary', 'btn-success');
                    buyBtn.style.background = '#22c55e';
                } else {
                    priceEl.textContent = priceText;
                    buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceText}`;

                    // Add Coupon UI if price > 0
                    const couponContainer = document.createElement('div');
                    couponContainer.id = 'coupon-section';
                    couponContainer.style.marginBottom = '24px';
                    couponContainer.innerHTML = `
                        <div style="display: flex; gap: 10px; max-width: 400px;">
                            <input type="text" id="coupon-input" placeholder="Have a coupon code?" 
                                style="flex: 1; padding: 12px; border: 1px solid var(--border-light); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary);">
                            <button id="apply-coupon-btn" class="btn btn-secondary" style="padding: 12px 20px;">
                                Apply
                            </button>
                        </div>
                    `;
                    // Insert coupon before action buttons
                    // const actionButtons = document.querySelector('.action-buttons');
                    // priceEl.parentNode.insertBefore(couponContainer, actionButtons);
                    // NEW: Insert before Buy Button container or just inside the card before the button
                    buyBtn.parentNode.insertBefore(couponContainer, buyBtn);

                    // Coupon Logic
                    document.getElementById('apply-coupon-btn').addEventListener('click', async function () {
                        const codeInput = document.getElementById('coupon-input');
                        const code = codeInput.value.trim();
                        if (!code) return;

                        if (product.coupon_code && code.toLowerCase() === product.coupon_code.toLowerCase()) {
                            const discount = product.coupon_percent || 0;
                            const originalPrice = parseFloat(buyBtn.dataset.price);
                            // Calculate new price
                            const discountedPrice = Math.max(0, Math.round(originalPrice * (100 - discount) / 100));

                            // Update Display
                            let priceDisplay = '';
                            const currentCurrency = buyBtn.dataset.currency || 'INR';

                            if (currentCurrency === 'INR') {
                                priceDisplay = `â‚¹${discountedPrice}`;
                                priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">â‚¹${originalPrice}</span> ${priceDisplay}`;
                            } else {
                                priceDisplay = `${discountedPrice} ${currentCurrency}`;
                                priceEl.innerHTML = `<span style="text-decoration:line-through; color:var(--text-muted); font-size:0.8em; margin-right:10px;">${originalPrice} ${currentCurrency}</span> ${priceDisplay}`;
                            }

                            // Update Button
                            buyBtn.dataset.price = discountedPrice;
                            buyBtn.innerHTML = `<i class="fas fa-credit-card"></i> Buy Now - ${priceDisplay}`;

                            alert(`Coupon '${code}' applied! ${discount}% OFF`);

                            // Disable input
                            codeInput.disabled = true;
                            this.disabled = true;
                            this.textContent = 'Applied';
                        } else {
                            alert('Invalid coupon code for this product.');
                        }
                    });
                }

                // Set Page Title
                document.title = `${product.name} | QuantMentor`;

                buyBtn.onclick = function () {
                    if (typeof window.initRazorpayCheckout === 'function') {
                        // Calculate checkout parameters
                        let checkoutPrice = product.price;
                        let checkoutCurrency = 'INR';
                        const loggingPrice = product.price;

                        // Pass to Razorpay with simplest defaults for now (relying on script.js globals/logic if needed, but explicit args here)
                        // If we had local price, we could pass it. But for stability, let's stick to base price or re-fetch locally if needed.
                        // Actually, let's try to pass the computed local price if available.

                        if (buyBtn.dataset.price) {
                            checkoutPrice = parseFloat(buyBtn.dataset.price);
                        }
                        if (buyBtn.dataset.currency) {
                            checkoutCurrency = buyBtn.dataset.currency;
                        }

                        window.initRazorpayCheckout(product.name, checkoutPrice, checkoutCurrency, loggingPrice);
                    } else {
                        alert('Payment system loading... please try again.');
                    }
                };

                // Store price on button for the handler
                buyBtn.dataset.price = product.price;
                buyBtn.dataset.currency = 'INR';

                if (window.convertPrice && window.getUserCountry) {
                    const country = await window.getUserCountry();
                    const localPrice = await window.convertPrice(product.price, country);
                    if (localPrice.currency.code !== 'INR') {
                        buyBtn.dataset.price = localPrice.amount;
                        buyBtn.dataset.currency = localPrice.currency.code;
                    }
                }

                // Show Content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('left-col').style.display = 'flex';
                document.getElementById('right-col').style.display = 'flex';

            } catch (err) {
                console.error(err);
                showError();
            }
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
        }
    </script>
</body>

</html>